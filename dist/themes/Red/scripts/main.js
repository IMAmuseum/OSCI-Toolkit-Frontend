function loadXMLDoc(a){var b=new XMLHttpRequest;return b.overrideMimeType&&b.overrideMimeType("text/xml"),b.open("GET",a,!1),b.send(),b.responseXML}function loadHTMLDoc(a){var b=new XMLHttpRequest;b.overrideMimeType&&b.overrideMimeType("text/html"),b.open("GET",a,!1),b.send();var c=b.responseText;return c=c.replace('xmlns="http://www.w3.org/1999/xhtml"',""),c=c.replace('xmlns:epub="http://www.idpf.org/2007/ops"',"")}function xmlToJson(a,b){var c=0;if(!b)for(b=["xml:"],c=0;c<a.documentElement.attributes.length;c++)-1!=a.documentElement.attributes.item(c).nodeName.indexOf("xmlns")&&b.push(a.documentElement.attributes.item(c).nodeName.replace("xmlns:","")+":");var d=!0;if(a.attributes&&a.attributes.length>0){var e;d={};for(var f=0;f<a.attributes.length;f++)e=a.attributes.item(f),d[e.nodeName.replaceArray(b,"").toCamel()]=e.value}if(a.hasChildNodes()){var g,h,i;d===!0&&(d={});for(var j=0;j<a.childNodes.length;j++)i=a.childNodes.item(j),1===(7&i.nodeType)?(g=i.nodeName.replaceArray(b,"").toCamel(),h=xmlToJson(i,b),d.hasOwnProperty(g)?(d[g].constructor!==Array&&(d[g]=[d[g]]),d[g].push(h)):d[g]=h):3===(i.nodeType-1|1)&&(g="value",h=3===i.nodeType?i.nodeValue.replace(/^\s+|\s+$/g,""):i.nodeValue,d.hasOwnProperty(g)?d[g]+=h:(4===i.nodeType||""!==h)&&(d[g]=h))}return d}function objectToArray(a){return void 0!==a?"[object Array]"!==Object.prototype.toString.call(a)?[a]:a:void 0}function outerHTML(a){return a.outerHTML||function(a){var b,c=document.createElement("div");return c.appendChild(a.cloneNode(!0)),b=c.innerHTML,c=null,b}(a)}function liMousemove(a){if(window.liCollection&&liCollection.userIsDraggingAsset){var b=liCollection.find(liCollection.userIsDraggingAsset);if(b){if(!b.settings.dragging)return;b.refreshViewfinderViewport(),a.conservationDraggingRemove&&(b.settings.dragging=void 0,liCollection.userIsDraggingAsset=!1)}}}function liMouseup(a){window.liCollection&&liCollection.userIsDraggingAsset&&(a.conservationDraggingRemove=!0,liMousemove(a))}OsciTk={},OsciTk.collections={},OsciTk.models={},OsciTk.templates={},OsciTk.views={figureTypeRegistry:{}},OsciTk.router=Backbone.Router.extend({routes:{"":"routeToSection","section/:section_id":"routeToSection","section/:section_id/:identifier":"routeToSection"},initialize:function(a){this.on("all",this._trackPageView)},routeToSection:function(a,b){Backbone.trigger("routedToSection",{section_id:a,identifier:b})},_trackPageView:function(){var a=Backbone.history.getFragment();_.isUndefined(window._gaq)||_gaq.push(["_trackPageview","/#"+a])}}),String.prototype.replaceArray=function(a,b){for(var c=this,d=0;d<a.length;d++)c=c.replace(a[d],b);return c},String.prototype.toCamel=function(){return this.replace(/\s(.)/g,function(a){return a.toUpperCase()}).replace(/\s/g,"").replace(/^(.)/,function(a){return a.toLowerCase()})};var $=jQuery,LICollection=function(){var a=[];this.add=function(b){var c,d;for(c=0,d=a.length;d>c;c++)if(a[c].id==b.id)return!1;return a.push(b),!0},this.remove=function(b){var c,d;for("string"==typeof b&&(b={id:b}),c=0,d=a.length;d>c;c++)a[c].id==b.id&&a.splice(c,1)},this.find=function(b){var c,d;for(c=0,d=a.length;d>c;c++)if(a[c].id==b)return a[c];return!1},this.list=function(){return a},this.userIsDraggingAsset=!1},LayeredImage=function(a){var b,c,d;if(void 0===jQuery)return!1;var e=this.$=jQuery;if(void 0===org||void 0===org.polymaps)return!1;if(this.polymaps=org.polymaps,this.container=e(a),this.container.length<1)return!1;if(window.liCollection.add(this)){this.id=this.container.attr("id"),this.settings=this.container.data(),this.settings.zoomStep=this.settings.zoomStep||.1,this.settings.annotationSelectorVisible=!1,this.settings.dragging=void 0;var f=this.container.parents("figure:first"),g=f.attr("data-options");f.length>0&&g&&(this.figureOptions=JSON.parse(g)),("undefined"==typeof this.figureOptions||"object"!=typeof this.figureOptions)&&(this.figureOptions={}),"undefined"==typeof this.figureOptions.disable_interaction&&(this.figureOptions.disable_interaction=!1),"undefined"==typeof this.figureOptions.disable_annotation&&(this.figureOptions.disable_annotation=!1),"undefined"==typeof this.figureOptions.sliderPosition&&(this.figureOptions.sliderPosition=0),this.settings.captionMarkup=this.container.parents("figure:first").find("figcaption").clone(),this.settings.originalMarkup=outerHTML(this.container[0]),this.layers=[];var h=this.container.find(".layered_image-layers"),i=h.find("li"),j=[];for(b=0,c=i.length;c>b;b++){var k=e(i[b]),d=k.data();d.annotation?j.push(d):this.layers.push(d)}j.length&&(this.layers=this.layers.concat(j)),h.remove(),this.map=this.polymaps.map();var l=this.polymaps.svg("svg");for(e(l).css({height:"100%",width:"100%"}),this.map.container(this.container[0].appendChild(l)),this.map.tileSize({x:256,y:256}),this.baseLayers=[],this.annotationLayers=[],this.max_zoom_level=0,this.max_width=0,this.max_height=0,b=0,c=this.layers.length;c>b;b++)d=this.layers[b],d.layer_num=b+1,d.zoom_levels||(d.zoom_levels=this.getZoomLevels(d.width,d.height)),d.annotation?this.annotationLayers.push(d):this.baseLayers.push(d),"iip"===d.type&&(d.zoom_levels=d.zoom_levels-1),d.width>this.max_width&&(this.max_width=d.width),d.height>this.max_height&&(this.max_height=d.height),d.zoom_levels>this.max_zoom_level&&(this.max_zoom_level=d.zoom_levels);var m=this.figureOptions.baseLayerPreset?this.figureOptions.baseLayerPreset:[],n=m.length,o=!1;if(n>0){var p,q=this.getLayerById(m[0]);n>1&&(p=this.getLayerById(m[1])),q&&(p||1==n)&&(this.createLayer(q),p&&(this.createLayer(p),e("#"+p.id).css("opacity",0)),o=!0)}!o&&this.baseLayers.length&&(this.createLayer(this.baseLayers[0]),this.baseLayers[1]&&(this.createLayer(this.baseLayers[1]),e("#"+this.baseLayers[1].id).css("opacity",0))),this.createUI(),this.showAnnotationPresets(),this.zoomToContainer();var r=[];this.figureOptions.fullscreenExtents?(r=[{lon:this.figureOptions.fullscreenExtents.swLon,lat:this.figureOptions.fullscreenExtents.swLat},{lon:this.figureOptions.fullscreenExtents.neLon,lat:this.figureOptions.fullscreenExtents.neLat}],this.setExtents(r)):this.figureOptions.swLat&&(r=[{lon:this.figureOptions.swLon,lat:this.figureOptions.swLat},{lon:this.figureOptions.neLon,lat:this.figureOptions.neLat}],this.setExtents(r))}};LayeredImage.prototype.createLayer=function(a){var b;this.$;void 0!==a&&("image"==a.type&&(b=this.createLayerImage(a)),"iip"==a.type&&(b=this.createLayerIIP(a)),"svg"==a.type&&(b=this.createLayerSVG(a)),a.visible=!0,a.polymapLayer=b,b.id(a.id),this.map.add(b))},LayeredImage.prototype.removeLayer=function(a){a.polymapLayer&&this.map.remove(a.polymapLayer),a.polymapLayer=void 0,a.visible=!1},LayeredImage.prototype.toggleLayer=function(a){a.visible?this.removeLayer(a):this.createLayer(a)},LayeredImage.prototype.repaintLayer=function(a){this.removeLayer(a),this.createLayer(a)},LayeredImage.prototype.createLayerIIP=function(a){var b=this,c=this.polymaps.image(),d=function(c){var d=a.ptiff_server,e=a.ptiff_path,f=a.height,g=a.width,h=256,i=b.getScale(a.zoom_levels,c.zoom),j=Math.round(g/i),k=Math.round(f/i),l=Math.ceil(j/h),m=Math.ceil(k/h);if(c.row<0||c.row>=m||c.column<0||c.column>=l)return null;c.row==m-1&&c.element.setAttribute("height",k%h),c.column==l-1&&c.element.setAttribute("width",j%h);var n=d+"?fif="+e+"&jtl="+c.zoom+","+(c.row*l+c.column);return n};return c.url(d),c},LayeredImage.prototype.createLayerImage=function(a){var b=this,c=function(c){var d=b.getScale(b.max_zoom_level,c.zoom);c.element=b.polymaps.svg("image"),c.element.setAttribute("preserveAspectRatio","none"),c.element.setAttribute("x",0),c.element.setAttribute("y",0),c.element.setAttribute("width",b.max_width/d),c.element.setAttribute("height",b.max_height/d),c.element.setAttributeNS("http://www.w3.org/1999/xlink","href",a.image_path),c.ready=!0},d=function(a){a.request&&a.request.abort(!0)},e=this.polymaps.layer(c,d).tile(!1);return e},LayeredImage.prototype.createLayerSVG=function(a){var b=this,c=function(c){var d=b.getScale(b.max_zoom_level,c.zoom);c.element=b.polymaps.svg("image"),c.element.setAttribute("preserveAspectRatio","none"),c.element.setAttribute("x",0),c.element.setAttribute("y",0),c.element.setAttribute("width",b.max_width/d),c.element.setAttribute("height",b.max_height/d),c.element.setAttributeNS("http://www.w3.org/1999/xlink","href",a.svg_path),c.ready=!0},d=function(a){a.request&&a.request.abort(!0)},e=this.polymaps.layer(c,d).tile(!1);return e},LayeredImage.prototype.zoomToContainer=function(){var a,b,c=0,d=0;for(a=0,b=this.layers.length;b>a;a++){var e=this.layers[a],f=this.getScale(this.max_zoom_level,e.zoom_levels),g=Math.round(e.width/f),h=Math.round(e.height/f),i=g/this.map.tileSize().x,j=h/this.map.tileSize().y;e.tiles_wide=i,e.tiles_high=j,e.tiles_zoom=e.zoom_level,d=j>d?j:d,c=i>c?i:c}this.settings.containerFitSW=this.map.coordinateLocation({zoom:this.max_zoom_level,column:0,row:d}),this.settings.containerFitNE=this.map.coordinateLocation({zoom:this.max_zoom_level,column:c,row:0}),this.map.extent([this.settings.containerFitSW,this.settings.containerFitNE]),this.settings.containerFitZoomLevel=this.map.zoom(),this.resetZoomRange(this.settings.containerFitZoomLevel)},LayeredImage.prototype.createUI=function(){var a,b=this.$,c=this;(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&(this.map.add(this.polymaps.drag()).add(this.polymaps.wheel()).add(this.polymaps.dblclick()).add(this.polymaps.touch()),b(this.container).bind({mousewheel:function(a){c.ui.zoomSlider.slider("value",c.map.zoom()),c.refreshViewfinderViewport()},DOMMouseScroll:function(a){c.ui.zoomSlider.slider("value",c.map.zoom()),c.refreshViewfinderViewport()},dblclick:function(a){c.ui.zoomSlider.slider("value",c.map.zoom()),c.refreshViewfinderViewport()},mousedown:function(a){c.settings.dragging={x:a.clientX,y:a.clientY},liCollection.userIsDraggingAsset=c.id}})),this.ui={},this.ui.legendItemsCount=0,this.ui.controlbar=b('<div class="ca-ui-controlbar"></div>'),a=this.settings.collapsed?"collapsed":"expanded",this.ui.fullscreen=b('<div class="ca-ui-fullscreen '+a+'"></div>').bind("click",function(){c.settings.collapsed?c.fullscreen():(window.liCollection.remove(c),b(".ca-ui-fullscreen-modal").remove(),window.scrollOffset&&window.scrollTo(window.scrollOffset[0],window.scrollOffset[1]))}).appendTo(this.ui.controlbar),this.ui.reset=b('<div class="ca-ui-reset"></div>').bind("click",function(a){c.reset()}),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.reset.appendTo(this.ui.controlbar),this.annotationLayers.length>0&&(this.ui.annotation=b('<div class="ca-ui-annotation"></div>').bind("click",function(a){c.toggleAnnotationSelector()}),(!this.figureOptions.disable_annotation||this.figureOptions.editing)&&this.ui.annotation.appendTo(this.ui.controlbar));var d=this.getVisibleBaseLayers();this.settings.currentLayer1=d[0],d.length>1&&(this.settings.currentLayer2=d[1],this.ui.layerSelector=b('<div class="ca-ui-layer-selector"></div>'),this.ui.layerSelector.bind("click",{layeredImage:this},this.toggleLayerSelector),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.controlbar.append(this.ui.layerSelector),this.ui.sliderContainer=b('<div class="ca-ui-layer-slider-container"></div>'),this.ui.sliderLayerText1=b('<div class="ca-ui-layer-slider-layer-text1">1</div>').attr("title",this.settings.currentLayer1.title).appendTo(this.ui.sliderContainer).qtip(),this.ui.slider=b('<div class="ca-ui-layer-slider"></div>').slider({slide:function(a,d){var e=d.value/100;b("#"+c.settings.currentLayer2.id).css("opacity",e),c.refreshViewfinderOpacity(e)},change:function(a,d){var e=d.value/100;b("#"+c.settings.currentLayer2.id).css("opacity",e),c.refreshViewfinderOpacity(e)}}).appendTo(this.ui.sliderContainer),this.ui.sliderLayerText2=b('<div class="ca-ui-layer-slider-layer-text2">2</div>').attr("title",this.settings.currentLayer2.title).appendTo(this.ui.sliderContainer).qtip(),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&(this.ui.sliderContainer.appendTo(this.ui.controlbar),this.ui.layerSelector.after(this.ui.sliderContainer)),void 0!==this.figureOptions.sliderPosition&&this.ui.slider.slider("value",this.figureOptions.sliderPosition)),this.ui.controlbar.appendTo(this.container),this.resizeControlBar(),this.ui.zoom=b('<div class="ca-ui-zoom"></div>'),this.ui.zoomIn=b('<div class="ca-ui-zoom-in"></div>').bind("click",function(a){var b=c.ui.zoomSlider.slider("value"),d=b+c.settings.zoomStep;c.ui.zoomSlider.slider("value",d),c.map.zoom(d)}).appendTo(this.ui.zoom),this.ui.zoomSlider=b('<div class="ca-ui-zoom-slider"></div>').slider({step:this.settings.zoomStep,orientation:"vertical",slide:function(a,b){var d=b.value,e=c.map.zoom();d!=e&&c.map.zoom(d)}}).appendTo(this.ui.zoom),this.ui.zoomOut=b('<div class="ca-ui-zoom-out"></div>').bind("click",function(a){var b=c.ui.zoomSlider.slider("value"),d=b-c.settings.zoomStep;c.ui.zoomSlider.slider("value",d),c.map.zoom(d)}).appendTo(this.ui.zoom),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.zoom.appendTo(this.container),this.resizeZoomControls(),this.ui.viewfinder=b('<div class="ca-ui-viewfinder viewfinder-closed"></div>'),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.viewfinder.appendTo(this.container),this.ui.viewfinder.bind("click",function(a){c.ui.viewfinder.hasClass("viewfinder-open")?(c.ui.viewfinder.empty().css("height",""),c.ui.viewfinder.removeClass("viewfinder-open").addClass("viewfinder-closed"),c.ui.viewfinderViewport=null):(c.ui.viewfinder.removeClass("viewfinder-closed").addClass("viewfinder-open"),c.refreshViewfinder())}),this.ui.controls=[this.ui.controlbar,this.ui.zoom,this.ui.viewfinder,this.ui.currentPopup,this.ui.annotation,this.ui.layerSelector],this.container.bind("mousemove mousewheel DOMMouseScroll",function(a){var b=c.container,d=new Date;b.attr("data-controls-time",d.getTime());var e=b.attr("data-controls")||"false";if("false"==e){for(var f=window.liCollection.list(),g=0,h=f.length;h>g;g++){var i=f[g];"true"==i.container.attr("data-controls")&&(i.container.attr("data-controls","false"),i.toggleControls())}b.attr("data-controls","true"),c.toggleControls()}c.ui.controlsTimeout=setTimeout(function(){var a=new Date;"true"==b.attr("data-controls")&&a.getTime()-b.attr("data-controls-time")>=1750&&"true"!=b.attr("data-controls-lock")&&(b.attr("data-controls","false"),c.clearPopups(),c.toggleControls())},2e3)}),b.each(this.ui.controls,function(){"function"==typeof this.bind&&(this.bind("mouseenter",function(){c.container.attr("data-controls-lock","true")}),this.bind("mouseleave",function(){c.container.attr("data-controls-lock","false")}))})},LayeredImage.prototype.reset=function(){var a,b,c=this.$,d=this;if(d.clearPopups(),"undefined"==typeof d.figureOptions.swLat||d.figureOptions.editing)d.zoomToContainer();else{var e=[{lon:d.figureOptions.swLon,lat:d.figureOptions.swLat},{lon:d.figureOptions.neLon,lat:d.figureOptions.neLat}];d.map.extent(e)}d.ui.zoomSlider.slider("value",d.map.zoom()),void 0!==d.figureOptions.sliderPosition&&d.ui.slider&&d.ui.slider.slider("value",d.figureOptions.sliderPosition);var f;if(d.figureOptions.baseLayerPreset)for(f=[],a=0,b=d.figureOptions.baseLayerPreset.length;b>a;a++)f.push(d.getLayerById(d.figureOptions.baseLayerPreset[a]));else f=d.baseLayers;for(a=0,b=f.length;b>a&&2>a;a++)currentLayer=d.settings["currentLayer"+(a+1)],d.toggleLayer(currentLayer),d.toggleLayer(f[a]),d.settings["currentLayer"+(a+1)]=f[a],d.ui["layerSelector"+(a+1)]&&d.ui["layerSelector"+(a+1)].find("span").html(f[a].title),d.ui["sliderLayerText"+(a+1)]&&d.ui["sliderLayerText"+(a+1)].attr("title",d.settings["currentLayer"+(a+1)].title);f.length>1&&d.ui.slider&&(c("#"+d.settings.currentLayer2.id).css("opacity",d.ui.slider.slider("value")/100),d.ui.viewfinderLayer2&&d.ui.viewfinderLayer2.css("opacity",d.ui.slider.slider("value")/100)),d.showAnnotationPresets()},LayeredImage.prototype.refreshViewfinder=function(){var a=this.$;this.ui.viewfinder.empty();var b=this.settings.currentLayer1.thumb;if(this.ui.viewfinderLayer1=a('<div class="ca-ui-viewfinderLayer viewfinderLayer1"></div>'),a("<img />").attr("src",b).appendTo(this.ui.viewfinderLayer1),this.ui.viewfinder.append(this.ui.viewfinderLayer1),this.settings.currentLayer2){var c=this.settings.currentLayer2.thumb;this.ui.viewfinderLayer2=a('<div class="ca-ui-viewfinderLayer viewfinderLayer2"></div>'),a("<img />").attr("src",c).appendTo(this.ui.viewfinderLayer2),this.ui.viewfinder.append(this.ui.viewfinderLayer2),this.ui.viewfinderLayer2.css("opacity",this.ui.slider.slider("value")/100)}var d=this.ui.viewfinder.width(),e=Math.floor(d/this.settings.aspect);this.ui.viewfinder.height(e),void 0!==this.ui.viewfinderViewport&&this.ui.viewfinderViewport.remove(),this.ui.viewfinderViewport=void 0,this.refreshViewfinderViewport()},LayeredImage.prototype.refreshViewfinderViewport=function(){if(this.ui.viewfinder.hasClass("viewfinder-open")){var a=this.$,b=this.ui.viewfinder.width(),c=Math.floor(b/this.settings.aspect);this.ui.viewfinderViewport||(this.ui.viewfinderViewport=a('<div class="ca-ui-viewfinder-viewport">&nbsp;</div>').appendTo(this.ui.viewfinder),void 0===this.settings.viewPortBorderWidth&&(this.settings.viewPortBorderWidth=parseInt(this.ui.viewfinderViewport.css("border-left-width"),10)));var d=this.map.locationPoint(this.settings.containerFitSW),e=this.map.locationPoint(this.settings.containerFitNE),f=-1*d.x/(e.x-d.x)*b-this.settings.viewPortBorderWidth,g=-1*e.y/(d.y-e.y)*c-this.settings.viewPortBorderWidth,h=this.map.size().x/(e.x-d.x),i=this.map.size().y/(d.y-e.y),j=h*b,k=i*c;this.ui.viewfinderViewport.css({top:g+"px",left:f+"px",width:j+"px",height:k+"px"})}},LayeredImage.prototype.refreshViewfinderOpacity=function(a){this.ui.viewfinderLayer2&&this.ui.viewfinderLayer2.css("opacity",a)},LayeredImage.prototype.fullscreen=function(a){var b=this.$,c=this,d=b('<div class="ca-ui-fullscreen-modal"></div>').appendTo(document.body);d.bind("click",function(a){b(a.target).hasClass("ca-ui-fullscreen-modal")&&b(this).find(".ca-ui-fullscreen").trigger("click")});var e=b('<div class="ca-ui-fullscreen-wrap"></div>').appendTo(d),f=d.offset(),g=d.height()-f.top,h=d.outerWidth()-f.left,i=0,j=0,k=!0,l=.9,m=void 0!==(c.figureOptions&&c.figureOptions.aspect)?c.figureOptions.aspect:c.settings.aspect;if(1>=m)for(;j>h||k;)i=Math.floor(g*l),j=Math.floor(i*m),l-=.1,k=!1;else for(;i>g||k;)j=Math.floor(h*l),i=Math.floor(j/m),l-=.1,k=!1;e.css({height:i+"px",top:Math.floor((g-i)/2)+"px",width:j+"px",left:Math.floor((h-j)/2)+"px"});var n=b(this.settings.originalMarkup);n.attr("id",n.attr("id")+"-fullscreen"),n.attr("data-collapsed","false"),n.find("li").each(function(){var a=b(this);a.data("id",a.data("id")+"-fullscreen"),a.data("parent_asset",a.data("parent_asset")+"-fullscreen")});var o=this.map.extent();1!==this.map.zoom()&&(this.figureOptions.fullscreenExtents={swLon:o[0].lon,swLat:o[0].lat,neLon:o[1].lon,neLat:o[1].lat});var p=b("<figure></figure>").attr("data-options",JSON.stringify(this.figureOptions)).css({height:i+"px",width:j+"px"}).appendTo(e),q=0;this.settings.captionMarkup&&(p.append(this.settings.captionMarkup),q=this.settings.captionMarkup.outerHeight(!0)),b("<div>",{"class":"figureContent",css:{height:Math.round(i)-q+"px",width:j+"px"}}).append(n).prependTo(p);var r=new LayeredImage(n);a&&r.reset()},LayeredImage.prototype.resizeControlBar=function(){var a=this.container.outerWidth(),b=this.ui.controlbar.children(),c=0;b.each(function(){c+=$(this).outerWidth()});var d=a-2*parseInt(this.ui.controlbar.css("right"),10);c>d&&(this.ui.controlbar.css({"max-width":d+"px"}),b.each(function(){var a=$(this);d-=a.outerWidth(),0>d&&(a.width(a.width()+d),a.find(".ca-ui-layer-slider").each(function(){$(this).width($(this).width()+d)}))}))},LayeredImage.prototype.resizeZoomControls=function(){var a=this.container.outerHeight(),b=this.ui.zoom.children(),c=0;b.each(function(){c+=$(this).outerHeight()});var d=a-this.ui.controlbar.outerHeight()-1;if(c>d)if(this.ui.zoom.css({"max-height":d+"px"}),d-=this.ui.zoomIn.outerHeight()+this.ui.zoomOut.outerHeight(),50>d)this.ui.zoomSlider.hide(),this.ui.zoom.css({"max-height":this.ui.zoomIn.outerHeight()+this.ui.zoomOut.outerHeight()+"px"});else{var e=this.ui.zoomSlider.outerHeight(!0)-this.ui.zoomSlider.outerHeight();this.ui.zoomSlider.height(d-e+"px")}},LayeredImage.prototype.toggleLayerSelector=function(a){var b=jQuery,c=a.data.layeredImage,d=b(this);c.settings.currentLayer1,c.settings.currentLayer2;if(c.ui.currentPopup&&c.ui.currentPopup==c.ui.layerSelectorPopup)c.clearPopups();else{c.clearPopups(),d.addClass("active"),rows=b('<div class="ca-ui-layer-selector-rows"></div>');for(var e=0;e<c.baseLayers.length;e++){var f=c.baseLayers[e];rowLayerButton1=b('<div class="ca-ui-layer-selector-row-button1"><div class="ca-ui-layer-selector-button"></div></div>').attr("data-layer_index",e),rowTitle=b('<div class="ca-ui-layer-selector-row-title"><span>'+f.title+"</span></div>"),rowLayerButton2=b('<div class="ca-ui-layer-selector-row-button2"><div class="ca-ui-layer-selector-button"></div></div>').attr("data-layer_index",e),f==c.settings.currentLayer1&&rowLayerButton1.find(".ca-ui-layer-selector-button").first().addClass("active"),f==c.settings.currentLayer2&&rowLayerButton2.find(".ca-ui-layer-selector-button").first().addClass("active"),rowLayerButton1.bind("click",{CA:c,layerNum:1},c.layerSelect),rowLayerButton2.bind("click",{CA:c,layerNum:2},c.layerSelect),row=b('<div class="ca-ui-layer-selector-row"></div>').append(rowLayerButton1).append(rowTitle).append(rowLayerButton2),rows.append(row)}var g=parseInt(c.ui.controlbar.css("bottom"),10)+c.ui.controlbar.height(),h=c.ui.controlbar.position().left,i=(c.ui.sliderContainer.outerWidth()+d.outerWidth(),{bottom:g+"px",left:h+"px"});c.ui.layerSelectorPopup=b('<div class="ca-ui-layer-selector-popup"></div>').css(i).bind("mouseenter",function(){c.container.attr("data-controls-lock","true")}).bind("mouseleave",function(){c.container.attr("data-controls-lock","false")}).append(rows).appendTo(c.container),c.ui.currentPopup=c.ui.layerSelectorPopup}},LayeredImage.prototype.toggleAnnotationSelector=function(){var a=this.$,b=this;if(this.ui.currentPopup&&this.ui.currentPopup==this.ui.annotationSelector)this.clearPopups();else{this.clearPopups(),this.ui.annotation.addClass("active");var c=this.ui.annotation.offsetParent().position(),d=this.ui.annotation.position(),e=this.ui.annotation.outerWidth(),f=this.ui.annotation.offsetParent().parent().width(),g=this.ui.annotation.offsetParent().parent().height(),h=f-c.left-d.left-e,i=g-c.top-d.top;this.settings.annotationSelectorVisible=!0,this.ui.annotationSelector=a('<div class="ca-ui-annotation-selector"></div>').css({right:h,bottom:i}),a('<div class="title">Annotations</div>').appendTo(this.ui.annotationSelector),this.ui.annotationSelectorList=a('<ul class="ca-ui-annotation-selector-list"></ul>');for(var j=0,k=this.annotationLayers.length;k>j;j++){var l=this.annotationLayers[j],m=a("<li></li>").bind("click",{layerData:l,CA:b},b.annotationLayerClick),n=a('<div class="ca-ui-annotation-selector-item-box"></div>').addClass(l.visible?"filled":"empty");l.visible&&l.annotation&&n.css("background-color","#"+l.color),m.append(n).append("<span>"+l.title+"</span>").appendTo(this.ui.annotationSelectorList)}this.ui.annotationSelector.bind("mouseenter",function(){b.container.attr("data-controls-lock","true")}).bind("mouseleave",function(){b.container.attr("data-controls-lock","false")}).append(this.ui.annotationSelectorList).appendTo(this.container),this.ui.currentPopup=this.ui.annotationSelector}},LayeredImage.prototype.annotationLayerClick=function(a){var b=a.data.layerData,c=a.data.CA;c.toggleLayer(b);var d=$(this).find(".ca-ui-annotation-selector-item-box");if(b.visible){if(d.removeClass("empty").addClass("filled"),b.annotation&&"svg"==b.type){var e=b.color||"#fff";d.css("background-color","#"+e),c.addLegendItem(b)}}else d.removeClass("filled").addClass("empty"),b.annotation&&"svg"==b.type&&(d.css("background-color",""),c.removeLegendItem(b))},LayeredImage.prototype.resetZoomRange=function(a){a=a||0;for(var b=0,c=0,d=this.layers.length;d>c;c++)"iip"==this.layers[c].type?this.layers[c].zoom_levels-1>b&&(b=this.layers[c].zoom_levels-1):this.layers[c].zoom_levels>b&&(b=this.layers[c].zoom_levels);this.map.zoomRange([a,b]),this.ui.zoomSlider.slider("option","min",a),this.ui.zoomSlider.slider("option","max",b)},LayeredImage.prototype.getZoomLevels=function(a,b){for(var c=this.map.tileSize().x,d=1;a>c||b>c;)d++,a/=2,b/=2;return d},LayeredImage.prototype.getScale=function(a,b){return Math.pow(2,a-b)},LayeredImage.prototype.realignLayers=function(){var a,b,c=this.$,d=this.container.find("svg.map"),e=d.find("g.layer").remove();for(a=0,b=e.length;b>a;a++)c(e[a]).attr("id")==this.settings.currentLayer1.id&&(d.append(e[a]),e.splice(a,1));for(a=0,b=e.length;b>a;a++)c(e[a]).attr("id")==this.settings.currentLayer2.id&&(d.append(e[a]),e.splice(a,1));d.append(e)},LayeredImage.prototype.clearPopups=function(){this.ui.currentPopup&&(this.ui.currentPopup.fadeOut(400,function(){$(this).remove()}),this.ui.currentPopup=!1),this.ui.controls&&$.each(this.ui.controls,function(){$(this).removeClass("active")})},LayeredImage.prototype.toggleControls=function(a){a=a||400;var b=this.$;b.each(this.ui.controls,function(){this!=window&&this.fadeToggle(a)})},LayeredImage.prototype.addLegendItem=function(a){var b=this.$;if(a.color&&""!==a.color){this.ui.legend||(this.ui.legend=b('<div class="ca-ui-legend"><ul class="legendList"></ul></div>').appendTo(this.container),"true"!=this.container.attr("data-controls")&&this.ui.legend.css("display","none"),this.ui.controls.push(this.ui.legend));var c=this.ui.legend.find("ul"),d=b('<li data-layer_num="'+a.layer_num+'">'+a.title+"</li>").appendTo(c);b('<div class="item-box"></div>').css("background-color","#"+a.color).prependTo(d);this.ui.legendItemsCount++}},LayeredImage.prototype.removeLegendItem=function(a){var b=this.$,c=this;if(this.ui.legend){var d=this.ui.legend.find("ul").children();if(d.each(function(){b(this).attr("data-layer_num")==a.layer_num&&(b(this).remove(),c.ui.legendItemsCount--)}),this.ui.legendItemsCount<=0){this.ui.legend.remove(),delete this.ui.legend;for(var e=0,f=this.ui.controls.length;f>e;e++)b(this.ui.controls[e]).hasClass("ca-ui-legend")&&this.ui.controls.splice(e,1)}}},LayeredImage.prototype.showAnnotationPresets=function(){for(var a=0,b=this.annotationLayers.length;b>a;a++)if(this.removeLayer(this.annotationLayers[a]),this.removeLegendItem(this.annotationLayers[a]),this.figureOptions.annotationPreset)for(var c=0,d=this.figureOptions.annotationPreset.length;d>c;c++){var e=this.figureOptions.annotationPreset[c];if(this.annotationLayers[a].layer_id==e){this.repaintLayer(this.annotationLayers[a]),(!this.figureOptions.disable_annotation||this.figureOptions.editing)&&this.addLegendItem(this.annotationLayers[a]);break}}},LayeredImage.prototype.getVisibleBaseLayers=function(){var a,b,c=[];for(a=0,b=this.baseLayers.length;b>a;a++){var d=this.baseLayers[a];d.visible&&c.push(d)}return c},LayeredImage.prototype.getVisibleBaseLayerIds=function(){var a,b,c=[];for(a=0,b=this.baseLayers.length;b>a;a++){var d=this.baseLayers[a];d.visible&&c.push(d.layer_id)}return c},LayeredImage.prototype.getVisibleAnnotationIds=function(){var a,b,c=[];for(a=0,b=this.annotationLayers.length;b>a;a++){var d=this.annotationLayers[a];d.visible&&c.push(d.layer_id)}return c},LayeredImage.prototype.getExtents=function(){var a=this.map.extent();return{swLon:a[0].lon,swLat:a[0].lat,neLon:a[1].lon,neLat:a[1].lat}},LayeredImage.prototype.setExtents=function(a){this.map.extent(a),this.ui.zoomSlider&&this.ui.zoomSlider.slider("value",this.map.zoom())},LayeredImage.prototype.getSliderPosition=function(){return"undefined"!=typeof this.ui.slider?this.ui.slider.slider("value"):0},LayeredImage.prototype.getLayerById=function(a){for(var b=0,c=this.layers.length;c>b;b++)if(this.layers[b].layer_id&&this.layers[b].layer_id==a)return this.layers[b];return!1},LayeredImage.prototype.layerSelect=function(a){var b=a.data.CA,c=a.data.layerNum,d=parseInt($(this).attr("data-layer_index"),10),e=$(this).find(".ca-ui-layer-selector-button");if(!e.hasClass("active")){var f=1==c?2:1,g=b.ui.layerSelectorPopup.find(".ca-ui-layer-selector-row-button"+f+'[data-layer_index="'+d+'"] .ca-ui-layer-selector-button');if(!g.hasClass("active")){if(b.removeLayer(b.settings["currentLayer"+c]),b.createLayer(b.baseLayers[d]),b.settings["currentLayer"+c]=b.baseLayers[d],2==c){var h=b.ui.slider.slider("value"),i=h/100;$("#"+b.settings.currentLayer2.id).css("opacity",i)}b.ui.layerSelectorPopup.find(".ca-ui-layer-selector-row-button"+c+" .ca-ui-layer-selector-button").removeClass("active"),e.addClass("active"),b.ui.sliderLayerText1.attr("title",b.settings.currentLayer1.title),b.ui.sliderLayerText2.attr("title",b.settings.currentLayer2.title),b.realignLayers(),b.refreshViewfinder()}}},window.liCollection=new LICollection,window.addEventListener("mousemove",liMousemove,!1),window.addEventListener("mouseup",liMouseup,!1),$.fn.findNearest=function(a){var b,c,d,e,f,g=null,h=a.left,i=a.top;return this.each(function(){if(b=$(this).offset(),h>=b.left&&h<=b.right&&i>=b.top&&i<=b.bottom)return g=$(this),!1;var a=[[b.left,b.top],[b.right,b.top],[b.left,b.bottom],[b.right,b.bottom]];for(off in a)d=a[off][0]-h,e=a[off][1]-i,c=Math.sqrt(d*d+e*e),(void 0===f||f>c)&&(f=c,g=$(this))}),g},OsciTk.templateManager={get:function(a){return function(b){return OsciTk.templateManager.useTemplate(a,b)}},useTemplate:function(a,b){if(void 0===OsciTk.templates[a])for(var c=app.config.get("templateUrls"),d=!1,e=c.length,f=0;e>f&&($.ajax({async:!1,dataType:"html",url:c[f]+a+".tpl.html",success:function(b,c,e){OsciTk.templates[a]=_.template(b),d=!0}}),!d);f++);return OsciTk.templates[a](b)}},OsciTk.models.BaseModel=Backbone.Model.extend(),OsciTk.models.Config=OsciTk.models.BaseModel.extend({}),OsciTk.models.Package=OsciTk.models.BaseModel.extend({defaults:function(){return{url:null,lang:null,spine:null,manifest:null,metadata:null,id:null,version:null,xmlns:null}},initialize:function(){var a=xmlToJson(loadXMLDoc(this.get("url")));this.set("lang",a["package"].lang),this.set("spine",a["package"].spine),this.set("manifest",a["package"].manifest),this.set("metadata",a["package"].metadata);var b=a["package"].metadata["dc:identifier"];_.isArray(b)||(b=[b]);for(var c=b.length,d=0;c>d;d++){var e=b[d];if(e.value.indexOf("urn:osci_tk_identifier:")!==!1){this.set("id",e.value.substr(23));break}}this.set("version",a["package"].version),this.set("xmlns",a["package"].xmlns),Backbone.trigger("packageLoaded",this)},sync:function(a,b,c){},getTitle:function(){var a,b=this.get("metadata");return b["dc:title"]&&b["dc:title"].value&&(a=b["dc:title"].value),a},getPubId:function(){var a,b=this.get("metadata");if(!_.isUndefined(b["dc:identifier"]))if(_.isArray(b["dc:identifier"])){var c=_.find(b["dc:identifier"],function(a){return"publication-id"===a.id?!0:!1});c&&(a=c.value.split(":"))}else a=b["dc:identifier"].value.split(":");return a[2]}}),OsciTk.models.Figure=OsciTk.models.BaseModel.extend({defaults:function(){return{section_id:null,delta:null,caption:null,position:null,columns:null,aspect:0,body:null,options:{},plate:!1}},initialize:function(){this.parsePositionData(),this.set("content",$.trim(this.get("content")))},parsePositionData:function(){var a,b=this.get("position");return("plate"===b||"platefull"===b)&&(this.set("plate",!0),"plate"===b?b="p":"platefull"===b&&(b="ff")),a=2==b.length?{vertical:b[0],horizontal:b[1]}:"n"===b||"p"===b?{vertical:b,horizontal:b}:{vertical:b,horizontal:"na"},this.set("position",a),this}}),OsciTk.models.Footnote=OsciTk.models.BaseModel.extend({defaults:function(){return{body:"",section_id:"",delta:""}},sync:function(a,b,c){}}),OsciTk.models.NavigationItem=OsciTk.models.BaseModel.extend({defaults:function(){return{title:null,subtitle:null,uri:null,parent:null,next:null,previous:null,depth:0,
thumbnail:null,timestamp:null}}}),OsciTk.models.Note=OsciTk.models.BaseModel.extend({defaults:function(){return{id:null,content_id:null,section_id:null,note:null,tags:[],paragraph_number:null}},initialize:function(a,b){this.on("error",function(a,b){throw new Error("an error has occured")})},sync:function(a,b,c){var d=app.config.get("endpoints").OsciTkNote;switch(a){case"create":c.data=b.toJSON(),delete c.data.id,c.success=function(a,d,e){var f=JSON.parse(a);f.success?(b.set("id",f.note.id),b.trigger("change")):c.error(b,e)},c.type="POST",$.ajax(d,c);break;case"update":c.data=b.toJSON(),c.success=function(a,d,e){var f=JSON.parse(a);f.success?b.trigger("change"):c.error(b,e)},c.type="POST",$.ajax(d,c);break;case"delete":c.data=b.toJSON(),c.data["delete"]=1,c.type="POST",c.success=function(a,d,e){var f=JSON.parse(a);f.success?b.trigger("change"):c.error(b,e)},$.ajax(d,c)}}}),OsciTk.models.SearchResult=OsciTk.models.BaseModel.extend({get:function(a){if(!this.attributes[a])return this.attributes[a];var b=this.attributes[a];switch(a){case"bundle":return"footnote"===b||"note"===b||"figure"===b?b:"content";case"url":break;case"teaser":var c=this.attributes[a],d=document.createElement("DIV");return d.innerHTML=c,d.textContent||tmpinnerText||"";default:return this.attributes[a]}}}),OsciTk.models.Account=OsciTk.models.BaseModel.extend({defaults:{username:"anonymous",email:null,id:0},initialize:function(){this.getSessionState()},sync:function(a,b,c){},getSessionState:function(){var a=this;$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"status"},type:"POST",dataType:"json",success:function(b){b.success===!0&&a.set(b.user)}}).done(function(){Backbone.trigger("accountReady")})}}),OsciTk.models.Page=OsciTk.models.BaseModel.extend({defaults:function(){return{content:{},pageNumber:0}},addContent:function(a){var b=this.get("content"),c=$(a[0]).data("osci_content_id");return void 0===c&&(c=$(a[0]).attr("id")),void 0===c?(c="content",void 0===b[c]?b[c]=a.html():b[c]=b[c]+a.html()):b[c]=a[0],this},removeContentAt:function(a){var b=this.get("content");return delete b[a],this},removeAllContent:function(){this.set("content",{})},contentLength:function(){return this.get("content").length},getContent:function(a){return this.get("content")[a]}}),OsciTk.models.Section=OsciTk.models.BaseModel.extend({defaults:function(){return{title:null,content:null,uri:null,media_type:"application/xhtml+xml",contentLoaded:!1,pages:null}},initialize:function(){pages=new OsciTk.collections.Pages},loadContent:function(){var a=null;if(this.get("contentLoaded")===!1){var b=loadHTMLDoc(this.get("uri")),c=[],d=/body([^>]*)class=(["']+)([^"']*)(["']+)/gi.exec(b.substring(b.indexOf("<body"),b.indexOf("</body>")+7));_.isArray(d)&&!_.isUndefined(d[3])&&(c=d[3].split(" ")),a=$("<div />").html(b),this.set("title",a.find("title").html()),this.set("content",a),this.set("contentLoaded",!0),this.set("classes",c)}null===a&&(a=$(this.get("content")));var e=a.find("section#footnotes"),f=a.find("figure");Backbone.trigger("footnotesAvailable",e),Backbone.trigger("figuresAvailable",f),Backbone.trigger("sectionLoaded",this)},removeAllPages:function(){this.set("pages",new OsciTk.collections.Pages)}}),OsciTk.models.GlossaryTerm=OsciTk.models.BaseModel.extend({defaults:function(){return{term:"",definition:""}}}),OsciTk.collections.BaseCollection=Backbone.Collection.extend(),OsciTk.collections.Figures=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Figure,initialize:function(){this.listenTo(Backbone,"figuresAvailable",function(a){this.populateFromMarkup(a),Backbone.trigger("figuresLoaded",this)})},comparator:function(a){return a.get("delta")},populateFromMarkup:function(a){var b=[];_.each(a,function(a){var c=a.id.match(/\w+-(\d+)-(\d+)/),d=$(a),e={id:a.id,rawData:a,body:a.innerHTML,section_id:c[1],delta:c[2],title:d.attr("title"),caption:d.find("figcaption").html(),content:d.find(".figure_content").html(),position:d.data("position"),columns:d.data("columns"),options:d.data("options"),thumbnail_url:void 0,type:d.data("figure_type"),aspect:d.data("aspect"),order:d.data("order"),count:d.data("count")};if(e.options.previewUri)e.thumbnail_url=e.options.previewUri,e.preview_url=e.options.previewUri;else{var f=d.children("img.thumbnail").remove();if(f.length)e.thumbnail_url=f.attr("src"),e.preview_url=f.attr("src");else{var g=$(".figure_content img",a);g.length&&(e.thumbnail_url=g.attr("src"),e.preview_url=g.attr("src"))}}b.push(e)},this),this.reset(b)}}),OsciTk.collections.NavigationItems=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.NavigationItem,currentNavigationItem:null,initialize:function(){this.listenTo(Backbone,"packageLoaded",function(a){var b=_.find(a.get("manifest").item,function(a){return"nav"==a.properties});if(b){for(var c=xmlToJson(loadXMLDoc(b.href)),d=c.html.body.nav,e=0,f=d.length;f>e;e++)if("toc"==d[e].type){var g=d[e].ol;this.parseChildren(g,null,0);break}Backbone.trigger("navigationLoaded",this)}})},parseChildren:function(a,b,c){_.isArray(a)===!1&&(a=[a]);for(var d=0,e=a.length;e>d;d++){var f=a[d];if(f.a){var g={id:f.a["data-section_id"],parent:b,depth:c,previous:this.at(this.length-1)||null,next:null,length:f.a["data-length"]||null,title:f.a.value,subtitle:f.a["data-subtitle"],thumbnail:f.a["data-thumbnail"],timestamp:f.a["data-timestamp"],uri:f.a.href};this.add(g);var h=this.at(this.length-1);if(null!==h.get("previous")&&h.get("previous").set("next",h),f.ol&&f.ol.li){var i;i=f.ol.li.length?f.ol.li:[f.ol.li];for(var j=c+1,k=0,l=i.length;l>k;k++)this.parseChildren(i[k],h,j)}}f.li&&this.parseChildren(f.li,b,c)}}}),OsciTk.collections.Footnotes=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Footnote,initialize:function(){this.listenTo(Backbone,"footnotesAvailable",function(a){this.populateFromMarkup(a),Backbone.trigger("footnotesLoaded",this)})},populateFromMarkup:function(a){this.reset();for(var b=a.find("aside"),c=b.length,d=[],e=0;c>e;e++){var f=b[e],g=f.id.match(/\w+-(\d+)-(\d+)/);d.push({id:f.id,rawData:f,body:f.innerHTML,section_id:g[1],delta:g[2],index:f.getAttribute("data-footnote_index")})}this.reset(d)}}),OsciTk.collections.Notes=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Note,initialize:function(){this.listenTo(Backbone,"currentNavigationItemChanged",function(a){a.id&&this.getNotesForSection(a.id)})},parse:function(a){return a.success?a.notes:!1},getNotesForSection:function(a){$.ajax({url:app.config.get("endpoints").OsciTkNote,data:{section_id:a},type:"GET",dataType:"json",success:function(a){a.success===!0&&(app.collections.notes.reset(a.notes),Backbone.trigger("notesLoaded",app.collections.notes))}})}}),OsciTk.collections.Pages=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Page}),OsciTk.collections.SearchResults=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.SearchResult}),OsciTk.collections.GlossaryTerms=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.GlossaryTerm,initialize:function(){this.listenTo(Backbone,"packageLoaded",this.parseGlossary)},parseGlossary:function(a){var b=_.find(a.get("manifest").item,function(a){return"glossary"===a.id});if(b){var c=loadXMLDoc(b.href);if(null===c)return;var d=$(c).find("dd"),e=$(c).find("dt");if(d.length>0&&e.length>0)for(var f=0,g=e.length;g>f;f++){var h={id:$(e[f]).attr("data-tid"),term:$(e[f]).find("dfn:first").html(),definition:this.html_entity_decode($(d[f]).html())};this.add(h)}}Backbone.trigger("osci.glossary.loaded",this)},filterByKeyword:function(a){var b=new RegExp("\\b"+a,"gi");return _.filter(this.models,function(a){return-1!==a.get("term").search(b)})},get_html_translation_table:function(a,b){var c,d={},e={},f={},g={},h={},i={};if(f[0]="HTML_SPECIALCHARS",f[1]="HTML_ENTITIES",g[0]="ENT_NOQUOTES",g[2]="ENT_COMPAT",g[3]="ENT_QUOTES",h=isNaN(a)?a?a.toUpperCase():"HTML_SPECIALCHARS":f[a],i=isNaN(b)?b?b.toUpperCase():"ENT_COMPAT":g[b],"HTML_SPECIALCHARS"!==h&&"HTML_ENTITIES"!==h)throw new Error("Table: "+h+" not supported");d[38]="&amp;","HTML_ENTITIES"===h&&(d[160]="&nbsp;",d[161]="&iexcl;",d[162]="&cent;",d[163]="&pound;",d[164]="&curren;",d[165]="&yen;",d[166]="&brvbar;",d[167]="&sect;",d[168]="&uml;",d[169]="&copy;",d[170]="&ordf;",d[171]="&laquo;",d[172]="&not;",d[173]="&shy;",d[174]="&reg;",d[175]="&macr;",d[176]="&deg;",d[177]="&plusmn;",d[178]="&sup2;",d[179]="&sup3;",d[180]="&acute;",d[181]="&micro;",d[182]="&para;",d[183]="&middot;",d[184]="&cedil;",d[185]="&sup1;",d[186]="&ordm;",d[187]="&raquo;",d[188]="&frac14;",d[189]="&frac12;",d[190]="&frac34;",d[191]="&iquest;",d[192]="&Agrave;",d[193]="&Aacute;",d[194]="&Acirc;",d[195]="&Atilde;",d[196]="&Auml;",d[197]="&Aring;",d[198]="&AElig;",d[199]="&Ccedil;",d[200]="&Egrave;",d[201]="&Eacute;",d[202]="&Ecirc;",d[203]="&Euml;",d[204]="&Igrave;",d[205]="&Iacute;",d[206]="&Icirc;",d[207]="&Iuml;",d[208]="&ETH;",d[209]="&Ntilde;",d[210]="&Ograve;",d[211]="&Oacute;",d[212]="&Ocirc;",d[213]="&Otilde;",d[214]="&Ouml;",d[215]="&times;",d[216]="&Oslash;",d[217]="&Ugrave;",d[218]="&Uacute;",d[219]="&Ucirc;",d[220]="&Uuml;",d[221]="&Yacute;",d[222]="&THORN;",d[223]="&szlig;",d[224]="&agrave;",d[225]="&aacute;",d[226]="&acirc;",d[227]="&atilde;",d[228]="&auml;",d[229]="&aring;",d[230]="&aelig;",d[231]="&ccedil;",d[232]="&egrave;",d[233]="&eacute;",d[234]="&ecirc;",d[235]="&euml;",d[236]="&igrave;",d[237]="&iacute;",d[238]="&icirc;",d[239]="&iuml;",d[240]="&eth;",d[241]="&ntilde;",d[242]="&ograve;",d[243]="&oacute;",d[244]="&ocirc;",d[245]="&otilde;",d[246]="&ouml;",d[247]="&divide;",d[248]="&oslash;",d[249]="&ugrave;",d[250]="&uacute;",d[251]="&ucirc;",d[252]="&uuml;",d[253]="&yacute;",d[254]="&thorn;",d[255]="&yuml;"),"ENT_NOQUOTES"!==i&&(d[34]="&quot;"),"ENT_QUOTES"===i&&(d[39]="&#39;"),d[60]="&lt;",d[62]="&gt;";for(c in d)d.hasOwnProperty(c)&&(e[String.fromCharCode(c)]=d[c]);return e},html_entity_decode:function(a,b){var c={},d="",e="",f="";if(e=a.toString(),!1===(c=this.get_html_translation_table("HTML_ENTITIES",b)))return!1;delete c["&"],c["&"]="&amp;";for(d in c)f=c[d],e=e.split(f).join(d);return e=e.split("&#039;").join("'")}}),OsciTk.views.BaseView=Backbone.View.extend({getChildViews:function(){return this.childViews||(this.childViews=[]),this.childViews},addView:function(a,b){return a.parent=this,"undefined"==typeof b?this.$el.append(a.el):this.$el.find(b).append(a.el),this._addViewReference(a),this},removeAllChildViews:function(){if(this.childViews){for(var a=0,b=this.childViews.length;b>a;a++)this.childViews[a].close();this.childViews=[]}return this},removeView:function(a,b){if(this.childViews)for(var c=0,d=this.childViews.length;d>c;c++)if(a.cid===this.childViews[c].cid){this.childViews.splice(c,1),a.$el.detach(),(b||void 0===b)&&a.close();break}return this},getChildViewById:function(a){var b;if(this.childViews)for(var c=0,d=this.childViews.length;d>c;c++)if(a===this.childViews[c].cid){b=this.childViews[c];break}return b},getChildViewByIndex:function(a){var b;return this.childViews&&this.childViews[a]&&(b=this.childViews[a]),b},getChildViewsByType:function(a){return _.filter(this.childViews,function(b){return b.$el.is(a)})},replaceView:function(a,b){return a.parent=this,"undefined"==typeof b?this.$el.html(a.el):this.$el.find(b).html(a.el),this._addViewReference(a),this},changeModel:function(a){return this.model=a,this},close:function(){this.removeAllChildViews(),this.remove(),this.unbind(),this.undelegateEvents(),this.onClose&&this.onClose()},_addViewReference:function(a){this.childViews||(this.childViews=[]);for(var b=!1,c=0,d=this.childViews.length;d>c;c++)if(a.cid===this.childViews[c].cid){b=!0;break}b||this.childViews.push(a)}}),OsciTk.views.App=OsciTk.views.BaseView.extend({id:"reader",template:OsciTk.templateManager.get("app"),initialize:function(){this.render(),app.toolbarItems=app.config.get("toolbarItems")?app.config.get("toolbarItems"):[],app.views={headerView:new OsciTk.views.Header,sectionView:new OsciTk.views.Section,footnotesView:new OsciTk.views.Footnotes,paragraphControlsView:new OsciTk.views.ParagraphControls,navigationView:new OsciTk.views.Navigation,navbarView:new OsciTk.views.Navbar,fontSizeView:new OsciTk.views.FontSize,toolbarView:new OsciTk.views.Toolbar,tocToolbarView:new OsciTk.views.TocToolbar,searchToolbarView:new OsciTk.views.SearchToolbar,glossaryToolbarView:new OsciTk.views.GlossaryToolbar,footnotesToolbarView:new OsciTk.views.FootnotesToolbar,figuresToolbarView:new OsciTk.views.FiguresToolbar,notesToolbarView:new OsciTk.views.NotesToolbar,citationsToolbarView:new OsciTk.views.CitationsToolbar,accountToolbarView:new OsciTk.views.AccountToolbar},this.addView(app.views.headerView,"#header"),this.addView(app.views.toolbarView,"#toolbar"),this.addView(app.views.navbarView,"#navbar"),this.addView(app.views.sectionView,"#section"),this.addView(app.views.navigationView,"#navigation"),this.listenTo(Backbone,"toolbarInline",function(a){this.toolbarInline(a)}),this.listenTo(Backbone,"toolbarItemClicked",function(a){this.toolbarAction(a)}),this.listenTo(Backbone,"toolbarRemoveViews",function(){this.toolbarToggle()})},render:function(){this.$el.html(this.template),$("body").append(this.el)},toolbarInline:function(a){var b=_.pick(app.views,a.view);b=b[a.view],this.removeView(b,!1),this.addView(b,"#"+a.text)},toolbarAction:function(a){if(this.toolbarToggle(),a.active){var b=_.pick(app.views,a.item.view);b=b[a.item.view],this.addView(b,"#"+a.item.text),$("#"+a.item.text).show()}},toolbarToggle:function(){_.each(app.toolbarItems,function(a){if("default"==a.style){var b=_.pick(app.views,a.view);b=b[a.view],this.removeView(b,!1),$("#"+a.text).hide()}},this)}}),OsciTk.views.Header=OsciTk.views.BaseView.extend({className:"header-view",events:{"click #header-menu-button":"menuClick","click #header-login-button":"loginClick"},template:OsciTk.templateManager.get("header"),initialize:function(){this.sectionId=null,this.pubTitle=null,this.sectionTitle=null,this.sectionSubtitle=null,this.username=null,this.listenTo(Backbone,"packageLoaded",function(a){this.pubTitle=a.getTitle()}),this.listenTo(Backbone,"sectionLoaded",function(a){this.sectionId=a.get("id"),this.render()}),this.listenTo(Backbone,"accountReady accountStateChanged",function(){app.account.get("id")>0?this.username=app.account.get("username"):this.username=null,this.render()})},render:function(){var a=this;return _.each(app.collections.navigationItems.models,function(b){b.get("id")==a.sectionId&&(a.sectionTitle=b.get("title"),a.sectionSubtitle=b.get("subtitle"))}),this.$el.html(this.template({username:this.username,pubTitle:this.pubTitle,sectionTitle:this.sectionTitle,sectionSubtitle:this.sectionSubtitle})),this},menuClick:function(){Backbone.trigger("menuClicked")},loginClick:function(){Backbone.trigger("loginClicked")}}),OsciTk.views.Section=OsciTk.views.BaseView.extend({id:"default-section-view",template:OsciTk.templateManager.get("section"),events:{"click .content-paragraph":"paragraphClicked","click .paragraph-button":"paragraphButtonClicked","click #note-submit":"noteSubmit","click #cite":"getCitation"},initialize:function(a){return this.listenTo(Backbone,"currentNavigationItemChanged",function(a){$("html, body").animate({scrollTop:0},0),$("#section-view").empty(),$(".header-view").empty(),$("#loader").show(),a&&(app.models.section=new OsciTk.models.Section({uri:a.get("uri"),id:a.get("id")}),this.ContentId=a.get("id"),this.changeModel(app.models.section),app.models.section.loadContent()),$("#loader").hide()}),this.listenTo(Backbone,"windowResized",function(){this.renderColumns()}),this.listenTo(Backbone,"sectionLoaded",function(a){this.content=a.get("content")[0].children.body,this.makeIds(a),this.sectionId=a.get("id"),this.getSectionTitles(this.sectionId),this.render()}),!0},renderColumns:function(){Backbone.trigger("columnRenderStart");var a=40;$("#default-section-view").css({"-webkit-column-gap":a,"-moz-column-gap":a,"column-gap":a});var b=$("#section").attr("data-columns-setting");b="undefined"==typeof b?2:parseInt(b),$(window).width()<768&&(b=1),$("#section").attr("data-columns-rendered",b),$("#default-section-view").css({"-webkit-column-width":"auto","-moz-column-width":"auto","column-width":"auto","-webkit-column-count":"auto","-moz-column-count":"auto","column-count":"auto",width:"auto"});var c=$("#section").width(),d=c/b-a/2;$("#default-section-view").css({"-webkit-column-width":d,"-moz-column-width":d,"column-width":d});var e=$("#section").height();$("figure").each(function(a,b){var c=$(b);c.css("max-height",e);var d=c.find("figcaption"),f=d.outerHeight();c.find(".figure_content").css("height",e-f),c.css("max-width","none");var g=c.find("img").outerWidth();d.css("max-width",g),c.css("max-width",g);var h=c.find("object").attr("data");void 0!==h&&$.ajax({url:h,type:"GET",dataType:"html",success:function(a){var b=$(a).filter(".layered_image-asset").first(),d=c.find(".figure_content");d.empty(),b.appendTo(d),new window.LayeredImage(b)}})});var f=0,g=b;do $("#default-section-view").css({"-webkit-column-count":g.toString(),"-moz-column-count":g.toString(),"column-count":g.toString()}),$("#default-section-view").width(g*d+(g-1)*a),f=$("#default-section-view").height(),g+=1;while(f>$("#section").height());Backbone.trigger("columnRenderEnd")},getSectionTitles:function(a){var b=this;_.each(app.collections.navigationItems.models,function(c){c.get("id")==a&&(b.sectionTitle=c.get("title"),b.sectionSubtitle=c.get("subtitle"),b.sectionThumbnail=c.get("thumbnail"))},this)},render:function(){return this.model.removeAllPages(),this.removeAllChildViews(),this.$el.html(this.template({sectionTitle:this.sectionTitle,sectionSubtitle:this.sectionSubtitle,sectionThumbnail:this.sectionThumbnail,content:$(this.content).html()})),Backbone.trigger("layoutComplete"),$("img").load(function(){Backbone.trigger("windowResized")}),this},onClose:function(){this.model.removeAllPages()},makeIds:function(a){var b=$(this.content.children).filter("p");_.each(b,function(a,b){var c=b+1;$(a).attr({"data-paragraph_number":c,"data-osci_content_id":"osci-content-"+c,"data-sectionid":"body",id:"osci-content-"+c}).addClass("content-paragraph")},this)},paragraphClicked:function(a){if(null!=app.account.get("email")){var b=$(a.currentTarget).data("paragraph_number");Backbone.trigger("paragraphClicked",b)}},paragraphButtonClicked:function(a){if(null!=app.account.get("email")){var b=$(a.currentTarget).data("paragraph_number");Backbone.trigger("paragraphButtonClicked",b)}},isElementVisible:function(a){return!0},noteSubmit:function(a){var b=$(a.currentTarget).parent().find("textarea"),c=b.val(),d=b.data("id"),e=b.data("paragraph_number"),f=app.collections.notes.get(d);f.set("note",c),""!==$.trim(c)?(f.save(),b.html(c),$("#paragraph-"+e).addClass("withNotes")):(f.destroy(),$("#paragraph-"+e).removeClass("withNotes")),$("#paragraph-"+e).popover({content:function(){return $("#popover-content").html()}}),$("#paragraph-"+e).popover("destroy")}}),OsciTk.views.ParagraphControls=OsciTk.views.BaseView.extend({template:OsciTk.templateManager.get("paragraph-popover"),templateNotes:OsciTk.templateManager.get("note-form"),templateCites:OsciTk.templateManager.get("citation"),initialize:function(){this.notesLoaded=!1,this.userLogged=!1,this.sectionId=null,this.listenTo(Backbone,"layoutComplete",function(){this.sectionId=app.models.section.get("id")}),this.listenTo(Backbone,"notesLoaded",function(a){this.notesLoaded=!0,this.render()}),this.listenTo(Backbone,"sectionLoaded",function(){this.sectionLoaded=!0,this.render()}),this.userLogged=app.account.get("id")>0,this.listenTo(Backbone,"accountReady accountStateChanged",function(){this.userLogged=app.account.get("id")>0,this.render()}),this.listenTo(Backbone,"paragraphButtonClicked",function(a){this.togglePopover(a),this.getCitation(a)}),this.listenTo(Backbone,"navigate",function(){$('[id^="paragraph-"]').popover("destroy")})},render:function(){if(this.userLogged&&this.sectionLoaded&&!this.notesLoaded){var a=app.models.section.id;app.collections.notes.getNotesForSection(a)}return this.userLogged&&this.notesLoaded?(this.paragraphs=$(".content-paragraph"),this.addParagraphControls()):($('[id^="paragraph-"]').popover("destroy"),$(".paragraph-controls").remove()),this},addParagraphControls:function(){var a=1;_.each(this.paragraphs,function(b){$('.paragraph-controls[data-osci_content_id="osci-content-'+a+'"]').remove();var c=this.checkForNote({content_id:"osci-content-"+a,section_id:this.sectionId,paragraph_number:a}),d=c.get("note")?"withNotes":"";$(b).prepend('<div class="paragraph-controls hidden-print" data-osci_content_id="osci-content-'+a+'" data-paragraph_identifier="'+a+'" ><button class="btn btn-link '+d+' btn-xs paragraph-button" type="button" id="paragraph-'+a+'" data-paragraph_number="'+a+'"><span class="paragraph-identifier" paragraph-identifier="'+a+'">'+a+"</span></button></div>"),a++},this)},togglePopover:function(a){this.data=a;var b=this.checkForNote({content_id:"osci-content-"+a,section_id:this.sectionId,paragraph_number:a}),c=({id:a,cid:b.cid,noteText:c,sectionId:this.sectionId,contentId:"osci-content-"+a,paragraph_number:a},b?b.get("note"):"");c=null===c?"":c;var d=this.templateNotes({paragraph_number:b.get("paragraph_number"),note:c,cid:b.cid}),e=this.template({noteForm:d,citation:this.citation});$("#paragraph-"+a).popover({html:!0,trigger:"manual",placement:"right",content:e}),$("#paragraph-"+a).on("shown.bs.popover",function(){$("#"+$(this).attr("aria-describedby")).find("textarea").focus()}),$("#paragraph-"+a).popover("toggle");var f=1;_.each(this.paragraphs,function(a){this.data!=f&&$("#paragraph-"+f).popover("destroy"),f++},this)},checkForNote:function(a){var b,c=app.collections.notes.where({content_id:a.content_id});return c[0]?(b=c[0],""===b.get("note")&&b.destroy()):(b=new OsciTk.models.Note({content_id:a.content_id,section_id:a.section_id,paragraph_number:a.paragraph_number}),app.collections.notes.add(b)),b},getCitation:function(a){var b=this,c="osci-content-"+a,d=$("#"+c),e={section_id:app.models.section.get("id"),publication_id:app.models.docPackage.get("id"),element_id:c,field:"body"};$.ajax({url:app.config.get("endpoints").OsciTkCitation,data:e,success:function(a,c){a.success&&(a.citation.referenceText=d.text(),a.citation.url=document.URL+"/p-"+app.models.section.get("id")+"-"+d.data("paragraph_number"),a.citation.paragraphNumber=d.data("paragraph_number"),a.citation.date=new Date(a.citation.date),a.citation.formattedDate=a.citation.date.getMonth()+1+"/"+a.citation.date.getDate()+"/"+a.citation.date.getFullYear(),a.citation.creator=a.citation.creator?a.citation.creator:"",a.citation.description=a.citation.description?a.citation.description:"",a.citation.editor=a.citation.editor?a.citation.editor:"",a.citation.publicationTitle=a.citation.publicationTitle?a.citation.publicationTitle:"",a.citation.publisher=a.citation.publisher?a.citation.publisher:"",a.citation.rights=a.citation.rights?a.citation.rights:"",a.citation.title=a.citation.title?a.citation.title:"",$("#cite").html(b.templateCites(a.citation)))}})}}),OsciTk.views.Footnotes=OsciTk.views.BaseView.extend({id:"footnote-view",initialize:function(){this.listenTo(Backbone,"layoutComplete",function(a){for(var b=app.views.sectionView.$el.find("a.footnote-reference"),c=0;c<b.length;c++){var d=$(b[c]),e=d.attr("href").slice(1),f=app.collections.footnotes.get(e),g=$(f.get("body")).text();d.attr("title",g),d.attr("data-toggle","tooltip"),d.attr("data-placement","bottom"),d.off("click"),d.bind("click",{caller:this},this.footnoteClicked)}$('[data-toggle="tooltip"]').tooltip()})},footnoteClicked:function(a){a.preventDefault(),a.stopPropagation()}}),OsciTk.views.Navigation=OsciTk.views.BaseView.extend({id:"navigation-view",template:OsciTk.templateManager.get("navigation"),initialize:function(){this.currentNavigationItem=null,this.numPages=null,this.page=null,this.listenTo(Backbone,"layoutComplete",function(a){this.render()}),this.listenTo(Backbone,"windowResized",function(a){this.calculatePages(),this.render()}),this.listenTo(Backbone,"routedToSection",function(a){var b=!0;if(a.section_id)null===this.getCurrentNavigationItem()?this.setCurrentNavigationItem(a.section_id):a.section_id!==this.getCurrentNavigationItem().get("id")?this.setCurrentNavigationItem(a.section_id):b=!1;else{var c=app.collections.navigationItems.at(0).id;app.router.navigate("section/"+c,{trigger:!1}),this.setCurrentNavigationItem(c)}void 0!==typeof a.identifier&&(b?this.listenToOnce(Backbone,"columnRenderEnd",function(){Backbone.trigger("navigate",{identifier:a.identifier})}):Backbone.trigger("navigate",{identifier:a.identifier})),this.setDocumentTitle()});var a=this;$(document).keydown(function(b){var c=b.target.nodeName.toLowerCase();if("input"!==c&&"textarea"!==c){b.preventDefault();var d=0;switch(b.which){case 39:d=a.page+1;break;case 37:d=a.page-1}d&&Backbone.trigger("navigate",{page:d})}}),this.listenTo(Backbone,"columnRenderStart",function(){var a=$("#default-section-view").offset(),b=$("#default-section-view>*").findNearest({left:a.left+$("#section").scrollLeft()+1,top:a.top+1});$("#section").attr("data-columns-element",b.index())}),this.listenTo(Backbone,"columnRenderEnd",function(){var a=$("#section").attr("data-columns-element"),b="#default-section-view>*:eq("+a+")";Backbone.trigger("navigate",{identifier:b})}),this.listenTo(Backbone,"navigate",function(a){var b=this.page?this.page:1;if(a.page&&(b=a.page),a.identifier)switch(a.identifier){case"end":b=this.numPages;break;case"start":b=1;break;default:if(a.identifier.search(/^p-[0-9]+/)>-1){var c=a.identifier.slice(a.identifier.lastIndexOf("-")+1,a.identifier.length);b=this.getPageForSelector("p[data-paragraph_number="+c+"]");break}if(a.identifier.search(/^fig-[0-9]+-[0-9]+$/)>-1){var d=a.identifier;b=this.getPageForSelector("#"+d);break}b=this.getPageForSelector(a.identifier)}b||(b=this.page,app.router.navigate("section/"+this.getCurrentNavigationItem().get("id"),{trigger:!1}));var e=$("#section"),f=e.outerWidth();1==e.attr("data-columns-rendered")?f-=10:f+=10,e.scrollLeft(f*(b-1)),this.calculatePages(),this.update(this.page)})},getPageForSelector:function(a){var b=$(a);if(b.length<1)return!1;var c=b.offset().left-$("#default-section-view").offset().left;return Math.floor(c/($("#section").outerWidth()+10))+1},calculatePages:function(){this.numPages=Math.ceil($("#default-section-view").width()/($("#section").outerWidth()+10)),this.page=Math.ceil($("#section").scrollLeft()/($("#section").outerWidth()+10))+1,Backbone.trigger("pagesCalculated",this.numPages,this.page)},render:function(){this.$el.html(this.template({numPages:this.numPages,chapter:this.currentNavigationItem.get("title")})),this.update(this.page)},update:function(a){if(this.$el.find(".prev-page").unbind("click"),this.$el.find(".next-page").unbind("click"),1==a)$(".prev-page",this.$el).addClass("inactive").unbind("click");else if(this.numPages>1){this.$el.find(".prev-page").removeClass("inactive").click(function(){Backbone.trigger("navigate",{page:a-1})})}a==this.numPages?this.$el.find(".next-page").addClass("inactive").unbind("click"):this.numPages>1&&this.$el.find(".next-page").removeClass("inactive").click(function(){Backbone.trigger("navigate",{page:a+1})})},setDocumentTitle:function(){var a=app.models.docPackage.getTitle();a=a?a+" | ":"",a+=this.getCurrentNavigationItem().get("title"),document.title=a},getCurrentNavigationItem:function(){return this.currentNavigationItem},setCurrentNavigationItem:function(a){var b=app.collections.navigationItems.get(a);b?this.currentNavigationItem=app.collections.navigationItems.get(a):this.currentNavigationItem=app.collections.navigationItems.first(),$("#section").attr("data-columns-element",0).scrollLeft(0),Backbone.trigger("currentNavigationItemChanged",this.currentNavigationItem)}}),OsciTk.views.Navbar=OsciTk.views.BaseView.extend({className:"navbar-view",template:OsciTk.templateManager.get("navbar"),events:{"click li a":"itemClick"},initialize:function(){this.numPages=null,this.curPage=null,this.listenTo(Backbone,"currentNavigationItemChanged",function(){this.render()}),this.listenTo(Backbone,"windowResized",function(){this.render()}),this.listenTo(Backbone,"pagesCalculated",function(a,b){this.numPages=a,this.curPage=b,this.render()})},render:function(){this.$el.html(this.template({numPages:this.numPages,curPage:this.curPage}));var a=new OsciTk.views.ToolbarItem({toolbarItem:{view:"fontSizeView",text:"font-size",style:"inline"}});return this.addView(a,"#font-size-area"),a.render(),$("#osci-page-slider").on("change",function(){Backbone.trigger("navigate",{page:this.value})}),$("#osci-spread-single").click(function(){Backbone.trigger("setSectionColumns",1)}),$("#osci-spread-double").click(function(){Backbone.trigger("setSectionColumns",2)}),this},itemClick:function(a){a.preventDefault()}}),OsciTk.views.FontSize=OsciTk.views.BaseView.extend({className:"font-size-view",template:OsciTk.templateManager.get("font-size"),initialize:function(){this.currentFontSize=100,this.listenTo(Backbone,"toolbarInlineClicked",function(a){this.changeFontSize(a)}),this.render()},render:function(){return this.$el.html(this.template()),this},changeFontSize:function(a){var b=app.views.sectionView;"font-larger"===a&&this.currentFontSize<"200"&&(this.currentFontSize+=10),"font-smaller"===a&&this.currentFontSize>"50"&&(this.currentFontSize-=10),b.$el.css({"font-size":this.currentFontSize+"%"}),Backbone.trigger("windowResized")}}),OsciTk.views.Toolbar=OsciTk.views.BaseView.extend({id:"toolbar-view",template:OsciTk.templateManager.get("toolbar"),events:{"click .close-toolbar-item":"closeToolbar"},initialize:function(){this.listenTo(Backbone,"figuresAvailable",function(a){this.figureSize=a.size(),this.render()}),this.listenTo(Backbone,"menuClicked",function(a){this.$el.parent().toggle("slide",{direction:"right"},350)}),this.listenTo(Backbone,"loginClicked",function(a){this.$el.parent().show("slide",{direction:"right"},350),$(".accountToolbarView-toolbar-item").click()}),this.listenTo(Backbone,"toolbarItemClicked",function(a){a.active?($("#toolbar-filler").hide(),$("#toolbar-readout").show()):($("#toolbar-filler").show(),$("#toolbar-readout").hide())})},render:function(){this.$el.html(this.template({})),_.each(app.toolbarItems,function(a){if("figures"!=a.text||0!=this.figureSize){var b=new OsciTk.views.ToolbarItem({toolbarItem:a});this.addView(b,"#toolbar-area"),b.render()}},this)},closeToolbar:function(a){this.$el.parent().hide("slide",{direction:"right"},350)}}),OsciTk.views.ToolbarItem=OsciTk.views.BaseView.extend({tagName:"li",className:"toolbar-item-view",template:OsciTk.templateManager.get("toolbar-item"),events:{click:"itemClicked",touch:"itemClicked"},initialize:function(a){this.options=a,this.$el.addClass(this.options.toolbarItem.view+"-toolbar-item"),this.$el.attr("data-href",this.options.toolbarItem.text),this.$el.attr("data-style",this.options.toolbarItem.style)},render:function(){return this.$el.html(this.template({text:this.options.toolbarItem.text,style:this.options.toolbarItem.style})),"default"!=this.options.toolbarItem.style&&Backbone.trigger("toolbarInline",this.options.toolbarItem),this},itemClicked:function(a){a.preventDefault(),a.stopPropagation(),this.$target=$(a.target),this.$target.addClass("active"),this.setActiveStates(a)},setActiveStates:function(a){this.view=app.views.toolbarView,this.active=this.$target.hasClass("active"),"default"!=this.$target.data("style")&&Backbone.trigger("toolbarInlineClicked",this.$target.data("href")),this.$targetCheck=$(a.currentTarget),_.each(app.toolbarItems,function(a){0==this.$targetCheck.hasClass(a.view+"-toolbar-item")&&this.view.$el.find("li."+a.view+"-toolbar-item").removeClass("active")},this),Backbone.trigger("toolbarItemClicked",{item:this.options.toolbarItem,active:this.active})}}),OsciTk.views.TocToolbar=OsciTk.views.BaseView.extend({className:"toolbar-toc-view",template:OsciTk.templateManager.get("toolbar-toc"),events:{"click li a":"itemClick"},initialize:function(){this.listenTo(Backbone,"currentNavigationItemChanged",function(){
this.render()})},render:function(){return this.$el.html(this.template({items:app.collections.navigationItems.where({depth:0})})),this},itemClick:function(a){a.preventDefault();var b=$(a.currentTarget).attr("data-section-id");$("li.tocView-toolbar-item").removeClass("active"),Backbone.trigger("toolbarRemoveViews"),app.router.navigate("section/"+b,{trigger:!0}),app.views.toolbarView.$el.find("li.tocToolbarView-toolbar-item").click()}}),OsciTk.views.SearchToolbar=OsciTk.views.BaseView.extend({className:"toolbar-search-view",template:OsciTk.templateManager.get("toolbar-search"),events:{},initialize:function(){this.listenTo(Backbone,"layoutComplete",function(a){this.render()},this)},render:function(){return this.$el.html(this.template({})),this}}),OsciTk.views.GlossaryToolbar=OsciTk.views.BaseView.extend({className:"toolbar-glossary-view",template:OsciTk.templateManager.get("toolbar-glossary"),events:{"keyup #glossary-filter":"filterTerms","click #glossary-filter-clear":"clearFilter","click #glossary-term-listing li":"selectTerm","click #glossary-term-listing-mobile li":"expandTerm"},initialize:function(){this.listenTo(Backbone,"layoutComplete",function(a){this.render()},this)},render:function(){var a=this;return this.$el.html(this.template({hasResults:!_.isEmpty(app.collections.glossaryTerms.models)})),_.each(app.collections.glossaryTerms.models,function(b){var c=OsciTk.templateManager.get("toolbar-glossary-term");a.$el.find("#glossary-term-listing").append(c({item:b}));var d=OsciTk.templateManager.get("toolbar-glossary-term-mobile");a.$el.find("#glossary-term-listing-mobile").append(d({item:b}))}),this},filterTerms:function(){var a=this,b=$("#glossary-filter").val();b.length?$("#glossary-filter-clear").show():$("#glossary-filter-clear").hide();var c;c=_.isEmpty(b)?app.collections.glossaryTerms.models:app.collections.glossaryTerms.filterByKeyword(b),$("#glossary-term-listing").empty(),$("#glossary-term-listing-mobile").empty(),_.each(c,function(b){var c=OsciTk.templateManager.get("toolbar-glossary-term");a.$el.find("#glossary-term-listing").append(c({item:b}));var d=OsciTk.templateManager.get("toolbar-glossary-term-mobile");a.$el.find("#glossary-term-listing-mobile").append(d({item:b}))})},clearFilter:function(){$("#glossary-filter").val(""),this.filterTerms()},selectTerm:function(a){var b=$(a.target).data("tid"),c=app.collections.glossaryTerms.get(b);this.$el.find("h4").html(c.get("term")),this.$el.find("p").html(c.get("definition"))},expandTerm:function(a){$(a.target).removeClass("active-term"),$(a.target).find("ul").is(":visible")?$(a.target).find("ul").hide():(this.$el.find("#glossary-term-listing-mobile ul").hide(),$(a.target).find("ul").show(),$(a.target).addClass("active-term"))}}),OsciTk.views.FootnotesToolbar=OsciTk.views.BaseView.extend({className:"toolbar-footnotes-view",template:OsciTk.templateManager.get("toolbar-footnotes"),events:{},initialize:function(){this.listenTo(Backbone,"layoutComplete",function(a){var b=app.views.sectionView.$el.find("a.footnote-reference"),c=[];b.each(function(a,b){var d=$(b);c.push({id:d.text(),title:d.attr("data-original-title")})}),this.footnotes=c,this.render()},this)},render:function(){return this.$el.html(this.template({items:this.footnotes})),this}}),OsciTk.views.FiguresToolbar=OsciTk.views.BaseView.extend({className:"toolbar-figures-view",template:OsciTk.templateManager.get("toolbar-figures"),events:{},initialize:function(){this.listenTo(app.collections.figures,"add remove reset",function(){this.render()})},render:function(){var a=app.collections.figures.toJSON();return this.$el.html(this.template({figures:a})),this.$el.find("a").on("click",function(){Backbone.trigger("navigate",{identifier:$(this).attr("data-figure-id")})}),this}}),OsciTk.views.NotesToolbar=OsciTk.views.BaseView.extend({className:"toolbar-notes-view",template:OsciTk.templateManager.get("toolbar-notes"),events:{"click a.note-link":"noteLinkClick"},initialize:function(){this.listenTo(app.collections.notes,"add remove change",function(){this.render()}),this.listenTo(Backbone,"accountStateChanged",function(){app.account.get("id")<1&&app.collections.notes.reset(),this.render()}),this.render()},render:function(){var a=this.getSavedNotes();return this.$el.html(this.template({notes:a})),this},noteLinkClick:function(a){a.preventDefault();var b=$(a.currentTarget),c=b.attr("data-content_id");console.log(b,c),c&&(Backbone.trigger("navigate",{identifier:"#"+c}),$(".close-toolbar-item").click(),$('.paragraph-controls[data-osci_content_id="'+c+'"] .paragraph-button').click())},getSavedNotes:function(){var a=_.filter(app.collections.notes.models,function(a){return null!==a.id?!0:!1});return a}}),OsciTk.views.CitationsToolbar=OsciTk.views.BaseView.extend({className:"toolbar-citations-view",template:OsciTk.templateManager.get("toolbar-citations"),events:{},initialize:function(){this.listenTo(Backbone,"layoutComplete",function(a){this.render()},this)},render:function(){return this.$el.html(this.template({})),this}}),OsciTk.views.AccountToolbar=OsciTk.views.BaseView.extend({events:{"click button.login":"login","click button.register":"register","click a.register":"showRegistrationForm","click a.login":"showLoginForm","click a.logout":"logout"},className:"toolbar-account-view",template:null,initialize:function(){this.listenTo(Backbone,"accountReady",function(a){this.model=app.account,this.render()}),this.listenTo(Backbone,"sectionLoaded",function(a){this.sectionId=a.get("id")}),this.render()},render:function(){return this.model&&this.model.get("id")>0?this.showProfile():this.showLoginForm(),this},login:function(){var a=this,b=this.$el.find("#username").val(),c=this.$el.find("#password").val();$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"login",username:b,password:c},type:"POST",dataType:"json",success:function(b){b.success===!0?(console.log(b),a.showProfile()):a.$el.find("div.form-error").html(b.error)}})},logout:function(){var a=this;$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"logout"},type:"POST",dataType:"json",success:function(b){a.model.set(a.model.defaults),a.showLoginForm(),Backbone.trigger("accountStateChanged")}})},register:function(){var a=this,b=this.$el.find("#username").val(),c=this.$el.find("#password").val(),d=this.$el.find("#email").val();$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"register",username:b,password:c,email:d},type:"POST",dataType:"json",success:function(b){b.success===!0?(a.model.set(b.user),a.showProfile(),Backbone.trigger("accountStateChanged")):a.$el.find("div.form-error").html(b.error)}})},showRegistrationClicked:function(a){a.preventDefault(),a.stopPropagation(),this.showRegistrationForm()},showLoginClicked:function(a){a.preventDefault(),a.stopPropagation(),this.showLoginForm()},showRegistrationForm:function(){this.template=OsciTk.templateManager.get("toolbar-account-register"),this.$el.html(this.template())},showLoginForm:function(){this.template=OsciTk.templateManager.get("toolbar-account-login"),this.$el.html(this.template())},showProfile:function(){this.template=OsciTk.templateManager.get("toolbar-account-profile"),this.$el.html(this.template(this.model.toJSON()))}}),OsciTk.views.Citation=OsciTk.views.BaseView.extend({template:OsciTk.templateManager.get("citation"),initialize:function(a){this.render(a)},render:function(a){var b=a.contentId,c=$("#"+b),d={section_id:app.models.section.get("id"),publication_id:app.models.docPackage.get("id"),element_id:a.contentId,field:c.attr("data-sectionId")};$.ajax({url:app.config.get("endpoints").OsciTkCitation,data:d,success:function(a,b){return a.success?(a.citation.referenceText=c.text(),a.citation.url=document.URL+"/p-"+app.models.section.get("id")+"-"+c.data("paragraph_number"),a.citation.paragraphNumber=c.data("paragraph_number"),a.citation.date=new Date(a.citation.date),a.citation.formattedDate=a.citation.date.getMonth()+1+"/"+a.citation.date.getDate()+"/"+a.citation.date.getFullYear(),a.citation.creator=a.citation.creator?a.citation.creator:"",a.citation.description=a.citation.description?a.citation.description:"",a.citation.editor=a.citation.editor?a.citation.editor:"",a.citation.publicationTitle=a.citation.publicationTitle?a.citation.publicationTitle:"",a.citation.publisher=a.citation.publisher?a.citation.publisher:"",a.citation.rights=a.citation.rights?a.citation.rights:"",a.citation.title=a.citation.title?a.citation.title:"",a.citation):void 0}})}}),app={router:void 0,config:void 0,views:{},models:{},collections:{},bootstrap:function(a){this.config=new OsciTk.models.Config(a),this.router=new OsciTk.router,this.features=this.config.get("themeFeatures"),this.collections.figures=new OsciTk.collections.Figures,this.collections.footnotes=new OsciTk.collections.Footnotes,this.collections.navigationItems=new OsciTk.collections.NavigationItems,this.features.notes&&(this.collections.notes=new OsciTk.collections.Notes),this.features.account&&(this.account=new OsciTk.models.Account),this.features.glossary&&(this.collections.glossaryTerms=new OsciTk.collections.GlossaryTerms),window.onresize=function(){window.resizeTimer&&clearTimeout(window.resizeTimer);var a=function(){Backbone.trigger("windowResized")};window.resizeTimer=setTimeout(a,200)},this.views.app=new OsciTk.views.App},run:function(){this.models.docPackage=new OsciTk.models.Package({url:this.config.get("packageUrl")}),Backbone.history.start()}};