function loadXMLDoc(a){var b=new XMLHttpRequest;return b.overrideMimeType&&b.overrideMimeType("text/xml"),b.open("GET",a,!1),b.send(),b.responseXML}function loadHTMLDoc(a){var b=new XMLHttpRequest;b.overrideMimeType&&b.overrideMimeType("text/html"),b.open("GET",a,!1),b.send();var c=b.responseText;return c=c.replace('xmlns="http://www.w3.org/1999/xhtml"',""),c=c.replace('xmlns:epub="http://www.idpf.org/2007/ops"',"")}function xmlToJson(a,b){var c=0;if(!b)for(b=["xml:"],c=0;c<a.documentElement.attributes.length;c++)-1!=a.documentElement.attributes.item(c).nodeName.indexOf("xmlns")&&b.push(a.documentElement.attributes.item(c).nodeName.replace("xmlns:","")+":");var d=!0;if(a.attributes&&a.attributes.length>0){var e;d={};for(var f=0;f<a.attributes.length;f++)e=a.attributes.item(f),d[e.nodeName.replaceArray(b,"").toCamel()]=e.value}if(a.hasChildNodes()){var g,h,i;d===!0&&(d={});for(var j=0;j<a.childNodes.length;j++)i=a.childNodes.item(j),1===(7&i.nodeType)?(g=i.nodeName.replaceArray(b,"").toCamel(),h=xmlToJson(i,b),d.hasOwnProperty(g)?(d[g].constructor!==Array&&(d[g]=[d[g]]),d[g].push(h)):d[g]=h):3===(i.nodeType-1|1)&&(g="value",h=3===i.nodeType?i.nodeValue.replace(/^\s+|\s+$/g,""):i.nodeValue,d.hasOwnProperty(g)?d[g]+=h:(4===i.nodeType||""!==h)&&(d[g]=h))}return d}function objectToArray(a){return void 0!==a?"[object Array]"!==Object.prototype.toString.call(a)?[a]:a:void 0}function tooltips(a){for(var b=0;b<a.features.length;b++){var c=a.features[b];$(c.element).each(function(){$(this).qtip({content:{text:c.data.properties.html},show:{effect:function(){$(this).fadeTo(300,1)}},hide:{fixed:!0,delay:800,effect:function(){$(this).fadeTo(100,0)}},position:{target:"mouse",adjust:{mouse:!1},my:"top left"},style:"qtip-map"})})}}function outerHTML(a){return a.outerHTML||function(a){var b,c=document.createElement("div");return c.appendChild(a.cloneNode(!0)),b=c.innerHTML,c=null,b}(a)}function liMousemove(a){if(window.liCollection&&liCollection.userIsDraggingAsset){var b=liCollection.find(liCollection.userIsDraggingAsset);if(b){if(!b.settings.dragging)return;b.refreshViewfinderViewport(),a.conservationDraggingRemove&&(b.settings.dragging=void 0,liCollection.userIsDraggingAsset=!1)}}}function liMouseup(a){window.liCollection&&liCollection.userIsDraggingAsset&&(a.conservationDraggingRemove=!0,liMousemove(a))}function detectIE(){var a=window.navigator.userAgent,b=a.indexOf("MSIE ");if(b>0)return parseInt(a.substring(b+5,a.indexOf(".",b)),10);var c=a.indexOf("Trident/");if(c>0){var d=a.indexOf("rv:");return parseInt(a.substring(d+3,a.indexOf(".",d)),10)}var e=a.indexOf("Edge/");return e>0?parseInt(a.substring(e+5,a.indexOf(".",e)),10):!1}OsciTk={},OsciTk.collections={},OsciTk.models={},OsciTk.templates={},OsciTk.views={figureTypeRegistry:{}},OsciTk.router=Backbone.Router.extend({routes:{"":"routeToSection","section/:section_id":"routeToSection","section/:section_id/:identifier":"routeToSection"},initialize:function(a){this.on("all",this._trackPageView)},routeToSection:function(a,b){Backbone.trigger("routedToSection",{section_id:a,identifier:b})},_trackPageView:function(){var a=Backbone.history.getFragment();_.isUndefined(window._gaq)||_gaq.push(["_trackPageview","/#"+a])}}),String.prototype.replaceArray=function(a,b){for(var c=this,d=0;d<a.length;d++)c=c.replace(a[d],b);return c},String.prototype.toCamel=function(){return this.replace(/\s(.)/g,function(a){return a.toUpperCase()}).replace(/\s/g,"").replace(/^(.)/,function(a){return a.toLowerCase()})};var $=jQuery,LICollection=function(){var a=[];this.add=function(b){var c,d;for(c=0,d=a.length;d>c;c++)if(a[c].id==b.id)return!1;return a.push(b),!0},this.remove=function(b){var c,d;for("string"==typeof b&&(b={id:b}),c=0,d=a.length;d>c;c++)a[c].id==b.id&&a.splice(c,1)},this.find=function(b){var c,d;for(c=0,d=a.length;d>c;c++)if(a[c].id==b)return a[c];return!1},this.list=function(){return a},this.userIsDraggingAsset=!1},LayeredImage=function(a){var b,c,d;if(void 0===jQuery)return!1;var e=this.$=jQuery;if("undefined"==typeof org)return console.log("Polymaps missing. Add link."),!1;if("undefined"!=typeof org.polymaps&&(this.polymaps=org.polymaps),this.container=e(a),this.container.length<1)return!1;if(window.liCollection.add(this)){this.id=this.container.attr("id"),this.slideshow=this.container.attr("slideshow"),this.settings=this.container.data(),this.settings.zoomStep=this.settings.zoomStep||.1,this.settings.annotationSelectorVisible=!1,this.settings.dragging=void 0;var f=this.container.parents("figure:first"),g=f.attr("data-options");f.length>0&&g&&(this.figureOptions=JSON.parse(g)),("undefined"==typeof this.figureOptions||"object"!=typeof this.figureOptions)&&(this.figureOptions={}),"undefined"==typeof this.figureOptions.disable_interaction&&(this.figureOptions.disable_interaction=!1),"undefined"==typeof this.figureOptions.disable_annotation&&(this.figureOptions.disable_annotation=!1),"undefined"==typeof this.figureOptions.sliderPosition&&(this.figureOptions.sliderPosition=0),this.settings.captionMarkup=this.container.parents("figure:first").find("figcaption").clone(),this.settings.originalMarkup=outerHTML(this.container[0]),this.layers=[];var h=this.container.find(".layered_image-layers"),i=h.find("li"),j=[];for(b=0,c=i.length;c>b;b++){var k=e(i[b]),d=k.data();d.annotation?j.push(d):this.layers.push(d)}j.length&&(this.layers=this.layers.concat(j)),h.remove(),this.map=this.polymaps.map();var l=this.polymaps.svg("svg");for(e(l).css({height:"100%",width:"100%"}),this.map.container(this.container[0].appendChild(l)),this.map.tileSize({x:256,y:256}),this.baseLayers=[],this.annotationLayers=[],this.max_zoom_level=0,this.max_width=0,this.max_height=0,b=0,c=this.layers.length;c>b;b++)d=this.layers[b],d.layer_num=b+1,d.zoom_levels||(d.zoom_levels=this.getZoomLevels(d.width,d.height)),d.annotation?this.annotationLayers.push(d):this.baseLayers.push(d),"iip"===d.type&&(d.zoom_levels=d.zoom_levels-1),d.width>this.max_width&&(this.max_width=d.width),d.height>this.max_height&&(this.max_height=d.height),d.zoom_levels>this.max_zoom_level&&(this.max_zoom_level=d.zoom_levels);if(this.slideshow&&"false"!=this.slideshow){if("true"==this.slideshow){for(b=0;b<this.baseLayers.length;b++)this.createLayer(this.baseLayers[b]),e("#"+this.baseLayers[b].id).css("opacity",0);e("#"+this.baseLayers[0].id).css("opacity",1)}}else{var m=this.figureOptions.baseLayerPreset?this.figureOptions.baseLayerPreset:[],n=m.length,o=!1;if(n>0){var p,q=this.getLayerById(m[0]);n>1&&(p=this.getLayerById(m[1])),q&&(p||1==n)&&(this.createLayer(q),p&&(this.createLayer(p),e("#"+p.id).css("opacity",0)),o=!0)}!o&&this.baseLayers.length&&(this.createLayer(this.baseLayers[0]),this.baseLayers[1]&&(this.createLayer(this.baseLayers[1]),e("#"+this.baseLayers[1].id).css("opacity",0)))}this.createUI(),this.showAnnotationPresets(),this.zoomToContainer();var r=[];this.figureOptions.fullscreenExtents?(r=[{lon:this.figureOptions.fullscreenExtents.swLon,lat:this.figureOptions.fullscreenExtents.swLat},{lon:this.figureOptions.fullscreenExtents.neLon,lat:this.figureOptions.fullscreenExtents.neLat}],this.setExtents(r)):this.figureOptions.swLat&&(r=[{lon:this.figureOptions.swLon,lat:this.figureOptions.swLat},{lon:this.figureOptions.neLon,lat:this.figureOptions.neLat}],this.setExtents(r))}};LayeredImage.prototype.createLayer=function(a){var b;this.$;void 0!==a&&("image"==a.type&&(b=this.createLayerImage(a)),"iip"==a.type&&(b=this.createLayerIIP(a)),"svg"==a.type&&(b=this.createLayerSVG(a)),"json"==a.type&&(b=this.createLayerJSON(a)),a.visible=!0,a.polymapLayer=b,b.id(a.id),this.map.add(b))},LayeredImage.prototype.removeLayer=function(a){a.polymapLayer&&this.map.remove(a.polymapLayer),a.polymapLayer=void 0,a.visible=!1},LayeredImage.prototype.toggleLayer=function(a){a.visible?this.removeLayer(a):this.createLayer(a)},LayeredImage.prototype.repaintLayer=function(a){this.removeLayer(a),this.createLayer(a)},LayeredImage.prototype.createLayerJSON=function(a){var b=this.polymaps.geoJson(),c=a.json_data;return b.on("load",tooltips).url(c),b},LayeredImage.prototype.createLayerIIP=function(a){var b=this,c=this.polymaps.image(),d=function(c){var d=a.ptiff_server,e=a.ptiff_path,f=a.height,g=a.width,h=256,i=b.getScale(a.zoom_levels,c.zoom),j=Math.round(g/i),k=Math.round(f/i),l=Math.ceil(j/h),m=Math.ceil(k/h);if(c.row<0||c.row>=m||c.column<0||c.column>=l)return null;c.row==m-1&&c.element.setAttribute("height",k%h),c.column==l-1&&c.element.setAttribute("width",j%h);var n=d+"?fif="+e+"&jtl="+c.zoom+","+(c.row*l+c.column);return n};return c.url(d),c},LayeredImage.prototype.createLayerImage=function(a){var b=this,c=function(c){var d=b.getScale(b.max_zoom_level,c.zoom);c.element=b.polymaps.svg("image"),c.element.setAttribute("preserveAspectRatio","none"),c.element.setAttribute("x",0),c.element.setAttribute("y",0),c.element.setAttribute("width",b.max_width/d),c.element.setAttribute("height",b.max_height/d),c.element.setAttributeNS("http://www.w3.org/1999/xlink","href",a.image_path),c.ready=!0},d=function(a){a.request&&a.request.abort(!0)},e=this.polymaps.layer(c,d).tile(!1);return e},LayeredImage.prototype.createLayerSVG=function(a){var b=this,c=function(c){var d=b.getScale(b.max_zoom_level,c.zoom);c.element=b.polymaps.svg("image"),c.element.setAttribute("preserveAspectRatio","none"),c.element.setAttribute("x",0),c.element.setAttribute("y",0),c.element.setAttribute("width",b.max_width/d),c.element.setAttribute("height",b.max_height/d),c.element.setAttributeNS("http://www.w3.org/1999/xlink","href",a.svg_path),c.ready=!0},d=function(a){a.request&&a.request.abort(!0)},e=this.polymaps.layer(c,d).tile(!1);return e},LayeredImage.prototype.zoomToContainer=function(){var a,b,c=0,d=0;for(a=0,b=this.layers.length;b>a;a++){var e=this.layers[a],f=this.getScale(this.max_zoom_level,e.zoom_levels),g=Math.round(e.width/f),h=Math.round(e.height/f),i=g/this.map.tileSize().x,j=h/this.map.tileSize().y;e.tiles_wide=i,e.tiles_high=j,e.tiles_zoom=e.zoom_level,d=j>d?j:d,c=i>c?i:c}this.settings.containerFitSW=this.map.coordinateLocation({zoom:this.max_zoom_level,column:0,row:d}),this.settings.containerFitNE=this.map.coordinateLocation({zoom:this.max_zoom_level,column:c,row:0}),this.map.extent([this.settings.containerFitSW,this.settings.containerFitNE]),this.settings.containerFitZoomLevel=this.map.zoom(),this.resetZoomRange(this.settings.containerFitZoomLevel)},LayeredImage.prototype.createUI=function(){var a,b=this.$,c=this;(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&(this.map.add(this.polymaps.drag()).add(this.polymaps.wheel()).add(this.polymaps.dblclick()).add(this.polymaps.touch()),b(this.container).bind({mousewheel:function(a){c.ui.zoomSlider.slider("value",c.map.zoom()),c.refreshViewfinderViewport()},DOMMouseScroll:function(a){c.ui.zoomSlider.slider("value",c.map.zoom()),c.refreshViewfinderViewport()},dblclick:function(a){c.ui.zoomSlider.slider("value",c.map.zoom()),c.refreshViewfinderViewport()},mousedown:function(a){c.settings.dragging={x:a.clientX,y:a.clientY},liCollection.userIsDraggingAsset=c.id}})),this.ui={},this.ui.legendItemsCount=0,this.ui.controlbar=b('<div class="ca-ui-controlbar"></div>'),a=this.settings.collapsed?"collapsed":"expanded",this.ui.fullscreen=b('<div class="ca-ui-fullscreen '+a+'"></div>').bind("click",function(){c.settings.collapsed?c.fullscreen():(window.liCollection.remove(c),b(".ca-ui-fullscreen-modal").remove(),window.scrollOffset&&window.scrollTo(window.scrollOffset[0],window.scrollOffset[1]))}).appendTo(this.ui.controlbar),this.ui.reset=b('<div class="ca-ui-reset"></div>').bind("click",function(a){c.reset()}),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.reset.appendTo(this.ui.controlbar),this.annotationLayers.length>0&&(this.ui.annotation=b('<div class="ca-ui-annotation"></div>').bind("click",function(a){c.toggleAnnotationSelector()}),(!this.figureOptions.disable_annotation||this.figureOptions.editing)&&this.ui.annotation.appendTo(this.ui.controlbar));var d=this.getVisibleBaseLayers();this.settings.currentLayer1=d[0],this.settings.presentLayer=d[0],this.settings.prevLayer=d[0],d.length>1&&(this.settings.currentLayer2=d[1],"false"==this.slideshow&&(this.ui.layerSelector=b('<div class="ca-ui-layer-selector"></div>'),this.ui.layerSelector.bind("click",{layeredImage:this},this.toggleLayerSelector),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.controlbar.append(this.ui.layerSelector),this.ui.sliderContainer=b('<div class="ca-ui-layer-slider-container"></div>'),this.ui.sliderLayerText1=b('<div class="ca-ui-layer-slider-layer-text1">1</div>').attr("title",this.settings.currentLayer1.title).appendTo(this.ui.sliderContainer).qtip(),this.ui.slider=b('<div class="ca-ui-layer-slider"></div>').slider({slide:function(a,d){var e=d.value/100;b("#"+c.settings.currentLayer2.id).css("opacity",e),c.refreshViewfinderOpacity(e)},change:function(a,d){var e=d.value/100;b("#"+c.settings.currentLayer2.id).css("opacity",e),c.refreshViewfinderOpacity(e)}}).appendTo(this.ui.sliderContainer),this.ui.sliderLayerText2=b('<div class="ca-ui-layer-slider-layer-text2">2</div>').attr("title",this.settings.currentLayer2.title).appendTo(this.ui.sliderContainer).qtip(),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&(this.ui.sliderContainer.appendTo(this.ui.controlbar),this.ui.layerSelector.after(this.ui.sliderContainer)),void 0!==this.figureOptions.sliderPosition&&this.ui.slider.slider("value",this.figureOptions.sliderPosition)),"true"==this.slideshow&&(this.ui.slideshow=b('<div class="ca-ui-slideshow"></div>'),this.ui.slideshowprev=b('<div class="ca-ui-layer-slideshow-prev"><</div>').on("click",{layeredImage:this},this.prevLayerSlide).qtip({content:"previous"}).appendTo(this.ui.slideshow),this.ui.slideshownext=b('<div class="ca-ui-layer-slideshow-next">></div>').bind("click",{layeredImage:this},this.nextLayerSlide).qtip({content:"next"}).appendTo(this.ui.slideshow),this.ui.slideshowstatus=b('<div class="ca-ui-layer-slideshow-status"></div>').html(this.settings.presentLayer.layer_num+" of "+d.length).appendTo(this.ui.slideshow),this.ui.slideshow.appendTo(this.ui.controlbar),this.ui.slideshowtitle=b('<div class="ca-ui-slideshow-title"></div>').appendTo(this.container),this.settings.presentLayer.title&&this.ui.slideshowtitle.html(this.settings.presentLayer.title))),this.ui.controlbar.appendTo(this.container),this.resizeControlBar(),this.ui.zoom=b('<div class="ca-ui-zoom"></div>'),this.ui.zoomIn=b('<div class="ca-ui-zoom-in"></div>').bind("click",function(a){var b=c.ui.zoomSlider.slider("value"),d=b+c.settings.zoomStep;c.ui.zoomSlider.slider("value",d),c.map.zoom(d)}).appendTo(this.ui.zoom),this.ui.zoomSlider=b('<div class="ca-ui-zoom-slider"></div>').slider({step:this.settings.zoomStep,orientation:"vertical",slide:function(a,b){var d=b.value,e=c.map.zoom();d!=e&&c.map.zoom(d)}}).appendTo(this.ui.zoom),this.ui.zoomOut=b('<div class="ca-ui-zoom-out"></div>').bind("click",function(a){var b=c.ui.zoomSlider.slider("value"),d=b-c.settings.zoomStep;c.ui.zoomSlider.slider("value",d),c.map.zoom(d)}).appendTo(this.ui.zoom),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.zoom.appendTo(this.container),this.resizeZoomControls(),this.ui.viewfinder=b('<div class="ca-ui-viewfinder viewfinder-closed"></div>'),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.viewfinder.appendTo(this.container),this.ui.viewfinder.bind("click",function(a){c.ui.viewfinder.hasClass("viewfinder-open")?(c.ui.viewfinder.empty().css("height",""),c.ui.viewfinder.removeClass("viewfinder-open").addClass("viewfinder-closed"),c.ui.viewfinderViewport=null):(c.ui.viewfinder.removeClass("viewfinder-closed").addClass("viewfinder-open"),c.refreshViewfinder())}),this.ui.controls=[this.ui.controlbar,this.ui.zoom,this.ui.viewfinder,this.ui.currentPopup,this.ui.annotation,this.ui.layerSelector],this.container.bind("mousemove mousewheel DOMMouseScroll",function(a){var b=c.container,d=new Date;b.attr("data-controls-time",d.getTime());var e=b.attr("data-controls")||"false";if("false"==e){for(var f=window.liCollection.list(),g=0,h=f.length;h>g;g++){var i=f[g];"true"==i.container.attr("data-controls")&&(i.container.attr("data-controls","false"),i.toggleControls())}b.attr("data-controls","true"),c.toggleControls()}c.ui.controlsTimeout=setTimeout(function(){var a=new Date;"true"==b.attr("data-controls")&&a.getTime()-b.attr("data-controls-time")>=1750&&"true"!=b.attr("data-controls-lock")&&(b.attr("data-controls","false"),c.clearPopups(),c.toggleControls())},2e3)}),b.each(this.ui.controls,function(){"function"==typeof this.bind&&(this.bind("mouseenter",function(){c.container.attr("data-controls-lock","true")}),this.bind("mouseleave",function(){c.container.attr("data-controls-lock","false")}))})},LayeredImage.prototype.reset=function(){var a,b,c=this.$,d=this;if(d.clearPopups(),"undefined"==typeof d.figureOptions.swLat||d.figureOptions.editing)d.zoomToContainer();else{var e=[{lon:d.figureOptions.swLon,lat:d.figureOptions.swLat},{lon:d.figureOptions.neLon,lat:d.figureOptions.neLat}];d.map.extent(e)}d.ui.zoomSlider.slider("value",d.map.zoom()),void 0!==d.figureOptions.sliderPosition&&d.ui.slider&&d.ui.slider.slider("value",d.figureOptions.sliderPosition);var f;if(d.figureOptions.baseLayerPreset)for(f=[],a=0,b=d.figureOptions.baseLayerPreset.length;b>a;a++)f.push(d.getLayerById(d.figureOptions.baseLayerPreset[a]));else f=d.baseLayers;for(a=0,b=f.length;b>a&&2>a;a++)currentLayer=d.settings["currentLayer"+(a+1)],d.toggleLayer(currentLayer),d.toggleLayer(f[a]),d.settings["currentLayer"+(a+1)]=f[a],d.ui["layerSelector"+(a+1)]&&d.ui["layerSelector"+(a+1)].find("span").html(f[a].title),d.ui["sliderLayerText"+(a+1)]&&d.ui["sliderLayerText"+(a+1)].attr("title",d.settings["currentLayer"+(a+1)].title);if(f.length>1&&d.ui.slider&&(c("#"+d.settings.currentLayer2.id).css("opacity",d.ui.slider.slider("value")/100),d.ui.viewfinderLayer2&&d.ui.viewfinderLayer2.css("opacity",d.ui.slider.slider("value")/100)),"true"==this.slideshow){for(a=0;a<f.length;a++)d3.select("#"+f[a].id).style("opacity",0);d.settings.presentLayer=d.settings.currentLayer1,d3.select("#"+d.settings.presentLayer.id).style("opacity",1),d.settings.prevLayer=d.baseLayers[d.settings.presentLayer.layer_num-1],d.ui.slideshowtitle.html(d.settings.presentLayer.title),d.ui.slideshowstatus.html(d.settings.presentLayer.layer_num+" of "+d.baseLayers.length),d.ui.slideshowprev.css("background-color","#ffffff"),d.ui.slideshownext.css("background-color","#ffffff")}d.refreshViewfinder(),d.showAnnotationPresets()},LayeredImage.prototype.refreshViewfinder=function(){var a,b=this.$;if(this.ui.viewfinder.empty(),this.ui.viewfinder.hasClass("viewfinder-open")){if("true"==this.slideshow)a=this.settings.presentLayer.thumb;else if(a=this.settings.currentLayer1.thumb,this.settings.currentLayer2){var c=this.settings.currentLayer2.thumb;this.ui.viewfinderLayer2=b('<div class="ca-ui-viewfinderLayer viewfinderLayer2"></div>'),b("<img />").attr("src",c).appendTo(this.ui.viewfinderLayer2),this.ui.viewfinder.append(this.ui.viewfinderLayer2),this.ui.viewfinderLayer2.css("opacity",this.ui.slider.slider("value")/100)}this.ui.viewfinderLayer1=b('<div class="ca-ui-viewfinderLayer viewfinderLayer1"></div>'),b("<img />").attr("src",a).appendTo(this.ui.viewfinderLayer1),this.ui.viewfinder.append(this.ui.viewfinderLayer1);var d=this.ui.viewfinder.width(),e=Math.floor(d/this.settings.aspect);this.ui.viewfinder.height(e),this.ui.viewfinderViewport&&this.ui.viewfinderViewport.remove(),this.ui.viewfinderViewport=void 0,this.refreshViewfinderViewport()}},LayeredImage.prototype.refreshViewfinderViewport=function(){if(this.ui.viewfinder.hasClass("viewfinder-open")){var a=this.$,b=this.ui.viewfinder.width(),c=Math.floor(b/this.settings.aspect);this.ui.viewfinderViewport||(this.ui.viewfinderViewport=a('<div class="ca-ui-viewfinder-viewport">&nbsp;</div>').appendTo(this.ui.viewfinder),void 0===this.settings.viewPortBorderWidth&&(this.settings.viewPortBorderWidth=parseInt(this.ui.viewfinderViewport.css("border-left-width"),10)));var d=this.map.locationPoint(this.settings.containerFitSW),e=this.map.locationPoint(this.settings.containerFitNE),f=-1*d.x/(e.x-d.x)*b-this.settings.viewPortBorderWidth,g=-1*e.y/(d.y-e.y)*c-this.settings.viewPortBorderWidth,h=this.map.size().x/(e.x-d.x),i=this.map.size().y/(d.y-e.y),j=h*b,k=i*c;this.ui.viewfinderViewport.css({top:g+"px",left:f+"px",width:j+"px",height:k+"px"})}},LayeredImage.prototype.refreshViewfinderOpacity=function(a){this.ui.viewfinderLayer2&&this.ui.viewfinderLayer2.css("opacity",a)},LayeredImage.prototype.fullscreen=function(a){var b=this.$,c=this,d=b('<div class="ca-ui-fullscreen-modal"></div>').appendTo(document.body);d.bind("click",function(a){b(a.target).hasClass("ca-ui-fullscreen-modal")&&b(this).find(".ca-ui-fullscreen").trigger("click")});var e=b('<div class="ca-ui-fullscreen-wrap"></div>').appendTo(d),f=d.offset(),g=d.height()-f.top,h=d.outerWidth()-f.left,i=0,j=0,k=!0,l=.9,m=void 0!==(c.figureOptions&&c.figureOptions.aspect)?c.figureOptions.aspect:c.settings.aspect;if(1>=m)for(;j>h||k;)i=Math.floor(g*l),j=Math.floor(i*m),l-=.1,k=!1;else for(;i>g||k;)j=Math.floor(h*l),i=Math.floor(j/m),l-=.1,k=!1;e.css({height:i+"px",top:Math.floor((g-i)/2)+"px",width:j+"px",left:Math.floor((h-j)/2)+"px"});var n=b(this.settings.originalMarkup);n.attr("id",n.attr("id")+"-fullscreen"),n.attr("data-collapsed","false"),n.find("li").each(function(){var a=b(this);a.data("id",a.data("id")+"-fullscreen"),a.data("parent_asset",a.data("parent_asset")+"-fullscreen")});var o=this.map.extent();1!==this.map.zoom()&&(this.figureOptions.fullscreenExtents={swLon:o[0].lon,swLat:o[0].lat,neLon:o[1].lon,neLat:o[1].lat});var p=b("<figure></figure>").attr("data-options",JSON.stringify(this.figureOptions)).css({height:i+"px",width:j+"px"}).appendTo(e),q=0;this.settings.captionMarkup&&(p.append(this.settings.captionMarkup),q=this.settings.captionMarkup.outerHeight(!0)),b("<div>",{"class":"figureContent",css:{height:Math.round(i)-q+"px",width:j+"px"}}).append(n).prependTo(p);var r=new LayeredImage(n);a&&r.reset()},LayeredImage.prototype.resizeControlBar=function(){var a=this.container.outerWidth(),b=this.ui.controlbar.children(),c=0;b.each(function(){c+=$(this).outerWidth()});var d=a-2*parseInt(this.ui.controlbar.css("right"),10);c>d&&(this.ui.controlbar.css({"max-width":d+"px"}),b.each(function(){var a=$(this);d-=a.outerWidth(),0>d&&(a.width(a.width()+d),a.find(".ca-ui-layer-slider").each(function(){$(this).width($(this).width()+d)}))}))},LayeredImage.prototype.resizeZoomControls=function(){var a=this.container.outerHeight(),b=this.ui.zoom.children(),c=0;b.each(function(){c+=$(this).outerHeight()});var d=a-this.ui.controlbar.outerHeight()-1;if(c>d)if(this.ui.zoom.css({"max-height":d+"px"}),d-=this.ui.zoomIn.outerHeight()+this.ui.zoomOut.outerHeight(),50>d)this.ui.zoomSlider.hide(),this.ui.zoom.css({"max-height":this.ui.zoomIn.outerHeight()+this.ui.zoomOut.outerHeight()+"px"});else{var e=this.ui.zoomSlider.outerHeight(!0)-this.ui.zoomSlider.outerHeight();this.ui.zoomSlider.height(d-e+"px")}},LayeredImage.prototype.prevLayerSlide=function(a){var b,c=a.data.layeredImage;if(c.ui.slideshowprev.off("click",this.prevLayerSlide),c.settings.presentLayer.layer_num!=c.baseLayers[0].layer_num){c.ui.slideshowprev.css("background-color","#ffffff"),c.ui.slideshownext.css("background-color","#ffffff");for(var d=0;d<c.baseLayers.length;d++){var e=c.baseLayers[d];if(c.settings.presentLayer.layer_num==e.layer_num){if(b=c.baseLayers[d-1],d3.select("#"+e.id).transition().duration(300).style("opacity",0).each("end",function(){d3.select("#"+b.id).transition().duration(300).style("opacity",1).each("end",function(){c.ui.slideshowprev.on("click",{layeredImage:c},c.prevLayerSlide)})}),c.settings.presentLayer=b,c.settings.prevLayer=e,c.settings.presentLayer.title&&c.ui.slideshowtitle.html(c.settings.presentLayer.title),c.ui.slideshowstatus.html(c.settings.presentLayer.layer_num+" of "+c.baseLayers.length),c.ui.viewfinder.hasClass("viewfinder-open")&&c.refreshViewfinder(),"undefined"==typeof c.figureOptions.swLat||c.figureOptions.editing)c.zoomToContainer();else{var f=[{lon:c.figureOptions.swLon,lat:c.figureOptions.swLat},{lon:c.figureOptions.neLon,lat:c.figureOptions.neLat}];c.map.extent(f)}return c.ui.zoomSlider.slider("value",c.map.zoom()),void(c.settings.presentLayer.layer_num==c.baseLayers[0].layer_num&&c.ui.slideshowprev.css("background-color","#888888"))}}}},LayeredImage.prototype.nextLayerSlide=function(a){var b,c=a.data.layeredImage;if(c.ui.slideshownext.off("click",this.nextLayerSlide),c.settings.presentLayer.layer_num!=c.baseLayers.length){c.ui.slideshowprev.css("background-color","#ffffff"),c.ui.slideshownext.css("background-color","#ffffff");for(var d=0;d<c.baseLayers.length;d++){var e=c.baseLayers[d];if(c.settings.presentLayer.layer_num==e.layer_num){if(b=c.baseLayers[d+1],d3.select("#"+e.id).transition().duration(300).style("opacity",0).each("end",function(){d3.select("#"+b.id).transition().duration(300).style("opacity",1).each("end",function(){c.ui.slideshownext.on("click",{layeredImage:c},c.nextLayerSlide)})}),c.settings.presentLayer=b,b.layer_num>1&&(c.settings.prevLayer=e),c.settings.presentLayer.title&&c.ui.slideshowtitle.html(c.settings.presentLayer.title),c.ui.slideshowstatus.html(c.settings.presentLayer.layer_num+" of "+c.baseLayers.length),c.ui.viewfinder.hasClass("viewfinder-open")&&c.refreshViewfinder(),"undefined"==typeof c.figureOptions.swLat||c.figureOptions.editing)c.zoomToContainer();else{var f=[{lon:c.figureOptions.swLon,lat:c.figureOptions.swLat},{lon:c.figureOptions.neLon,lat:c.figureOptions.neLat}];c.map.extent(f)}return c.ui.zoomSlider.slider("value",c.map.zoom()),void(c.settings.presentLayer.layer_num==c.baseLayers.length&&c.ui.slideshownext.css("background-color","#888888"))}}}},LayeredImage.prototype.toggleLayerSelector=function(a){var b=jQuery,c=a.data.layeredImage,d=b(this);c.settings.currentLayer1,c.settings.currentLayer2;if(c.ui.currentPopup&&c.ui.currentPopup==c.ui.layerSelectorPopup)c.clearPopups();else{c.clearPopups(),d.addClass("active"),rows=b('<div class="ca-ui-layer-selector-rows"></div>');for(var e=0;e<c.baseLayers.length;e++){var f=c.baseLayers[e];rowLayerButton1=b('<div class="ca-ui-layer-selector-row-button1"><div class="ca-ui-layer-selector-button"></div></div>').attr("data-layer_index",e),rowTitle=b('<div class="ca-ui-layer-selector-row-title"><span>'+f.title+"</span></div>"),rowLayerButton2=b('<div class="ca-ui-layer-selector-row-button2"><div class="ca-ui-layer-selector-button"></div></div>').attr("data-layer_index",e),f==c.settings.currentLayer1&&rowLayerButton1.find(".ca-ui-layer-selector-button").first().addClass("active"),f==c.settings.currentLayer2&&rowLayerButton2.find(".ca-ui-layer-selector-button").first().addClass("active"),rowLayerButton1.bind("click",{CA:c,layerNum:1},c.layerSelect),rowLayerButton2.bind("click",{CA:c,layerNum:2},c.layerSelect),row=b('<div class="ca-ui-layer-selector-row"></div>').append(rowLayerButton1).append(rowTitle).append(rowLayerButton2),rows.append(row)}var g=parseInt(c.ui.controlbar.css("bottom"),10)+c.ui.controlbar.height(),h=c.ui.controlbar.position().left,i=(c.ui.sliderContainer.outerWidth()+d.outerWidth(),{bottom:g+"px",left:h+"px"});c.ui.layerSelectorPopup=b('<div class="ca-ui-layer-selector-popup"></div>').css(i).bind("mouseenter",function(){c.container.attr("data-controls-lock","true")}).bind("mouseleave",function(){c.container.attr("data-controls-lock","false")}).append(rows).appendTo(c.container),c.ui.currentPopup=c.ui.layerSelectorPopup}},LayeredImage.prototype.toggleAnnotationSelector=function(){var a=this.$,b=this;if(this.ui.currentPopup&&this.ui.currentPopup==this.ui.annotationSelector)this.clearPopups();else{this.clearPopups(),this.ui.annotation.addClass("active");var c=this.ui.annotation.offsetParent().position(),d=this.ui.annotation.position(),e=this.ui.annotation.outerWidth(),f=this.ui.annotation.offsetParent().parent().width(),g=this.ui.annotation.offsetParent().parent().height(),h=f-c.left-d.left-e,i=g-c.top-d.top;this.settings.annotationSelectorVisible=!0,this.ui.annotationSelector=a('<div class="ca-ui-annotation-selector"></div>').css({right:h,bottom:i}),a('<div class="title">Annotations</div>').appendTo(this.ui.annotationSelector),this.ui.annotationSelectorList=a('<ul class="ca-ui-annotation-selector-list"></ul>');for(var j=0,k=this.annotationLayers.length;k>j;j++){var l=this.annotationLayers[j],m=a("<li></li>").bind("click",{layerData:l,CA:b},b.annotationLayerClick),n=a('<div class="ca-ui-annotation-selector-item-box"></div>').addClass(l.visible?"filled":"empty");l.visible&&l.annotation&&n.css("background-color","#"+l.color),m.append(n).append("<span>"+l.title+"</span>").appendTo(this.ui.annotationSelectorList)}this.ui.annotationSelector.bind("mouseenter",function(){b.container.attr("data-controls-lock","true")}).bind("mouseleave",function(){b.container.attr("data-controls-lock","false")}).append(this.ui.annotationSelectorList).appendTo(this.container),this.ui.currentPopup=this.ui.annotationSelector}},LayeredImage.prototype.annotationLayerClick=function(a){var b=a.data.layerData,c=a.data.CA;c.toggleLayer(b);var d=$(this).find(".ca-ui-annotation-selector-item-box");if(b.visible){if(d.removeClass("empty").addClass("filled"),b.annotation&&"svg"==b.type){var e=b.color||"#fff";d.css("background-color","#"+e),c.addLegendItem(b)}}else d.removeClass("filled").addClass("empty"),b.annotation&&"svg"==b.type&&(d.css("background-color",""),c.removeLegendItem(b))},LayeredImage.prototype.resetZoomRange=function(a){a=a||0;for(var b=0,c=0,d=this.layers.length;d>c;c++)"iip"==this.layers[c].type?this.layers[c].zoom_levels-1>b&&(b=this.layers[c].zoom_levels-1):this.layers[c].zoom_levels>b&&(b=this.layers[c].zoom_levels);this.map.zoomRange([a,b]),this.ui.zoomSlider.slider("option","min",a),this.ui.zoomSlider.slider("option","max",b)},LayeredImage.prototype.getZoomLevels=function(a,b){for(var c=this.map.tileSize().x,d=1;a>c||b>c;)d++,a/=2,b/=2;return d},LayeredImage.prototype.getScale=function(a,b){return Math.pow(2,a-b)},LayeredImage.prototype.realignLayers=function(){var a,b,c=this.$,d=this.container.find("svg.map"),e=d.find("g.layer").remove();for(a=0,b=e.length;b>a;a++)c(e[a]).attr("id")==this.settings.currentLayer1.id&&(d.append(e[a]),e.splice(a,1));for(a=0,b=e.length;b>a;a++)c(e[a]).attr("id")==this.settings.currentLayer2.id&&(d.append(e[a]),e.splice(a,1));d.append(e)},LayeredImage.prototype.clearPopups=function(){this.ui.currentPopup&&(this.ui.currentPopup.fadeOut(400,function(){$(this).remove()}),this.ui.currentPopup=!1),this.ui.controls&&$.each(this.ui.controls,function(){$(this).removeClass("active")})},LayeredImage.prototype.toggleControls=function(a){a=a||400;var b=this.$;b.each(this.ui.controls,function(){this!=window&&this.fadeToggle(a)})},LayeredImage.prototype.addLegendItem=function(a){var b=this.$;if(a.color&&""!==a.color){this.ui.legend||(this.ui.legend=b('<div class="ca-ui-legend"><ul class="legendList"></ul></div>').appendTo(this.container),"true"!=this.container.attr("data-controls")&&this.ui.legend.css("display","none"),this.ui.controls.push(this.ui.legend));var c=this.ui.legend.find("ul"),d=b('<li data-layer_num="'+a.layer_num+'">'+a.title+"</li>").appendTo(c);b('<div class="item-box"></div>').css("background-color","#"+a.color).prependTo(d);this.ui.legendItemsCount++}},LayeredImage.prototype.removeLegendItem=function(a){var b=this.$,c=this;if(this.ui.legend){var d=this.ui.legend.find("ul").children();if(d.each(function(){b(this).attr("data-layer_num")==a.layer_num&&(b(this).remove(),c.ui.legendItemsCount--)}),this.ui.legendItemsCount<=0){this.ui.legend.remove(),delete this.ui.legend;for(var e=0,f=this.ui.controls.length;f>e;e++)b(this.ui.controls[e]).hasClass("ca-ui-legend")&&this.ui.controls.splice(e,1)}}},LayeredImage.prototype.showAnnotationPresets=function(){for(var a=0,b=this.annotationLayers.length;b>a;a++)if(this.removeLayer(this.annotationLayers[a]),
this.removeLegendItem(this.annotationLayers[a]),this.figureOptions.annotationPreset)for(var c=0,d=this.figureOptions.annotationPreset.length;d>c;c++){var e=this.figureOptions.annotationPreset[c];if(this.annotationLayers[a].layer_id==e){this.repaintLayer(this.annotationLayers[a]),(!this.figureOptions.disable_annotation||this.figureOptions.editing)&&this.addLegendItem(this.annotationLayers[a]);break}}},LayeredImage.prototype.getVisibleBaseLayers=function(){var a,b,c=[];for(a=0,b=this.baseLayers.length;b>a;a++){var d=this.baseLayers[a];d.visible&&c.push(d)}return c},LayeredImage.prototype.getVisibleBaseLayerIds=function(){var a,b,c=[];for(a=0,b=this.baseLayers.length;b>a;a++){var d=this.baseLayers[a];d.visible&&c.push(d.layer_id)}return c},LayeredImage.prototype.getVisibleAnnotationIds=function(){var a,b,c=[];for(a=0,b=this.annotationLayers.length;b>a;a++){var d=this.annotationLayers[a];d.visible&&c.push(d.layer_id)}return c},LayeredImage.prototype.getExtents=function(){var a=this.map.extent();return{swLon:a[0].lon,swLat:a[0].lat,neLon:a[1].lon,neLat:a[1].lat}},LayeredImage.prototype.setExtents=function(a){this.map.extent(a),this.ui.zoomSlider&&this.ui.zoomSlider.slider("value",this.map.zoom())},LayeredImage.prototype.getSliderPosition=function(){return"undefined"!=typeof this.ui.slider?this.ui.slider.slider("value"):0},LayeredImage.prototype.getLayerById=function(a){for(var b=0,c=this.layers.length;c>b;b++)if(this.layers[b].layer_id&&this.layers[b].layer_id==a)return this.layers[b];return!1},LayeredImage.prototype.layerSelect=function(a){var b=a.data.CA,c=a.data.layerNum,d=parseInt($(this).attr("data-layer_index"),10),e=$(this).find(".ca-ui-layer-selector-button");if(!e.hasClass("active")){var f=1==c?2:1,g=b.ui.layerSelectorPopup.find(".ca-ui-layer-selector-row-button"+f+'[data-layer_index="'+d+'"] .ca-ui-layer-selector-button');if(!g.hasClass("active")){if(b.removeLayer(b.settings["currentLayer"+c]),b.createLayer(b.baseLayers[d]),b.settings["currentLayer"+c]=b.baseLayers[d],2==c){var h=b.ui.slider.slider("value"),i=h/100;$("#"+b.settings.currentLayer2.id).css("opacity",i)}b.ui.layerSelectorPopup.find(".ca-ui-layer-selector-row-button"+c+" .ca-ui-layer-selector-button").removeClass("active"),e.addClass("active"),b.ui.sliderLayerText1.attr("title",b.settings.currentLayer1.title),b.ui.sliderLayerText2.attr("title",b.settings.currentLayer2.title),b.realignLayers(),b.refreshViewfinder()}}},window.liCollection=new LICollection,window.addEventListener("mousemove",liMousemove,!1),window.addEventListener("mouseup",liMouseup,!1),$.fn.findNearest=function(a){var b,c,d,e,f,g=null,h=a.left,i=a.top;return this.each(function(){if(b=$(this).offset(),h>=b.left&&h<=b.right&&i>=b.top&&i<=b.bottom)return g=$(this),!1;var a=[[b.left,b.top],[b.right,b.top],[b.left,b.bottom],[b.right,b.bottom]];for(off in a)d=a[off][0]-h,e=a[off][1]-i,c=Math.sqrt(d*d+e*e),(void 0===f||f>c)&&(f=c,g=$(this))}),g},OsciTk.templateManager={get:function(a){return function(b){return OsciTk.templateManager.useTemplate(a,b)}},useTemplate:function(a,b){if(void 0===OsciTk.templates[a])for(var c=app.config.get("templateUrls"),d=!1,e=c.length,f=0;e>f&&($.ajax({async:!1,dataType:"html",url:c[f]+a+".tpl.html",success:function(b,c,e){OsciTk.templates[a]=_.template(b),d=!0}}),!d);f++);return OsciTk.templates[a](b)}},OsciTk.models.BaseModel=Backbone.Model.extend(),OsciTk.models.Config=OsciTk.models.BaseModel.extend({}),OsciTk.models.Package=OsciTk.models.BaseModel.extend({defaults:function(){return{url:null,lang:null,spine:null,manifest:null,metadata:null,id:null,version:null,xmlns:null}},initialize:function(){var a=xmlToJson(loadXMLDoc(this.get("url")));this.set("lang",a["package"].lang),this.set("spine",a["package"].spine),this.set("manifest",a["package"].manifest),this.set("metadata",a["package"].metadata);var b=a["package"].metadata["dc:identifier"];_.isArray(b)||(b=[b]);for(var c=b.length,d=0;c>d;d++){var e=b[d];if(e.value.indexOf("urn:osci_tk_identifier:")!==!1){this.set("id",e.value.substr(23));break}}this.set("version",a["package"].version),this.set("xmlns",a["package"].xmlns),Backbone.trigger("packageLoaded",this)},sync:function(a,b,c){},getTitle:function(){var a,b=this.get("metadata");return b["dc:title"]&&b["dc:title"].value&&(a=b["dc:title"].value),a},getPubId:function(){var a,b=this.get("metadata");if(!_.isUndefined(b["dc:identifier"]))if(_.isArray(b["dc:identifier"])){var c=_.find(b["dc:identifier"],function(a){return"publication-id"===a.id?!0:!1});c&&(a=c.value.split(":"))}else a=b["dc:identifier"].value.split(":");return a[2]}}),OsciTk.models.Figure=OsciTk.models.BaseModel.extend({defaults:function(){return{section_id:null,delta:null,caption:null,position:null,columns:null,aspect:0,body:null,options:{},plate:!1}},initialize:function(){this.parsePositionData(),this.set("content",$.trim(this.get("content")))},parsePositionData:function(){var a,b=this.get("position");return("plate"===b||"platefull"===b)&&(this.set("plate",!0),"plate"===b?b="p":"platefull"===b&&(b="ff")),a=2==b.length?{vertical:b[0],horizontal:b[1]}:"n"===b||"p"===b?{vertical:b,horizontal:b}:{vertical:b,horizontal:"na"},this.set("position",a),this}}),OsciTk.models.Footnote=OsciTk.models.BaseModel.extend({defaults:function(){return{body:"",section_id:"",delta:""}},sync:function(a,b,c){}}),OsciTk.models.NavigationItem=OsciTk.models.BaseModel.extend({defaults:function(){return{title:null,subtitle:null,uri:null,parent:null,next:null,previous:null,depth:0,thumbnail:null,timestamp:null}}}),OsciTk.models.Page=OsciTk.models.BaseModel.extend({defaults:function(){return{content:{},pageNumber:0}},addContent:function(a){var b=this.get("content"),c=$(a[0]).data("osci_content_id");return void 0===c&&(c=$(a[0]).attr("id")),void 0===c?(c="content",void 0===b[c]?b[c]=a.html():b[c]=b[c]+a.html()):b[c]=a[0],this},removeContentAt:function(a){var b=this.get("content");return delete b[a],this},removeAllContent:function(){this.set("content",{})},contentLength:function(){return this.get("content").length},getContent:function(a){return this.get("content")[a]}}),OsciTk.models.Note=OsciTk.models.BaseModel.extend({defaults:function(){return{id:null,content_id:null,section_id:null,note:null,tags:[],paragraph_number:null}},initialize:function(a,b){this.on("error",function(a,b){throw new Error("an error has occured")})},sync:function(a,b,c){var d=app.config.get("endpoints").OsciTkNote;switch(a){case"create":c.data=b.toJSON(),delete c.data.id,c.success=function(a,d,e){var f=JSON.parse(a);f.success?(b.set("id",f.note.id),b.trigger("change")):c.error(b,e)},c.type="POST",$.ajax(d,c);break;case"update":c.data=b.toJSON(),c.success=function(a,d,e){var f=JSON.parse(a);f.success?b.trigger("change"):c.error(b,e)},c.type="POST",$.ajax(d,c);break;case"delete":c.data=b.toJSON(),c.data["delete"]=1,c.type="POST",c.success=function(a,d,e){var f=JSON.parse(a);f.success?b.trigger("change"):c.error(b,e)},$.ajax(d,c)}}}),OsciTk.models.Section=OsciTk.models.BaseModel.extend({defaults:function(){return{title:null,content:null,uri:null,media_type:"application/xhtml+xml",contentLoaded:!1,pages:null}},initialize:function(){pages=new OsciTk.collections.Pages},loadContent:function(){var a=null;if(this.get("contentLoaded")===!1){var b=loadHTMLDoc(this.get("uri")),c=[],d=/body([^>]*)class=(["']+)([^"']*)(["']+)/gi.exec(b.substring(b.indexOf("<body"),b.indexOf("</body>")+7));_.isArray(d)&&!_.isUndefined(d[3])&&(c=d[3].split(" ")),a=$("<div />").html(b),this.set("title",a.find("title").html()),this.set("content",a),this.set("contentLoaded",!0),this.set("classes",c)}null===a&&(a=$(this.get("content")));var e=a.find("section#footnotes"),f=a.find("figure");Backbone.trigger("footnotesAvailable",e),Backbone.trigger("figuresAvailable",f),Backbone.trigger("sectionLoaded",this)},removeAllPages:function(){this.set("pages",new OsciTk.collections.Pages)}}),OsciTk.models.Account=OsciTk.models.BaseModel.extend({defaults:{username:"anonymous",email:null,id:0},initialize:function(){this.getSessionState()},sync:function(a,b,c){},getSessionState:function(){var a=this;$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"status"},type:"POST",dataType:"json",success:function(b){b.success===!0&&a.set(b.user)}}).done(function(){Backbone.trigger("accountReady")})}}),OsciTk.models.GlossaryTerm=OsciTk.models.BaseModel.extend({defaults:function(){return{term:"",definition:""}}}),OsciTk.collections.BaseCollection=Backbone.Collection.extend(),OsciTk.collections.Figures=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Figure,initialize:function(){this.listenTo(Backbone,"figuresAvailable",function(a){this.populateFromMarkup(a),Backbone.trigger("figuresLoaded",this)})},comparator:function(a){return a.get("delta")},populateFromMarkup:function(a){var b=[];_.each(a,function(a){var c=a.id.match(/\w+-(\d+)-(\d+)/),d=$(a),e={id:a.id,rawData:a,body:a.innerHTML,section_id:c[1],delta:c[2],title:d.attr("title"),caption:d.find("figcaption").html(),content:d.find(".figure_content").html(),position:d.data("position"),columns:d.data("columns"),options:d.data("options"),thumbnail_url:void 0,type:d.data("figure_type"),aspect:d.data("aspect"),order:d.data("order"),count:d.data("count")};if(e.options.previewUri)e.thumbnail_url=e.options.previewUri,e.preview_url=e.options.previewUri;else{var f=d.children("img.thumbnail").remove();if(f.length)e.thumbnail_url=f.attr("src"),e.preview_url=f.attr("src");else{var g=$(".figure_content img",a);g.length&&(e.thumbnail_url=g.attr("src"),e.preview_url=g.attr("src"))}}b.push(e)},this),this.reset(b)}}),OsciTk.collections.NavigationItems=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.NavigationItem,currentNavigationItem:null,initialize:function(){this.listenTo(Backbone,"packageLoaded",function(a){var b=_.find(a.get("manifest").item,function(a){return"nav"==a.properties});if(b){for(var c=xmlToJson(loadXMLDoc(b.href)),d=c.html.body.nav,e=0,f=d.length;f>e;e++)if("toc"==d[e].type){var g=d[e].ol;this.parseChildren(g,null,0);break}Backbone.trigger("navigationLoaded",this)}})},parseChildren:function(a,b,c){_.isArray(a)===!1&&(a=[a]);for(var d=0,e=a.length;e>d;d++){var f=a[d];if(f.a){var g={id:f.a["data-section_id"],parent:b,depth:c,previous:this.at(this.length-1)||null,next:null,length:f.a["data-length"]||null,title:f.a.value,subtitle:f.a["data-subtitle"],thumbnail:f.a["data-thumbnail"],timestamp:f.a["data-timestamp"],uri:f.a.href};this.add(g);var h=this.at(this.length-1);if(null!==h.get("previous")&&h.get("previous").set("next",h),f.ol&&f.ol.li){var i;i=f.ol.li.length?f.ol.li:[f.ol.li];for(var j=c+1,k=0,l=i.length;l>k;k++)this.parseChildren(i[k],h,j)}}f.li&&this.parseChildren(f.li,b,c)}}}),OsciTk.collections.Footnotes=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Footnote,initialize:function(){this.listenTo(Backbone,"footnotesAvailable",function(a){this.populateFromMarkup(a),Backbone.trigger("footnotesLoaded",this)})},populateFromMarkup:function(a){this.reset();for(var b=a.find("aside"),c=b.length,d=[],e=0;c>e;e++){var f=b[e],g=f.id.match(/\w+-(\d+)-(\d+)/);d.push({id:f.id,rawData:f,body:f.innerHTML,section_id:g[1],delta:g[2],index:f.getAttribute("data-footnote_index")})}this.reset(d)}}),OsciTk.collections.Notes=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Note,initialize:function(){this.listenTo(Backbone,"currentNavigationItemChanged",function(a){a.id&&this.getNotesForSection(a.id)})},parse:function(a){return a.success?a.notes:!1},getNotesForSection:function(a){$.ajax({url:app.config.get("endpoints").OsciTkNote,data:{section_id:a},type:"GET",dataType:"json",success:function(a){a.success===!0&&(app.collections.notes.reset(a.notes),Backbone.trigger("notesLoaded",app.collections.notes))}})}}),OsciTk.collections.Pages=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Page}),OsciTk.collections.GlossaryTerms=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.GlossaryTerm,initialize:function(){this.listenTo(Backbone,"packageLoaded",this.parseGlossary)},parseGlossary:function(a){var b=_.find(a.get("manifest").item,function(a){return"glossary"===a.id});if(b){var c=loadXMLDoc(b.href);if(null===c)return;var d=$(c).find("dd"),e=$(c).find("dt");if(d.length>0&&e.length>0)for(var f=0,g=e.length;g>f;f++){var h={id:$(e[f]).attr("data-tid"),term:$(e[f]).find("dfn:first").html(),definition:this.html_entity_decode($(d[f]).html())};this.add(h)}}Backbone.trigger("osci.glossary.loaded",this)},filterByKeyword:function(a){var b=new RegExp("\\b"+a,"gi");return _.filter(this.models,function(a){return-1!==a.get("term").search(b)})},get_html_translation_table:function(a,b){var c,d={},e={},f={},g={},h={},i={};if(f[0]="HTML_SPECIALCHARS",f[1]="HTML_ENTITIES",g[0]="ENT_NOQUOTES",g[2]="ENT_COMPAT",g[3]="ENT_QUOTES",h=isNaN(a)?a?a.toUpperCase():"HTML_SPECIALCHARS":f[a],i=isNaN(b)?b?b.toUpperCase():"ENT_COMPAT":g[b],"HTML_SPECIALCHARS"!==h&&"HTML_ENTITIES"!==h)throw new Error("Table: "+h+" not supported");d[38]="&amp;","HTML_ENTITIES"===h&&(d[160]="&nbsp;",d[161]="&iexcl;",d[162]="&cent;",d[163]="&pound;",d[164]="&curren;",d[165]="&yen;",d[166]="&brvbar;",d[167]="&sect;",d[168]="&uml;",d[169]="&copy;",d[170]="&ordf;",d[171]="&laquo;",d[172]="&not;",d[173]="&shy;",d[174]="&reg;",d[175]="&macr;",d[176]="&deg;",d[177]="&plusmn;",d[178]="&sup2;",d[179]="&sup3;",d[180]="&acute;",d[181]="&micro;",d[182]="&para;",d[183]="&middot;",d[184]="&cedil;",d[185]="&sup1;",d[186]="&ordm;",d[187]="&raquo;",d[188]="&frac14;",d[189]="&frac12;",d[190]="&frac34;",d[191]="&iquest;",d[192]="&Agrave;",d[193]="&Aacute;",d[194]="&Acirc;",d[195]="&Atilde;",d[196]="&Auml;",d[197]="&Aring;",d[198]="&AElig;",d[199]="&Ccedil;",d[200]="&Egrave;",d[201]="&Eacute;",d[202]="&Ecirc;",d[203]="&Euml;",d[204]="&Igrave;",d[205]="&Iacute;",d[206]="&Icirc;",d[207]="&Iuml;",d[208]="&ETH;",d[209]="&Ntilde;",d[210]="&Ograve;",d[211]="&Oacute;",d[212]="&Ocirc;",d[213]="&Otilde;",d[214]="&Ouml;",d[215]="&times;",d[216]="&Oslash;",d[217]="&Ugrave;",d[218]="&Uacute;",d[219]="&Ucirc;",d[220]="&Uuml;",d[221]="&Yacute;",d[222]="&THORN;",d[223]="&szlig;",d[224]="&agrave;",d[225]="&aacute;",d[226]="&acirc;",d[227]="&atilde;",d[228]="&auml;",d[229]="&aring;",d[230]="&aelig;",d[231]="&ccedil;",d[232]="&egrave;",d[233]="&eacute;",d[234]="&ecirc;",d[235]="&euml;",d[236]="&igrave;",d[237]="&iacute;",d[238]="&icirc;",d[239]="&iuml;",d[240]="&eth;",d[241]="&ntilde;",d[242]="&ograve;",d[243]="&oacute;",d[244]="&ocirc;",d[245]="&otilde;",d[246]="&ouml;",d[247]="&divide;",d[248]="&oslash;",d[249]="&ugrave;",d[250]="&uacute;",d[251]="&ucirc;",d[252]="&uuml;",d[253]="&yacute;",d[254]="&thorn;",d[255]="&yuml;"),"ENT_NOQUOTES"!==i&&(d[34]="&quot;"),"ENT_QUOTES"===i&&(d[39]="&#39;"),d[60]="&lt;",d[62]="&gt;";for(c in d)d.hasOwnProperty(c)&&(e[String.fromCharCode(c)]=d[c]);return e},html_entity_decode:function(a,b){var c={},d="",e="",f="";if(e=a.toString(),!1===(c=this.get_html_translation_table("HTML_ENTITIES",b)))return!1;delete c["&"],c["&"]="&amp;";for(d in c)f=c[d],e=e.split(f).join(d);return e=e.split("&#039;").join("'")}}),OsciTk.views.BaseView=Backbone.View.extend({getChildViews:function(){return this.childViews||(this.childViews=[]),this.childViews},addView:function(a,b){return a.parent=this,"undefined"==typeof b?this.$el.append(a.el):this.$el.find(b).append(a.el),this._addViewReference(a),this},removeAllChildViews:function(){if(this.childViews){for(var a=0,b=this.childViews.length;b>a;a++)this.childViews[a].close();this.childViews=[]}return this},removeView:function(a,b){if(this.childViews)for(var c=0,d=this.childViews.length;d>c;c++)if(a.cid===this.childViews[c].cid){this.childViews.splice(c,1),a.$el.detach(),(b||void 0===b)&&a.close();break}return this},getChildViewById:function(a){var b;if(this.childViews)for(var c=0,d=this.childViews.length;d>c;c++)if(a===this.childViews[c].cid){b=this.childViews[c];break}return b},getChildViewByIndex:function(a){var b;return this.childViews&&this.childViews[a]&&(b=this.childViews[a]),b},getChildViewsByType:function(a){return _.filter(this.childViews,function(b){return b.$el.is(a)})},replaceView:function(a,b){return a.parent=this,"undefined"==typeof b?this.$el.html(a.el):this.$el.find(b).html(a.el),this._addViewReference(a),this},changeModel:function(a){return this.model=a,this},close:function(){this.removeAllChildViews(),this.remove(),this.unbind(),this.undelegateEvents(),this.onClose&&this.onClose()},_addViewReference:function(a){this.childViews||(this.childViews=[]);for(var b=!1,c=0,d=this.childViews.length;d>c;c++)if(a.cid===this.childViews[c].cid){b=!0;break}b||this.childViews.push(a)}}),OsciTk.views.App=OsciTk.views.BaseView.extend({id:"reader",template:OsciTk.templateManager.get("app"),initialize:function(){this.render(),app.toolbarItems=app.config.get("toolbarItems")?app.config.get("toolbarItems"):[],app.views={headerView:new OsciTk.views.Header,sectionView:new OsciTk.views.Section,footnotesView:new OsciTk.views.Footnotes,navigationView:new OsciTk.views.Navigation,toolbarView:new OsciTk.views.Toolbar,paragraphControlsView:new OsciTk.views.ParagraphControls,glossaryTooltipView:new OsciTk.views.GlossaryTooltip,notesView:new OsciTk.views.Notes,accountView:new OsciTk.views.Account,navbarView:new OsciTk.views.Navbar,fontSizeView:new OsciTk.views.FontSize,printView:new OsciTk.views.Print,tocView:new OsciTk.views.Toc},this.addView(app.views.headerView,"#header"),this.addView(app.views.toolbarView,"#toolbar"),this.addView(app.views.navbarView,"#navbar"),this.addView(app.views.sectionView,"#section"),this.addView(app.views.navigationView,"#navigation"),this.listenTo(Backbone,"toolbarInline",function(a){this.toolbarInline(a)}),this.listenTo(Backbone,"toolbarItemClicked",function(a,b){this.toolbarAction(a)}),this.listenTo(Backbone,"toolbarRemoveViews",function(){this.toolbarToggle()})},render:function(){this.$el.html(this.template),$("body").append(this.el)},toolbarInline:function(a){var b=_.pick(app.views,a.view);b=b[a.view],this.removeView(b,!1),this.addView(b,"#"+a.text)},toolbarAction:function(a){if(this.toolbarToggle(),!a.active){var b=_.pick(app.views,a.item.view);b=b[a.item.view],this.addView(b,"#"+a.item.text)}},toolbarToggle:function(){_.each(app.toolbarItems,function(a){if($("."+a.view+"-toolbar-item > a").removeClass("active"),"default"==a.style){var b=_.pick(app.views,a.view);b=b[a.view],this.removeView(b,!1)}},this)}}),OsciTk.views.Section=OsciTk.views.BaseView.extend({id:"section-view",template:OsciTk.templateManager.get("section"),events:{scroll:"updateProgress","click .paragraph-button":"paragraphButtonClicked","click .note-submit":"noteSubmit"},initialize:function(){_.bindAll(this,"updateProgress");$(window).scroll(this.updateProgress),this.maxHeightSet=!1,this.$container=$("#container-container"),this.listenTo(Backbone,"currentNavigationItemChanged",function(a){$("#determineWidth").remove(),$("#section-view").empty(),$(".header-view").empty(),this.$container.css("opacity",0),$("#loader").show(),a&&(app.models.section=new OsciTk.models.Section({uri:a.get("uri"),id:a.get("id")}),this.changeModel(app.models.section),app.models.section.loadContent())}),this.listenTo(Backbone,"sectionRenderEnd",function(){$("#loader").hide(),this.$container.css("opacity",1)}),this.listenTo(Backbone,"setSectionColumns",function(a){$("#section").attr("data-columns-setting",a),setTimeout(function(){Backbone.trigger("windowResized")},25)}),this.listenTo(Backbone,"windowResized",function(){this.renderColumns()}),this.listenTo(Backbone,"sectionLoaded",function(a){this.content=a.get("content")[0].children.body,this.makeIds(a),this.sectionId=a.get("id"),this.getSectionTitles(this.sectionId),this.render()})},renderColumns:function(){var a,b,c,d,e=this.$el,f=this.$el.parent(),g=0,h=40;Backbone.trigger("sectionRenderStart"),e.css({"-webkit-column-gap":h,"-moz-column-gap":h,"column-gap":h}),a=f.attr("data-columns-setting"),a="undefined"==typeof a?2:parseInt(a),a=$(window).width()<768?1:a,f.attr("data-columns-rendered",a),e.css({"-webkit-column-width":"auto","-moz-column-width":"auto","column-width":"auto","-webkit-column-count":"auto","-moz-column-count":"auto","column-count":"auto",width:"auto",height:"auto"}),b=f.width(),c=b/a-h/2,$("#default-section-view").css({"-webkit-column-width":c,"-moz-column-width":c,"column-width":c});var i=this;this.$el.find("figure").each(function(a,b){var d=$("#section"),e=null,f=$(b),h=f.find(".figure_content"),j=h.find("object"),k=j.find("img"),l=f.find("figcaption");f.parent().attr("id")!==f.attr("id")+"-wrapper"&&(e=$("<div></div>").attr("id",f.attr("id")+"-wrapper"),e.addClass("figure-wrapper"),e.addClass("noSwipe"),f.wrap(e)),e=f.parent(),e.css({width:c,height:d.innerHeight()-g}),f.css({height:e.innerHeight(),width:"auto"});var m=detectIE();m&&e.css({"float":"none"}),m?l.css({position:"relative"}):l.css({bottom:0}),setTimeout(function(){var a=detectIE();a&&l.css({position:"relative"})},250),h.css({height:f.innerHeight()-l.outerHeight(!0)-(m?80:10),width:"auto"}),k.css({height:h.innerHeight(),width:"auto"});var n=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;n&&h.before(l);var o=f.find("object").attr("data");void 0!==o&&$.ajax({url:o,type:"GET",dataType:"html",success:function(a){var b=$(a).filter(".layered_image-asset").first(),c=f.find(".figure_content");c.empty(),b.appendTo(c);var d=new window.LayeredImage(b);i.listenTo(Backbone,"windowResized",function(a){setTimeout(function(){d.map.resize();try{d.resetZoomRange(),d.reset(),d.map.resize()}catch(a){}},100)}),i.listenTo(Backbone,"windowResized",function(a){var b=navigator.userAgent.toLowerCase().indexOf("chrome")>-1;b&&$(".figure-wrapper").each(function(a,b){var c=$(this);c.prev().before(c),c.next().after(c)})})}})});var d=0,j=-1,k=a;do e.css({"-webkit-column-count":k.toString(),"-moz-column-count":k.toString(),"column-count":k.toString()}),e.width(k*c+(k-1)*h),j=d,d=this.$el.height(),k+=1;while(d>f.height()&&d!==j);var l=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);l&&($(".figure-wrapper").css("height",""),$(".figure-wrapper").css("-webkit-column-break-inside","auto")),Backbone.trigger("sectionRenderEnd"),$("img").imagesLoaded(function(){Backbone.trigger("navigateReady")})},render:function(){return this.model.removeAllPages(),this.removeAllChildViews(),this.$el.html(this.template({sectionTitle:this.sectionTitle,sectionSubtitle:this.sectionSubtitle,content:$(this.content).html()})),Backbone.trigger("layoutComplete"),$("#section").imagesLoaded(function(){Backbone.trigger("windowResized")}),this},getSectionTitles:function(a){_.each(app.collections.navigationItems.models,function(b){b.get("id")==a&&(this.sectionTitle=b.get("title"),this.sectionSubtitle=b.get("subtitle"))},this),this.render()},updateProgress:function(){var a=$(document).scrollLeft(),b=this.$el.innerWidth();b-=$(window).width();var c=a/b*100;$(".progress .progress-bar").attr("data-max",b),$(".progress .progress-bar").attr("data-now",a),$(".progress .progress-bar").attr("style","width: "+c+"%")},getPrefixedStyle:function(a){var b=["Webkit","Moz","O","ms"],c=a[0].toUpperCase()+a.slice(1),d=b.length;if("undefined"!=typeof document.body.style[a])return a=a.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase(),"-"+a;for(var e=0;d>e;e++)if("undefined"!=typeof document.body.style[b[e]+c])return a=b[e]+c,a=a.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase(),"-"+a;return a=a.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase(),"-"+a},makeIds:function(a){var b=a.get("content")[0].children.body;this.content=b;var c=0,d=1;_.each(this.content.children,function(a){$(a).is("p")&&($(a).attr({"data-paragraph_number":d,"data-osci_content_id":"osci-content-"+d,"data-sectionid":"body",id:"osci-content-"+d}).addClass("content-paragraph"),d++),c++},this)},paragraphButtonClicked:function(a){var b=$(a.currentTarget),c=b.data("paragraph_number");Backbone.trigger("paragraphButtonClicked",c)},noteSubmit:function(a){var b=$(a.currentTarget).parent().find("textarea"),c=b.val(),d=b.data("id"),e=b.data("paragraph_number"),f=app.collections.notes.get(d);f.set("note",c),""===c?(f.destroy(),$("#paragraph-"+e).removeClass("withNotes").click()):(f.save(),$("#paragraph-"+e).addClass("withNotes").click())}}),OsciTk.views.ParagraphControls=OsciTk.views.BaseView.extend({template:OsciTk.templateManager.get("paragraph-popover"),templateNotes:OsciTk.templateManager.get("paragraph-notes"),templateCites:OsciTk.templateManager.get("paragraph-cite"),initialize:function(){this.sectionLoaded=!1,this.notesLoaded=!1,this.userLogged=!1,this.section_id=null,this.paragraphs=null,this.listenTo(Backbone,"routedToSection",function(a){$('[id^="paragraph-"]').popover("destroy"),a.section_id!==this.section_id&&(this.sectionLoaded=!1,this.notesLoaded=!1,this.section_id=a.section_id)}),this.listenTo(Backbone,"sectionLoaded",function(){this.sectionLoaded=!0,this.render()}),this.listenTo(Backbone,"layoutComplete",function(){this.section_id=app.models.section.get("id"),this.render()}),this.listenTo(Backbone,"notesLoaded",function(a){this.notesLoaded=!0,this.render()}),this.userLogged=app.account.get("id")>0,this.listenTo(Backbone,"accountReady accountStateChanged",function(){$('[id^="paragraph-"]').popover("destroy"),this.userLogged=app.account.get("id")>0,this.notesLoaded=this.notesLoaded?this.userLogged:this.notesLoaded,this.render()}),this.listenTo(Backbone,"paragraphButtonClicked",function(a){this.togglePopover(a)}),this.listenTo(Backbone,"navigate windowResized",function(){$('[id^="paragraph-"]').popover("destroy")})},render:function(){if(this.userLogged&&this.sectionLoaded&&!this.notesLoaded){var a=app.models.section.id;app.collections.notes.getNotesForSection(a)}return this.sectionLoaded&&(this.paragraphs=$(".content-paragraph"),this.addParagraphControls()),this},addParagraphControls:function(){var a=1;_.each(this.paragraphs,function(b){$('.paragraph-controls[data-osci_content_id="osci-content-'+a+'"]').remove();var c="";if(this.userLogged&&this.notesLoaded){var d=this.checkForNote({content_id:"osci-content-"+a,section_id:this.section_id,paragraph_number:a});c=d.get("note")?"withNotes":""}$(b).prepend('<div class="paragraph-controls hidden-print" data-osci_content_id="osci-content-'+a+'" data-paragraph_identifier="'+a+'" ><button class="btn btn-link '+c+' btn-xs paragraph-button" type="button" id="paragraph-'+a+'" data-paragraph_number="'+a+'"><span class="paragraph-identifier" paragraph-identifier="'+a+'">'+a+"</span></button></div>"),a++},this)},togglePopover:function(a){var b=!1;if(this.notesLoaded&&this.userLogged){var c=this.checkForNote({content_id:"osci-content-"+a,section_id:this.section_id,paragraph_number:a}),d=c?c.get("note"):"";d=null===d?"":d;var b=({id:a,cid:c.cid,noteText:d,sectionId:this.section_id,contentId:"osci-content-"+a,paragraph_number:a},this.templateNotes({paragraph_number:c.get("paragraph_number"),note:d,cid:c.cid}))}var e="right",f=this.template({noteForm:b,citation:this.citation});$("#paragraph-"+a).popover({html:!0,trigger:"manual",placement:e,container:"body",content:f});var g=this;$("#paragraph-"+a).on("shown.bs.popover",function(b){g.getCitation(a),$("#"+$(this).attr("aria-describedby")).find("textarea").focus(),$("#note-submit").on("click",function(a){g.noteSubmit(a)});var c=function(b){$target=$(b.target),$button=$("#paragraph-"+a),$popover=$("#"+$button.attr("aria-describedby")),$target.get(0)!==$popover.get(0)&&($popover.find($target).length<1?$button.popover("destroy"):$("html").one("click",c))};$("html").one("click",c)}),$("#paragraph-"+a).popover("toggle");var h=1;_.each(this.paragraphs,function(b){a!=h&&$("#paragraph-"+h).popover("destroy"),h++},this)},checkForNote:function(a){var b,c=app.collections.notes.where({content_id:a.content_id});return c[0]?(b=c[0],""===b.get("note")&&b.destroy()):(b=new OsciTk.models.Note({content_id:a.content_id,section_id:a.section_id,paragraph_number:a.paragraph_number}),app.collections.notes.add(b)),b},getCitation:function(a){var b=this,c="osci-content-"+a,d=$("#"+c),e={section_id:app.models.section.get("id"),publication_id:app.models.docPackage.get("id"),element_id:c,field:"body"};$.ajax({url:app.config.get("endpoints").OsciTkCitation,data:e,success:function(a,c){if(a.success){a.citation.referenceText=d.text(),a.citation.paragraphNumber=d.data("paragraph_number"),a.citation.date=new Date(a.citation.date),a.citation.formattedDate=a.citation.date.getMonth()+1+"/"+a.citation.date.getDate()+"/"+a.citation.date.getFullYear();var e=document.location.href.match(/(^[^#]*)/)[0];e+="#section/"+app.models.section.get("id"),e+="/p-"+d.data("paragraph_number"),a.citation.url=e,a.citation.creator=a.citation.creator?a.citation.creator:"",a.citation.description=a.citation.description?a.citation.description:"",a.citation.editor=a.citation.editor?a.citation.editor:"",a.citation.publicationTitle=a.citation.publicationTitle?a.citation.publicationTitle:"",a.citation.publisher=a.citation.publisher?a.citation.publisher:"",a.citation.rights=a.citation.rights?a.citation.rights:"",a.citation.title=a.citation.title?a.citation.title:"",$("#cite-target").html(b.templateCites(a.citation))}}})},noteSubmit:function(a){var b=$(a.currentTarget).parent().find("textarea"),c=b.val(),d=b.data("id"),e=b.data("paragraph_number"),f=app.collections.notes.get(d);f.set("note",c),""!==$.trim(c)?(f.save(),b.html(c),$("#paragraph-"+e).addClass("withNotes")):(f.destroy(),$("#paragraph-"+e).removeClass("withNotes")),$("#paragraph-"+e).popover({content:function(){return $("#popover-content").html()}}),$("#paragraph-"+e).popover("destroy")}}),OsciTk.views.Toolbar=OsciTk.views.BaseView.extend({id:"toolbar-view",template:OsciTk.templateManager.get("toolbar"),initialize:function(){this.activeToolbarItemView=void 0,this.listenTo(Backbone,"packageLoaded",function(a){this.title=a.getTitle()}),this.listenTo(Backbone,"figuresAvailable",function(a){this.figureSize=a.size(),this.render()})},render:function(){this.$el.html(this.template({title:this.title})),_.each(app.toolbarItems,function(a){if("figures"!=a.text||0!=this.figureSize){var b=new OsciTk.views.ToolbarItem({toolbarItem:a});this.addView(b,"#toolbar-area"),b.render()}},this)}}),OsciTk.views.ToolbarItem=OsciTk.views.BaseView.extend({tagName:"li",className:"toolbar-item-view",template:OsciTk.templateManager.get("toolbar-item"),events:{click:"itemClicked",touch:"itemClicked"},initialize:function(a){this.options=a,this.$el.addClass(this.options.toolbarItem.view+"-toolbar-item"),this.$el.attr("data-href",this.options.toolbarItem.text),this.$el.attr("data-style",this.options.toolbarItem.style)},render:function(){return this.$el.html(this.template({text:this.options.toolbarItem.text,style:this.options.toolbarItem.style})),"default"!=this.options.toolbarItem.style&&Backbone.trigger("toolbarInline",this.options.toolbarItem),this},itemClicked:function(a){a.preventDefault(),a.stopPropagation(),this.setActiveStates(a)},setActiveStates:function(a){this.e=a,this.view=app.views.toolbarView,this.$target=$(a.target),this.href=$(a.target).data("href"),this.style=$(a.target).data("style"),"default"!=this.style&&Backbone.trigger("toolbarInlineClicked",this.href),this.active=this.$target.hasClass("active"),this.$target.toggleClass("active"),this.$targetCheck=$(a.currentTarget),_.each(app.toolbarItems,function(a){0==this.$targetCheck.hasClass(a.view+"-toolbar-item")&&this.view.$el.find("li."+a.view+"-toolbar-item>a").removeClass("active")},this),Backbone.trigger("toolbarItemClicked",{item:this.options.toolbarItem,active:this.active})}}),OsciTk.views.Footnotes=OsciTk.views.BaseView.extend({id:"footnote-view",initialize:function(){this.listenTo(Backbone,"layoutComplete",function(a){$("a.footnote-reference").qtip({content:{title:null,text:" "},position:{viewport:$(window)},style:{classes:"glossary-tooltip",def:!1,width:"200px",tip:{color:"#6699CC"}},events:{show:function(a,b){var c=$(a.originalEvent.target).attr("href").slice(1),d=app.collections.footnotes.get(c);b.set("content.text",$(d.get("body")).text())}}}).click(function(a){a.preventDefault(),a.stopPropagation();
})})}}),OsciTk.views.Header=OsciTk.views.BaseView.extend({className:"header-view",template:OsciTk.templateManager.get("header"),events:{"click #skip-header":"skipHeader"},initialize:function(){this.listenTo(Backbone,"packageLoaded",function(a){this.creator=$(a)[0].attributes.metadata["dc:creator"],this.pubTitle=a.getTitle()}),this.listenTo(Backbone,"sectionLoaded",function(a){this.sectionTitle=null,this.sectionSubtitle=null,this.sectionThumbnail=null,this.headerImage=null,this.headerImageCaption=null;var b=a.get("id");this.render(b)})},render:function(a){return _.each(app.collections.navigationItems.models,function(b){b.get("id")==a&&(this.sectionTitle=b.get("title"),this.sectionSubtitle=b.get("subtitle"),this.sectionThumbnail=b.get("thumbnail"))}),_.isEmpty(app.collections.figures.models)?(this.headerImage=null,this.headerImageCaption=null):_.each(app.collections.figures.models,function(a){1==a.get("plate")&&(this.headerImage=a.get("preview_url"),this.headerImageCaption=a.get("caption"))}),this.$el.html(this.template({creator:this.creator,title:this.pubTitle,sectionTitle:this.sectionTitle,sectionSubtitle:this.sectionSubtitle})),this},skipHeader:function(a){a.preventDefault();var b=$(window).width();$("body").animate({scrollLeft:b},800)}}),OsciTk.views.Navigation=OsciTk.views.BaseView.extend({id:"navigation-view",template:OsciTk.templateManager.get("navigation"),events:{"click li a":"itemClick"},initialize:function(){this.currentNavigationItem=null,this.listenTo(Backbone,"layoutComplete",function(a){this.render()}),this.listenTo(Backbone,"routedToSection",function(a){var b=!0,c=!1;if(a.section_id)null===this.getCurrentNavigationItem()?(this.setCurrentNavigationItem(a.section_id),c=!0):a.section_id!==this.getCurrentNavigationItem().get("id")?this.setCurrentNavigationItem(a.section_id):b=!1;else{var d=app.collections.navigationItems.at(0).id;app.router.navigate("section/"+d,{trigger:!1}),this.setCurrentNavigationItem(d),c=!0}"undefined"!=typeof a.identifier?a.identifier.length>0&&(b?this.listenToOnce(Backbone,"navigateReady",function(){Backbone.trigger("navigate",{identifier:a.identifier})}):Backbone.trigger("navigate",{identifier:a.identifier})):b&&!c&&this.listenToOnce(Backbone,"navigateReady",function(){$("body").scrollLeft($(window).width())}),this.setDocumentTitle()}),this.listenTo(Backbone,"packageLoaded",function(a){this.creator=$(a)[0].attributes.metadata["dc:creator"],this.pubTitle=a.getTitle(),this.sections=app.collections.navigationItems.where({depth:0})}),this.listenTo(Backbone,"navigate",function(a){var b=0,c=!1;if(a.identifier)switch(a.identifier){case"end":app.router.navigate("section/"+this.getCurrentNavigationItem().get("id"),{trigger:!1}),b=1;break;case"start":b=0;break;default:if(a.identifier.search(/^p-[0-9]+/)>-1){var d=a.identifier.slice(a.identifier.lastIndexOf("-")+1,a.identifier.length);c="p#osci-content-"+d,b=this.getPageForSelector(c);break}if(a.identifier.search(/^fig-[0-9]+-[0-9]+$/)>-1){var e=a.identifier;c="#"+e,b=this.getPageForSelector(c);break}c=a.identifier,b=this.getPageForSelector(a.identifier)}var f=b*$(document).width();f-=$(window).width()/2,f=Math.max(0,f),c&&(f+=$(c).innerWidth()/2,$(".navigating").removeClass("navigated"),$(c).addClass("navigated"),$(c).addClass("navigating"),setTimeout(function(){$(c).removeClass("navigating")},1e3)),$(window).scrollLeft(f)})},render:function(){this.$el.html(this.template({chapter:this.currentNavigationItem.get("title"),previousItem:this.currentNavigationItem.get("previous"),nextItem:this.currentNavigationItem.get("next"),sections:this.sections}))},getPageForSelector:function(a){var b=$(a);return b.length>0?b.offset().left/$(document).width():0},setDocumentTitle:function(){var a=app.models.docPackage.getTitle();a=a?a+" | ":"",a+=this.getCurrentNavigationItem().get("title"),document.title=a},getCurrentNavigationItem:function(){return this.currentNavigationItem},setCurrentNavigationItem:function(a){var b=app.collections.navigationItems,c=b.get(a);this.currentNavigationItem=c?c:b.first(),Backbone.trigger("currentNavigationItemChanged",this.currentNavigationItem)},itemClick:function(a){a.preventDefault();var b=$(a.currentTarget).attr("data-section-id");$("li.tocView-toolbar-item>a").removeClass("active"),Backbone.trigger("toolbarRemoveViews"),setTimeout(function(){app.router.navigate("section/"+b,{trigger:!0})},500)}}),OsciTk.views.Navbar=OsciTk.views.BaseView.extend({className:"navbar-view",template:OsciTk.templateManager.get("navbar"),events:{"click li a":"itemClick"},initialize:function(){this.listenTo(Backbone,"packageLoaded",function(a){this.creator=$(a)[0].attributes.metadata["dc:creator"],this.pubTitle=a.getTitle(),this.sections=app.collections.navigationItems.where({depth:0})}),this.listenTo(Backbone,"currentNavigationItemChanged",function(){this.render()})},render:function(){return this.$el.html(this.template({title:this.pubTitle,sections:this.sections})),$('.navbar-item[data-toggle="tooltip"]').tooltip({container:".navbar-item[aria-describedby]"}),this},itemClick:function(a){a.preventDefault();var b=$(a.currentTarget).attr("data-section-id");$("li.tocView-toolbar-item>a").removeClass("active"),Backbone.trigger("toolbarRemoveViews"),app.router.navigate("section/"+b,{trigger:!0})}}),OsciTk.views.Notes=OsciTk.views.BaseView.extend({className:"notes-view",template:OsciTk.templateManager.get("notes"),events:{"click .noteLink":"noteLinkClick"},initialize:function(){this.listenTo(app.collections.notes,"add remove change",function(){this.render()})},render:function(){var a=this.getSavedNotes();return this.$el.html(this.template({notes:a})),this.active(),this},noteLinkClick:function(a){a.preventDefault();var b=$(a.target),c=b.attr("data-content_id");c&&(Backbone.trigger("navigate",{identifier:c}),Backbone.trigger("toggleNoteDialog",{contentId:c}),$("#"+c).click(),app.views.toolbarView.contentClose())},getSavedNotes:function(){var a=_.filter(app.collections.notes.models,function(a){return null!==a.id?!0:!1});return a},active:function(){if(app.collections.notes.length>1){var a=this.$el.find(".notesListItem");this.$el.find(".notesList").width(a.length*a.first().outerWidth(!0))}}}),OsciTk.views.Citation=OsciTk.views.BaseView.extend({template:OsciTk.templateManager.get("paragraph-citation"),initialize:function(a){this.render(a)},render:function(a){var b=this,c=a.contentId,d=$("#"+c),e={section_id:app.models.section.get("id"),publication_id:app.models.docPackage.get("id"),element_id:a.contentId,field:d.attr("data-sectionId")};console.log(e),$.ajax({url:app.config.get("endpoints").OsciTkCitation,data:e,success:function(a,c){a.success&&(a.citation.referenceText=d.text(),a.citation.url=document.URL+"/p-"+app.models.section.get("id")+"-"+d.data("paragraph_number"),a.citation.paragraphNumber=d.data("paragraph_number"),a.citation.date=new Date(a.citation.date),a.citation.formattedDate=a.citation.date.getMonth()+1+"/"+a.citation.date.getDate()+"/"+a.citation.date.getFullYear(),a.citation.creator=a.citation.creator?a.citation.creator:"",a.citation.description=a.citation.description?a.citation.description:"",a.citation.editor=a.citation.editor?a.citation.editor:"",a.citation.publicationTitle=a.citation.publicationTitle?a.citation.publicationTitle:"",a.citation.publisher=a.citation.publisher?a.citation.publisher:"",a.citation.rights=a.citation.rights?a.citation.rights:"",a.citation.title=a.citation.title?a.citation.title:"",$(".citation").html(b.template(a.citation)))}})}}),OsciTk.views.Account=OsciTk.views.BaseView.extend({events:{"click button.login":"login","click button.register":"register","click a.register":"showRegistrationForm","click a.login":"showLoginForm","click a.logout":"logout"},className:"account-view",templateModal:OsciTk.templateManager.get("toolbar-modal"),templateLogin:OsciTk.templateManager.get("toolbar-account-login"),templateProfile:OsciTk.templateManager.get("toolbar-account-profile"),templateRegister:OsciTk.templateManager.get("toolbar-account-register"),initialize:function(){this.$modals={};var a="login";this.listenTo(Backbone,"accountReady accountStateChanged",function(b){this.$modals={login:this.prepareLogin(b),profile:this.prepareProfile(b),register:this.prepareRegister(b)},a=app.account.get("id")>0?"profile":"login"}),this.listenTo(Backbone,"toolbarItemClicked",function(b){"toolbar-account"===b.item.text&&this.showForm(a)})},modalBindings:function(a){},showForm:function(a){this.$modals[a].clone(!0).modal().on("hidden.bs.modal",function(){$(this).data("bs.modal",null).remove()})},prepareLogin:function(a){var b=this.templateLogin(),c=this.templateModal({title:"Login",body:b}),d=$(c);a&&d.find("div.form-error").html(a);var e=this;return d.find(".login").on("click",function(a){var b=$(this).parents("#account-form"),c=b.find("#username").val(),d=b.find("#password").val();$(this).parents(".modal").modal("hide"),e.login(c,d)}),d.find(".register").on("click",function(a){$(this).parents(".modal").modal("hide"),Backbone.trigger("accountStateChanged"),e.showForm("register")}),d},prepareRegister:function(a){var b=this.templateRegister(),c=this.templateModal({title:"Register",body:b}),d=$(c);a&&d.find("div.form-error").html(a);var e=this;return d.find(".register").on("click",function(a){var b=$(this).parents("#account-form"),c=b.find("#username").val(),d=b.find("#password").val(),f=b.find("#email").val();$(this).parents(".modal").modal("hide"),e.register(c,d,f)}),d.find(".login").on("click",function(a){$(this).parents(".modal").modal("hide"),Backbone.trigger("accountStateChanged"),e.showForm("login")}),d},prepareProfile:function(a){var b=this.templateProfile({username:app.account.get("username"),email:app.account.get("email")}),c=this.templateModal({title:"User Profile",body:b}),d=$(c);a&&d.find("div.form-error").html(a);var e=this;return d.find(".logout").on("click",function(a){$(this).parents(".modal").modal("hide"),e.logout()}),d},login:function(a,b){var c=this;$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"login",username:a,password:b},type:"POST",dataType:"json",success:function(a){a.success===!0?(app.account.set({id:a.user.id,username:a.user.username,email:a.user.email}),Backbone.trigger("accountStateChanged"),c.showForm("profile")):(Backbone.trigger("accountStateChanged",a.error),c.showForm("login"))}})},logout:function(){var a=this;$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"logout"},type:"POST",dataType:"json",success:function(b){b.success===!0?(app.account.set({id:0,username:"anonymous",email:null}),Backbone.trigger("accountStateChanged"),a.showForm("login")):(Backbone.trigger("accountStateChanged",b.error),a.showForm("profile"))}})},register:function(a,b,c){var d=this;$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"register",username:a,password:b,email:c},type:"POST",dataType:"json",success:function(a){a.success===!0?(app.account.set(a.user),Backbone.trigger("accountStateChanged"),d.showForm("profile")):(Backbone.trigger("accountStateChanged",a.error),d.showForm("register"))}})}}),OsciTk.views.Toc=OsciTk.views.BaseView.extend({className:"toc-view",template:OsciTk.templateManager.get("toolbar-toc"),templateModal:OsciTk.templateManager.get("toolbar-modal"),initialize:function(){this.listenToOnce(Backbone,"sectionLoaded",function(){var a=this.template({items:app.collections.navigationItems.where({depth:0})}),b=this.templateModal({title:"Table of Contents",body:a}),c=$(b);c.find("li.toc-item>a").on("click",this.itemClick),this.listenTo(Backbone,"toolbarItemClicked",function(a){"toc"===a.item.text&&c.modal()})})},itemClick:function(a){var b=$(a.currentTarget).attr("data-section-id");$("li.tocView-toolbar-item>a").removeClass("active"),Backbone.trigger("toolbarRemoveViews"),app.router.navigate("section/"+b,{trigger:!0})}}),OsciTk.views.Print=OsciTk.views.BaseView.extend({className:"print-view",template:OsciTk.templateManager.get("toolbar-print"),initialize:function(){this.render(),this.listenTo(Backbone,"toolbarInlineClicked",function(a){this.triggerPrint(a)})},render:function(){return this.$el.html(this.template()),this},triggerPrint:function(a){"print"===a&&window.print()}}),OsciTk.views.FontSize=OsciTk.views.BaseView.extend({className:"font-size-view",template:OsciTk.templateManager.get("toolbar-font-size"),initialize:function(){this.currentFontSize=100,this.listenTo(Backbone,"toolbarInlineClicked",function(a){this.changeFontSize(a)}),this.render()},render:function(){return this.$el.html(this.template()),this},changeFontSize:function(a){var b=app.views.sectionView;"font-larger"===a&&this.currentFontSize<"200"&&(this.currentFontSize+=10),"font-smaller"===a&&this.currentFontSize>"50"&&(this.currentFontSize-=10),b.$el.css({"font-size":this.currentFontSize+"%"}),Backbone.trigger("windowResized")}}),OsciTk.views.GlossaryTooltip=OsciTk.views.BaseView.extend({initialize:function(){this.listenTo(Backbone,"sectionLoaded",function(){app.collections.glossaryTerms&&0!==app.collections.glossaryTerms.length&&$(".glossary-term").qtip({content:{title:" ",text:" "},position:{viewport:$(window)},style:{classes:"glossary-tooltip",def:!1,width:"200px",tip:{color:"#6699CC"}},events:{show:function(a,b){var c=$(a.originalEvent.target).data("tid"),d=app.collections.glossaryTerms.get(c);b.set("content.title",d.get("term")),b.set("content.text",$(d.get("definition")).text())}}}).click(function(a){a.preventDefault(),a.stopPropagation()})})}}),app={router:void 0,config:void 0,views:{},models:{},collections:{},bootstrap:function(a){this.config=new OsciTk.models.Config(a),this.router=new OsciTk.router,this.features=this.config.get("themeFeatures"),this.collections.figures=new OsciTk.collections.Figures,this.collections.footnotes=new OsciTk.collections.Footnotes,this.collections.navigationItems=new OsciTk.collections.NavigationItems,this.features.notes&&(this.collections.notes=new OsciTk.collections.Notes),this.features.account&&(this.account=new OsciTk.models.Account),this.features.glossary&&(this.collections.glossaryTerms=new OsciTk.collections.GlossaryTerms),window.onresize=function(){window.resizeTimer&&clearTimeout(window.resizeTimer);var a=function(){Backbone.trigger("windowResized")};window.resizeTimer=setTimeout(a,200)},this.views.app=new OsciTk.views.App},run:function(){this.models.docPackage=new OsciTk.models.Package({url:this.config.get("packageUrl")}),Backbone.history.start()}};