function outerHTML(a){return a.outerHTML||function(a){var b,c=document.createElement("div");return c.appendChild(a.cloneNode(!0)),b=c.innerHTML,c=null,b}(a)}function liMousemove(a){if(window.liCollection&&liCollection.userIsDraggingAsset){var b=liCollection.find(liCollection.userIsDraggingAsset);if(b){if(!b.settings.dragging)return;b.refreshViewfinderViewport(),a.conservationDraggingRemove&&(b.settings.dragging=void 0,liCollection.userIsDraggingAsset=!1)}}}function liMouseup(a){window.liCollection&&liCollection.userIsDraggingAsset&&(a.conservationDraggingRemove=!0,liMousemove(a))}function loadXMLDoc(a){var b=new XMLHttpRequest;return b.overrideMimeType&&b.overrideMimeType("text/xml"),b.open("GET",a,!1),b.send(),b.responseXML}function loadHTMLDoc(a){var b=new XMLHttpRequest;b.overrideMimeType&&b.overrideMimeType("text/html"),b.open("GET",a,!1),b.send();var c=b.responseText;return c=c.replace('xmlns="http://www.w3.org/1999/xhtml"',""),c=c.replace('xmlns:epub="http://www.idpf.org/2007/ops"',"")}function xmlToJson(a,b){var c=0;if(!b)for(b=["xml:"],c=0;c<a.documentElement.attributes.length;c++)-1!=a.documentElement.attributes.item(c).nodeName.indexOf("xmlns")&&b.push(a.documentElement.attributes.item(c).nodeName.replace("xmlns:","")+":");var d=!0;if(a.attributes&&a.attributes.length>0){var e;d={};for(var f=0;f<a.attributes.length;f++)e=a.attributes.item(f),d[e.nodeName.replaceArray(b,"").toCamel()]=e.value}if(a.hasChildNodes()){var g,h,i;d===!0&&(d={});for(var j=0;j<a.childNodes.length;j++)i=a.childNodes.item(j),1===(7&i.nodeType)?(g=i.nodeName.replaceArray(b,"").toCamel(),h=xmlToJson(i,b),d.hasOwnProperty(g)?(d[g].constructor!==Array&&(d[g]=[d[g]]),d[g].push(h)):d[g]=h):3===(i.nodeType-1|1)&&(g="value",h=3===i.nodeType?i.nodeValue.replace(/^\s+|\s+$/g,""):i.nodeValue,d.hasOwnProperty(g)?d[g]+=h:(4===i.nodeType||""!==h)&&(d[g]=h))}return d}function objectToArray(a){return void 0!==a?"[object Array]"!==Object.prototype.toString.call(a)?[a]:a:void 0}var $=jQuery,LICollection=function(){var a=[];this.add=function(b){var c,d;for(c=0,d=a.length;d>c;c++)if(a[c].id==b.id)return!1;return a.push(b),!0},this.remove=function(b){var c,d;for("string"==typeof b&&(b={id:b}),c=0,d=a.length;d>c;c++)a[c].id==b.id&&a.splice(c,1)},this.find=function(b){var c,d;for(c=0,d=a.length;d>c;c++)if(a[c].id==b)return a[c];return!1},this.list=function(){return a},this.userIsDraggingAsset=!1},LayeredImage=function(a){var b,c,d;if(void 0===jQuery)return!1;var e=this.$=jQuery;if(void 0===org.polymaps)return!1;if(this.polymaps=org.polymaps,this.container=e(a),this.container.length<1)return!1;if(window.liCollection.add(this)){this.id=this.container.attr("id"),this.settings=this.container.data(),this.settings.zoomStep=this.settings.zoomStep||.1,this.settings.annotationSelectorVisible=!1,this.settings.dragging=void 0;var f=this.container.parents("figure:first"),g=f.attr("data-options");f.length>0&&g&&(this.figureOptions=JSON.parse(g)),("undefined"==typeof this.figureOptions||"object"!=typeof this.figureOptions)&&(this.figureOptions={}),"undefined"==typeof this.figureOptions.disable_interaction&&(this.figureOptions.disable_interaction=!1),"undefined"==typeof this.figureOptions.disable_annotation&&(this.figureOptions.disable_annotation=!1),"undefined"==typeof this.figureOptions.sliderPosition&&(this.figureOptions.sliderPosition=0),this.settings.captionMarkup=this.container.parents("figure:first").find("figcaption").clone(),this.settings.originalMarkup=outerHTML(this.container[0]),this.layers=[];var h=this.container.find(".layered_image-layers"),i=h.find("li"),j=[];for(b=0,c=i.length;c>b;b++){var k=e(i[b]),d=k.data();d.annotation?j.push(d):this.layers.push(d)}j.length&&(this.layers=this.layers.concat(j)),h.remove(),this.map=this.polymaps.map();var l=this.polymaps.svg("svg");for(e(l).css({height:"100%",width:"100%"}),this.map.container(this.container[0].appendChild(l)),this.map.tileSize({x:256,y:256}),this.baseLayers=[],this.annotationLayers=[],this.max_zoom_level=0,this.max_width=0,this.max_height=0,b=0,c=this.layers.length;c>b;b++)d=this.layers[b],d.layer_num=b+1,d.zoom_levels||(d.zoom_levels=this.getZoomLevels(d.width,d.height)),d.annotation?this.annotationLayers.push(d):this.baseLayers.push(d),"iip"===d.type&&(d.zoom_levels=d.zoom_levels-1),d.width>this.max_width&&(this.max_width=d.width),d.height>this.max_height&&(this.max_height=d.height),d.zoom_levels>this.max_zoom_level&&(this.max_zoom_level=d.zoom_levels);var m=this.figureOptions.baseLayerPreset?this.figureOptions.baseLayerPreset:[],n=m.length,o=!1;if(n>0){var p,q=this.getLayerById(m[0]);n>1&&(p=this.getLayerById(m[1])),q&&(p||1==n)&&(this.createLayer(q),p&&(this.createLayer(p),e("#"+p.id).css("opacity",0)),o=!0)}!o&&this.baseLayers.length&&(this.createLayer(this.baseLayers[0]),this.baseLayers[1]&&(this.createLayer(this.baseLayers[1]),e("#"+this.baseLayers[1].id).css("opacity",0))),this.createUI(),this.showAnnotationPresets(),this.zoomToContainer();var r=[];this.figureOptions.fullscreenExtents?(r=[{lon:this.figureOptions.fullscreenExtents.swLon,lat:this.figureOptions.fullscreenExtents.swLat},{lon:this.figureOptions.fullscreenExtents.neLon,lat:this.figureOptions.fullscreenExtents.neLat}],this.setExtents(r)):this.figureOptions.swLat&&(r=[{lon:this.figureOptions.swLon,lat:this.figureOptions.swLat},{lon:this.figureOptions.neLon,lat:this.figureOptions.neLat}],this.setExtents(r))}};LayeredImage.prototype.createLayer=function(a){{var b;this.$}void 0!==a&&("image"==a.type&&(b=this.createLayerImage(a)),"iip"==a.type&&(b=this.createLayerIIP(a)),"svg"==a.type&&(b=this.createLayerSVG(a)),a.visible=!0,a.polymapLayer=b,b.id(a.id),this.map.add(b))},LayeredImage.prototype.removeLayer=function(a){a.polymapLayer&&this.map.remove(a.polymapLayer),a.polymapLayer=void 0,a.visible=!1},LayeredImage.prototype.toggleLayer=function(a){a.visible?this.removeLayer(a):this.createLayer(a)},LayeredImage.prototype.repaintLayer=function(a){this.removeLayer(a),this.createLayer(a)},LayeredImage.prototype.createLayerIIP=function(a){var b=this,c=this.polymaps.image(),d=function(c){var d=a.ptiff_server,e=a.ptiff_path,f=a.height,g=a.width,h=256,i=b.getScale(a.zoom_levels,c.zoom),j=Math.round(g/i),k=Math.round(f/i),l=Math.ceil(j/h),m=Math.ceil(k/h);if(c.row<0||c.row>=m||c.column<0||c.column>=l)return null;c.row==m-1&&c.element.setAttribute("height",k%h),c.column==l-1&&c.element.setAttribute("width",j%h);var n=d+"?fif="+e+"&jtl="+c.zoom+","+(c.row*l+c.column);return n};return c.url(d),c},LayeredImage.prototype.createLayerImage=function(a){var b=this,c=function(c){var d=b.getScale(b.max_zoom_level,c.zoom);c.element=b.polymaps.svg("image"),c.element.setAttribute("preserveAspectRatio","none"),c.element.setAttribute("x",0),c.element.setAttribute("y",0),c.element.setAttribute("width",b.max_width/d),c.element.setAttribute("height",b.max_height/d),c.element.setAttributeNS("http://www.w3.org/1999/xlink","href",a.image_path),c.ready=!0},d=function(a){a.request&&a.request.abort(!0)},e=this.polymaps.layer(c,d).tile(!1);return e},LayeredImage.prototype.createLayerSVG=function(a){var b=this,c=function(c){var d=b.getScale(b.max_zoom_level,c.zoom);c.element=b.polymaps.svg("image"),c.element.setAttribute("preserveAspectRatio","none"),c.element.setAttribute("x",0),c.element.setAttribute("y",0),c.element.setAttribute("width",b.max_width/d),c.element.setAttribute("height",b.max_height/d),c.element.setAttributeNS("http://www.w3.org/1999/xlink","href",a.svg_path),c.ready=!0},d=function(a){a.request&&a.request.abort(!0)},e=this.polymaps.layer(c,d).tile(!1);return e},LayeredImage.prototype.zoomToContainer=function(){var a,b,c=0,d=0;for(a=0,b=this.layers.length;b>a;a++){var e=this.layers[a],f=this.getScale(this.max_zoom_level,e.zoom_levels),g=Math.round(e.width/f),h=Math.round(e.height/f),i=g/this.map.tileSize().x,j=h/this.map.tileSize().y;e.tiles_wide=i,e.tiles_high=j,e.tiles_zoom=e.zoom_level,d=j>d?j:d,c=i>c?i:c}this.settings.containerFitSW=this.map.coordinateLocation({zoom:this.max_zoom_level,column:0,row:d}),this.settings.containerFitNE=this.map.coordinateLocation({zoom:this.max_zoom_level,column:c,row:0}),this.map.extent([this.settings.containerFitSW,this.settings.containerFitNE]),this.settings.containerFitZoomLevel=this.map.zoom(),this.resetZoomRange(this.settings.containerFitZoomLevel)},LayeredImage.prototype.createUI=function(){var a,b=this.$,c=this;(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&(this.map.add(this.polymaps.drag()).add(this.polymaps.wheel()).add(this.polymaps.dblclick()).add(this.polymaps.touch()),b(this.container).bind({mousewheel:function(){c.ui.zoomSlider.slider("value",c.map.zoom()),c.refreshViewfinderViewport()},DOMMouseScroll:function(){c.ui.zoomSlider.slider("value",c.map.zoom()),c.refreshViewfinderViewport()},dblclick:function(){c.ui.zoomSlider.slider("value",c.map.zoom()),c.refreshViewfinderViewport()},mousedown:function(a){c.settings.dragging={x:a.clientX,y:a.clientY},liCollection.userIsDraggingAsset=c.id}})),this.ui={},this.ui.legendItemsCount=0,this.ui.controlbar=b('<div class="ca-ui-controlbar"></div>'),a=this.settings.collapsed?"collapsed":"expanded",this.ui.fullscreen=b('<div class="ca-ui-fullscreen '+a+'"></div>').bind("click",function(){c.settings.collapsed?c.fullscreen():(window.liCollection.remove(c),b(".ca-ui-fullscreen-modal").remove(),window.scrollOffset&&window.scrollTo(window.scrollOffset[0],window.scrollOffset[1]))}).appendTo(this.ui.controlbar),this.ui.reset=b('<div class="ca-ui-reset"></div>').bind("click",function(){c.reset()}),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.reset.appendTo(this.ui.controlbar),this.annotationLayers.length>0&&(this.ui.annotation=b('<div class="ca-ui-annotation"></div>').bind("click",function(){c.toggleAnnotationSelector()}),(!this.figureOptions.disable_annotation||this.figureOptions.editing)&&this.ui.annotation.appendTo(this.ui.controlbar));var d=this.getVisibleBaseLayers();this.settings.currentLayer1=d[0],d.length>1&&(this.settings.currentLayer2=d[1],this.ui.layerSelector=b('<div class="ca-ui-layer-selector"></div>'),this.ui.layerSelector.bind("click",{layeredImage:this},this.toggleLayerSelector),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.controlbar.append(this.ui.layerSelector),this.ui.sliderContainer=b('<div class="ca-ui-layer-slider-container"></div>'),this.ui.sliderLayerText1=b('<div class="ca-ui-layer-slider-layer-text1">1</div>').attr("title",this.settings.currentLayer1.title).appendTo(this.ui.sliderContainer).qtip(),this.ui.slider=b('<div class="ca-ui-layer-slider"></div>').slider({slide:function(a,d){var e=d.value/100;b("#"+c.settings.currentLayer2.id).css("opacity",e),c.refreshViewfinderOpacity(e)},change:function(a,d){var e=d.value/100;b("#"+c.settings.currentLayer2.id).css("opacity",e),c.refreshViewfinderOpacity(e)}}).appendTo(this.ui.sliderContainer),this.ui.sliderLayerText2=b('<div class="ca-ui-layer-slider-layer-text2">2</div>').attr("title",this.settings.currentLayer2.title).appendTo(this.ui.sliderContainer).qtip(),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&(this.ui.sliderContainer.appendTo(this.ui.controlbar),this.ui.layerSelector.after(this.ui.sliderContainer)),void 0!==this.figureOptions.sliderPosition&&this.ui.slider.slider("value",this.figureOptions.sliderPosition)),this.ui.controlbar.appendTo(this.container),this.resizeControlBar(),this.ui.zoom=b('<div class="ca-ui-zoom"></div>'),this.ui.zoomIn=b('<div class="ca-ui-zoom-in"></div>').bind("click",function(){var a=c.ui.zoomSlider.slider("value"),b=a+c.settings.zoomStep;c.ui.zoomSlider.slider("value",b),c.map.zoom(b)}).appendTo(this.ui.zoom),this.ui.zoomSlider=b('<div class="ca-ui-zoom-slider"></div>').slider({step:this.settings.zoomStep,orientation:"vertical",slide:function(a,b){var d=b.value,e=c.map.zoom();d!=e&&c.map.zoom(d)}}).appendTo(this.ui.zoom),this.ui.zoomOut=b('<div class="ca-ui-zoom-out"></div>').bind("click",function(){var a=c.ui.zoomSlider.slider("value"),b=a-c.settings.zoomStep;c.ui.zoomSlider.slider("value",b),c.map.zoom(b)}).appendTo(this.ui.zoom),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.zoom.appendTo(this.container),this.resizeZoomControls(),this.ui.viewfinder=b('<div class="ca-ui-viewfinder viewfinder-closed"></div>'),(!this.figureOptions.disable_interaction||this.figureOptions.editing)&&this.ui.viewfinder.appendTo(this.container),this.ui.viewfinder.bind("click",function(){c.ui.viewfinder.hasClass("viewfinder-open")?(c.ui.viewfinder.empty().css("height",""),c.ui.viewfinder.removeClass("viewfinder-open").addClass("viewfinder-closed"),c.ui.viewfinderViewport=null):(c.ui.viewfinder.removeClass("viewfinder-closed").addClass("viewfinder-open"),c.refreshViewfinder())}),this.ui.controls=[this.ui.controlbar,this.ui.zoom,this.ui.viewfinder,this.ui.currentPopup,this.ui.annotation,this.ui.layerSelector],this.container.bind("mousemove mousewheel DOMMouseScroll",function(){var a=c.container,b=new Date;a.attr("data-controls-time",b.getTime());var d=a.attr("data-controls")||"false";if("false"==d){for(var e=window.liCollection.list(),f=0,g=e.length;g>f;f++){var h=e[f];"true"==h.container.attr("data-controls")&&(h.container.attr("data-controls","false"),h.toggleControls())}a.attr("data-controls","true"),c.toggleControls()}c.ui.controlsTimeout=setTimeout(function(){var b=new Date;"true"==a.attr("data-controls")&&b.getTime()-a.attr("data-controls-time")>=1750&&"true"!=a.attr("data-controls-lock")&&(a.attr("data-controls","false"),c.clearPopups(),c.toggleControls())},2e3)}),b.each(this.ui.controls,function(){"function"==typeof this.bind&&(this.bind("mouseenter",function(){c.container.attr("data-controls-lock","true")}),this.bind("mouseleave",function(){c.container.attr("data-controls-lock","false")}))})},LayeredImage.prototype.reset=function(){var a,b,c=this.$,d=this;if(d.clearPopups(),"undefined"==typeof d.figureOptions.swLat||d.figureOptions.editing)d.zoomToContainer();else{var e=[{lon:d.figureOptions.swLon,lat:d.figureOptions.swLat},{lon:d.figureOptions.neLon,lat:d.figureOptions.neLat}];d.map.extent(e)}d.ui.zoomSlider.slider("value",d.map.zoom()),void 0!==d.figureOptions.sliderPosition&&d.ui.slider&&d.ui.slider.slider("value",d.figureOptions.sliderPosition);var f;if(d.figureOptions.baseLayerPreset)for(f=[],a=0,b=d.figureOptions.baseLayerPreset.length;b>a;a++)f.push(d.getLayerById(d.figureOptions.baseLayerPreset[a]));else f=d.baseLayers;for(a=0,b=f.length;b>a&&2>a;a++)currentLayer=d.settings["currentLayer"+(a+1)],d.toggleLayer(currentLayer),d.toggleLayer(f[a]),d.settings["currentLayer"+(a+1)]=f[a],d.ui["layerSelector"+(a+1)]&&d.ui["layerSelector"+(a+1)].find("span").html(f[a].title),d.ui["sliderLayerText"+(a+1)]&&d.ui["sliderLayerText"+(a+1)].attr("title",d.settings["currentLayer"+(a+1)].title);f.length>1&&d.ui.slider&&(c("#"+d.settings.currentLayer2.id).css("opacity",d.ui.slider.slider("value")/100),d.ui.viewfinderLayer2&&d.ui.viewfinderLayer2.css("opacity",d.ui.slider.slider("value")/100)),d.showAnnotationPresets()},LayeredImage.prototype.refreshViewfinder=function(){var a=this.$;this.ui.viewfinder.empty();var b=this.settings.currentLayer1.thumb;if(this.ui.viewfinderLayer1=a('<div class="ca-ui-viewfinderLayer viewfinderLayer1"></div>'),a("<img />").attr("src",b).appendTo(this.ui.viewfinderLayer1),this.ui.viewfinder.append(this.ui.viewfinderLayer1),this.settings.currentLayer2){var c=this.settings.currentLayer2.thumb;this.ui.viewfinderLayer2=a('<div class="ca-ui-viewfinderLayer viewfinderLayer2"></div>'),a("<img />").attr("src",c).appendTo(this.ui.viewfinderLayer2),this.ui.viewfinder.append(this.ui.viewfinderLayer2),this.ui.viewfinderLayer2.css("opacity",this.ui.slider.slider("value")/100)}var d=this.ui.viewfinder.width(),e=Math.floor(d/this.settings.aspect);this.ui.viewfinder.height(e),void 0!==this.ui.viewfinderViewport&&this.ui.viewfinderViewport.remove(),this.ui.viewfinderViewport=void 0,this.refreshViewfinderViewport()},LayeredImage.prototype.refreshViewfinderViewport=function(){if(this.ui.viewfinder.hasClass("viewfinder-open")){var a=this.$,b=this.ui.viewfinder.width(),c=Math.floor(b/this.settings.aspect);this.ui.viewfinderViewport||(this.ui.viewfinderViewport=a('<div class="ca-ui-viewfinder-viewport">&nbsp;</div>').appendTo(this.ui.viewfinder),void 0===this.settings.viewPortBorderWidth&&(this.settings.viewPortBorderWidth=parseInt(this.ui.viewfinderViewport.css("border-left-width"),10)));var d=this.map.locationPoint(this.settings.containerFitSW),e=this.map.locationPoint(this.settings.containerFitNE),f=-1*d.x/(e.x-d.x)*b-this.settings.viewPortBorderWidth,g=-1*e.y/(d.y-e.y)*c-this.settings.viewPortBorderWidth,h=this.map.size().x/(e.x-d.x),i=this.map.size().y/(d.y-e.y),j=h*b,k=i*c;this.ui.viewfinderViewport.css({top:g+"px",left:f+"px",width:j+"px",height:k+"px"})}},LayeredImage.prototype.refreshViewfinderOpacity=function(a){this.ui.viewfinderLayer2&&this.ui.viewfinderLayer2.css("opacity",a)},LayeredImage.prototype.fullscreen=function(a){var b=this.$,c=this,d=b('<div class="ca-ui-fullscreen-modal"></div>').appendTo(document.body);d.bind("click",function(a){b(a.target).hasClass("ca-ui-fullscreen-modal")&&b(this).find(".ca-ui-fullscreen").trigger("click")});var e=b('<div class="ca-ui-fullscreen-wrap"></div>').appendTo(d),f=d.offset(),g=d.height()-f.top,h=d.outerWidth()-f.left,i=0,j=0,k=!0,l=.9,m=void 0!==(c.figureOptions&&c.figureOptions.aspect)?c.figureOptions.aspect:c.settings.aspect;if(1>=m)for(;j>h||k;)i=Math.floor(g*l),j=Math.floor(i*m),l-=.1,k=!1;else for(;i>g||k;)j=Math.floor(h*l),i=Math.floor(j/m),l-=.1,k=!1;e.css({height:i+"px",top:Math.floor((g-i)/2)+"px",width:j+"px",left:Math.floor((h-j)/2)+"px"});var n=b(this.settings.originalMarkup);n.attr("id",n.attr("id")+"-fullscreen"),n.attr("data-collapsed","false"),n.find("li").each(function(){var a=b(this);a.data("id",a.data("id")+"-fullscreen"),a.data("parent_asset",a.data("parent_asset")+"-fullscreen")});var o=this.map.extent();1!==this.map.zoom()&&(this.figureOptions.fullscreenExtents={swLon:o[0].lon,swLat:o[0].lat,neLon:o[1].lon,neLat:o[1].lat});var p=b("<figure></figure>").attr("data-options",JSON.stringify(this.figureOptions)).css({height:i+"px",width:j+"px"}).appendTo(e),q=0;this.settings.captionMarkup&&(p.append(this.settings.captionMarkup),q=this.settings.captionMarkup.outerHeight(!0)),b("<div>",{"class":"figureContent",css:{height:Math.round(i)-q+"px",width:j+"px"}}).append(n).prependTo(p);var r=new LayeredImage(n);a&&r.reset()},LayeredImage.prototype.resizeControlBar=function(){var a=this.container.outerWidth(),b=this.ui.controlbar.children(),c=0;b.each(function(){c+=$(this).outerWidth()});var d=a-2*parseInt(this.ui.controlbar.css("right"),10);c>d&&(this.ui.controlbar.css({"max-width":d+"px"}),b.each(function(){var a=$(this);d-=a.outerWidth(),0>d&&(a.width(a.width()+d),a.find(".ca-ui-layer-slider").each(function(){$(this).width($(this).width()+d)}))}))},LayeredImage.prototype.resizeZoomControls=function(){var a=this.container.outerHeight(),b=this.ui.zoom.children(),c=0;b.each(function(){c+=$(this).outerHeight()});var d=a-this.ui.controlbar.outerHeight()-1;if(c>d)if(this.ui.zoom.css({"max-height":d+"px"}),d-=this.ui.zoomIn.outerHeight()+this.ui.zoomOut.outerHeight(),50>d)this.ui.zoomSlider.hide(),this.ui.zoom.css({"max-height":this.ui.zoomIn.outerHeight()+this.ui.zoomOut.outerHeight()+"px"});else{var e=this.ui.zoomSlider.outerHeight(!0)-this.ui.zoomSlider.outerHeight();this.ui.zoomSlider.height(d-e+"px")}},LayeredImage.prototype.toggleLayerSelector=function(a){{var b=jQuery,c=a.data.layeredImage,d=b(this);c.settings.currentLayer1,c.settings.currentLayer2}if(c.ui.currentPopup&&c.ui.currentPopup==c.ui.layerSelectorPopup)c.clearPopups();else{c.clearPopups(),d.addClass("active"),rows=b('<div class="ca-ui-layer-selector-rows"></div>');for(var e=0;e<c.baseLayers.length;e++){var f=c.baseLayers[e];rowLayerButton1=b('<div class="ca-ui-layer-selector-row-button1"><div class="ca-ui-layer-selector-button"></div></div>').attr("data-layer_index",e),rowTitle=b('<div class="ca-ui-layer-selector-row-title"><span>'+f.title+"</span></div>"),rowLayerButton2=b('<div class="ca-ui-layer-selector-row-button2"><div class="ca-ui-layer-selector-button"></div></div>').attr("data-layer_index",e),f==c.settings.currentLayer1&&rowLayerButton1.find(".ca-ui-layer-selector-button").first().addClass("active"),f==c.settings.currentLayer2&&rowLayerButton2.find(".ca-ui-layer-selector-button").first().addClass("active"),rowLayerButton1.bind("click",{CA:c,layerNum:1},c.layerSelect),rowLayerButton2.bind("click",{CA:c,layerNum:2},c.layerSelect),row=b('<div class="ca-ui-layer-selector-row"></div>').append(rowLayerButton1).append(rowTitle).append(rowLayerButton2),rows.append(row)}var g=parseInt(c.ui.controlbar.css("bottom"),10)+c.ui.controlbar.height(),h=c.ui.controlbar.position().left,i=(c.ui.sliderContainer.outerWidth()+d.outerWidth(),{bottom:g+"px",left:h+"px"});c.ui.layerSelectorPopup=b('<div class="ca-ui-layer-selector-popup"></div>').css(i).bind("mouseenter",function(){c.container.attr("data-controls-lock","true")}).bind("mouseleave",function(){c.container.attr("data-controls-lock","false")}).append(rows).appendTo(c.container),c.ui.currentPopup=c.ui.layerSelectorPopup}},LayeredImage.prototype.toggleAnnotationSelector=function(){var a=this.$,b=this;if(this.ui.currentPopup&&this.ui.currentPopup==this.ui.annotationSelector)this.clearPopups();else{this.clearPopups(),this.ui.annotation.addClass("active");var c=this.ui.annotation.offsetParent().position(),d=this.ui.annotation.position(),e=this.ui.annotation.outerWidth(),f=this.ui.annotation.offsetParent().parent().width(),g=this.ui.annotation.offsetParent().parent().height(),h=f-c.left-d.left-e,i=g-c.top-d.top;this.settings.annotationSelectorVisible=!0,this.ui.annotationSelector=a('<div class="ca-ui-annotation-selector"></div>').css({right:h,bottom:i}),a('<div class="title">Annotations</div>').appendTo(this.ui.annotationSelector),this.ui.annotationSelectorList=a('<ul class="ca-ui-annotation-selector-list"></ul>');for(var j=0,k=this.annotationLayers.length;k>j;j++){var l=this.annotationLayers[j],m=a("<li></li>").bind("click",{layerData:l,CA:b},b.annotationLayerClick),n=a('<div class="ca-ui-annotation-selector-item-box"></div>').addClass(l.visible?"filled":"empty");l.visible&&l.annotation&&n.css("background-color","#"+l.color),m.append(n).append("<span>"+l.title+"</span>").appendTo(this.ui.annotationSelectorList)}this.ui.annotationSelector.bind("mouseenter",function(){b.container.attr("data-controls-lock","true")}).bind("mouseleave",function(){b.container.attr("data-controls-lock","false")}).append(this.ui.annotationSelectorList).appendTo(this.container),this.ui.currentPopup=this.ui.annotationSelector}},LayeredImage.prototype.annotationLayerClick=function(a){var b=a.data.layerData,c=a.data.CA;c.toggleLayer(b);var d=$(this).find(".ca-ui-annotation-selector-item-box");if(b.visible){if(d.removeClass("empty").addClass("filled"),b.annotation&&"svg"==b.type){var e=b.color||"#fff";d.css("background-color","#"+e),c.addLegendItem(b)}}else d.removeClass("filled").addClass("empty"),b.annotation&&"svg"==b.type&&(d.css("background-color",""),c.removeLegendItem(b))},LayeredImage.prototype.resetZoomRange=function(a){a=a||0;for(var b=0,c=0,d=this.layers.length;d>c;c++)"iip"==this.layers[c].type?this.layers[c].zoom_levels-1>b&&(b=this.layers[c].zoom_levels-1):this.layers[c].zoom_levels>b&&(b=this.layers[c].zoom_levels);this.map.zoomRange([a,b]),this.ui.zoomSlider.slider("option","min",a),this.ui.zoomSlider.slider("option","max",b)},LayeredImage.prototype.getZoomLevels=function(a,b){for(var c=this.map.tileSize().x,d=1;a>c||b>c;)d++,a/=2,b/=2;return d},LayeredImage.prototype.getScale=function(a,b){return Math.pow(2,a-b)},LayeredImage.prototype.realignLayers=function(){var a,b,c=this.$,d=this.container.find("svg.map"),e=d.find("g.layer").remove();for(a=0,b=e.length;b>a;a++)c(e[a]).attr("id")==this.settings.currentLayer1.id&&(d.append(e[a]),e.splice(a,1));for(a=0,b=e.length;b>a;a++)c(e[a]).attr("id")==this.settings.currentLayer2.id&&(d.append(e[a]),e.splice(a,1));d.append(e)},LayeredImage.prototype.clearPopups=function(){this.ui.currentPopup&&(this.ui.currentPopup.fadeOut(400,function(){$(this).remove()}),this.ui.currentPopup=!1),this.ui.controls&&$.each(this.ui.controls,function(){$(this).removeClass("active")})},LayeredImage.prototype.toggleControls=function(a){a=a||400;var b=this.$;b.each(this.ui.controls,function(){this!=window&&this.fadeToggle(a)})},LayeredImage.prototype.addLegendItem=function(a){var b=this.$;if(a.color&&""!==a.color){this.ui.legend||(this.ui.legend=b('<div class="ca-ui-legend"><ul class="legendList"></ul></div>').appendTo(this.container),"true"!=this.container.attr("data-controls")&&this.ui.legend.css("display","none"),this.ui.controls.push(this.ui.legend));{var c=this.ui.legend.find("ul"),d=b('<li data-layer_num="'+a.layer_num+'">'+a.title+"</li>").appendTo(c);b('<div class="item-box"></div>').css("background-color","#"+a.color).prependTo(d)}this.ui.legendItemsCount++}},LayeredImage.prototype.removeLegendItem=function(a){var b=this.$,c=this;if(this.ui.legend){var d=this.ui.legend.find("ul").children();if(d.each(function(){b(this).attr("data-layer_num")==a.layer_num&&(b(this).remove(),c.ui.legendItemsCount--)}),this.ui.legendItemsCount<=0){this.ui.legend.remove(),delete this.ui.legend;for(var e=0,f=this.ui.controls.length;f>e;e++)b(this.ui.controls[e]).hasClass("ca-ui-legend")&&this.ui.controls.splice(e,1)}}},LayeredImage.prototype.showAnnotationPresets=function(){for(var a=0,b=this.annotationLayers.length;b>a;a++)if(this.removeLayer(this.annotationLayers[a]),this.removeLegendItem(this.annotationLayers[a]),this.figureOptions.annotationPreset)for(var c=0,d=this.figureOptions.annotationPreset.length;d>c;c++){var e=this.figureOptions.annotationPreset[c];if(this.annotationLayers[a].layer_id==e){this.repaintLayer(this.annotationLayers[a]),(!this.figureOptions.disable_annotation||this.figureOptions.editing)&&this.addLegendItem(this.annotationLayers[a]);break}}},LayeredImage.prototype.getVisibleBaseLayers=function(){var a,b,c=[];for(a=0,b=this.baseLayers.length;b>a;a++){var d=this.baseLayers[a];d.visible&&c.push(d)}return c},LayeredImage.prototype.getVisibleBaseLayerIds=function(){var a,b,c=[];for(a=0,b=this.baseLayers.length;b>a;a++){var d=this.baseLayers[a];d.visible&&c.push(d.layer_id)}return c},LayeredImage.prototype.getVisibleAnnotationIds=function(){var a,b,c=[];for(a=0,b=this.annotationLayers.length;b>a;a++){var d=this.annotationLayers[a];d.visible&&c.push(d.layer_id)}return c},LayeredImage.prototype.getExtents=function(){var a=this.map.extent();return{swLon:a[0].lon,swLat:a[0].lat,neLon:a[1].lon,neLat:a[1].lat}},LayeredImage.prototype.setExtents=function(a){this.map.extent(a),this.ui.zoomSlider&&this.ui.zoomSlider.slider("value",this.map.zoom())},LayeredImage.prototype.getSliderPosition=function(){return"undefined"!=typeof this.ui.slider?this.ui.slider.slider("value"):0},LayeredImage.prototype.getLayerById=function(a){for(var b=0,c=this.layers.length;c>b;b++)if(this.layers[b].layer_id&&this.layers[b].layer_id==a)return this.layers[b];return!1},LayeredImage.prototype.layerSelect=function(a){var b=a.data.CA,c=a.data.layerNum,d=parseInt($(this).attr("data-layer_index"),10),e=$(this).find(".ca-ui-layer-selector-button");if(!e.hasClass("active")){var f=1==c?2:1,g=b.ui.layerSelectorPopup.find(".ca-ui-layer-selector-row-button"+f+'[data-layer_index="'+d+'"] .ca-ui-layer-selector-button');if(!g.hasClass("active")){if(b.removeLayer(b.settings["currentLayer"+c]),b.createLayer(b.baseLayers[d]),b.settings["currentLayer"+c]=b.baseLayers[d],2==c){var h=b.ui.slider.slider("value"),i=h/100;$("#"+b.settings.currentLayer2.id).css("opacity",i)}b.ui.layerSelectorPopup.find(".ca-ui-layer-selector-row-button"+c+" .ca-ui-layer-selector-button").removeClass("active"),e.addClass("active"),b.ui.sliderLayerText1.attr("title",b.settings.currentLayer1.title),b.ui.sliderLayerText2.attr("title",b.settings.currentLayer2.title),b.realignLayers(),b.refreshViewfinder()}}},window.liCollection=new LICollection,window.addEventListener("mousemove",liMousemove,!1),window.addEventListener("mouseup",liMouseup,!1),OsciTk={},OsciTk.collections={},OsciTk.models={},OsciTk.templates={},OsciTk.views={figureTypeRegistry:{}},OsciTk.router=Backbone.Router.extend({routes:{"":"routeToSection","section/:section_id":"routeToSection","section/:section_id/:identifier":"routeToSection"},initialize:function(){this.on("all",this._trackPageView)},routeToSection:function(a,b){Backbone.trigger("routedToSection",{section_id:a,identifier:b})},_trackPageView:function(){var a=Backbone.history.getFragment();_.isUndefined(window._gaq)||_gaq.push(["_trackPageview","/#"+a])}}),String.prototype.replaceArray=function(a,b){for(var c=this,d=0;d<a.length;d++)c=c.replace(a[d],b);return c},String.prototype.toCamel=function(){return this.replace(/\s(.)/g,function(a){return a.toUpperCase()}).replace(/\s/g,"").replace(/^(.)/,function(a){return a.toLowerCase()})},OsciTk.templateManager={get:function(a){return function(b){return OsciTk.templateManager.useTemplate(a,b)}},useTemplate:function(a,b){if(void 0===OsciTk.templates[a])for(var c=app.config.get("templateUrls"),d=!1,e=c.length,f=0;e>f&&($.ajax({async:!1,dataType:"html",url:c[f]+a+".tpl.html",success:function(b){OsciTk.templates[a]=_.template(b),d=!0}}),!d);f++);return OsciTk.templates[a](b)}},OsciTk.models.BaseModel=Backbone.Model.extend(),OsciTk.models.Config=OsciTk.models.BaseModel.extend({}),OsciTk.models.Package=OsciTk.models.BaseModel.extend({defaults:function(){return{url:null,lang:null,spine:null,manifest:null,metadata:null,id:null,version:null,xmlns:null}},initialize:function(){var a=xmlToJson(loadXMLDoc(this.get("url")));this.set("lang",a["package"].lang),this.set("spine",a["package"].spine),this.set("manifest",a["package"].manifest),this.set("metadata",a["package"].metadata);var b=a["package"].metadata["dc:identifier"];_.isArray(b)||(b=[b]);for(var c=b.length,d=0;c>d;d++){var e=b[d];if(e.value.indexOf("urn:osci_tk_identifier:")!==!1){this.set("id",e.value.substr(23));break}}this.set("version",a["package"].version),this.set("xmlns",a["package"].xmlns),Backbone.trigger("packageLoaded",this)},sync:function(){},getTitle:function(){var a,b=this.get("metadata");return b["dc:title"]&&b["dc:title"].value&&(a=b["dc:title"].value),a},getPubId:function(){var a,b=this.get("metadata");if(!_.isUndefined(b["dc:identifier"]))if(_.isArray(b["dc:identifier"])){var c=_.find(b["dc:identifier"],function(a){return"publication-id"===a.id?!0:!1});c&&(a=c.value.split(":"))}else a=b["dc:identifier"].value.split(":");return a[2]}}),OsciTk.models.Figure=OsciTk.models.BaseModel.extend({defaults:function(){return{section_id:null,delta:null,caption:null,position:null,columns:null,aspect:0,body:null,options:{},plate:!1}},initialize:function(){this.parsePositionData(),this.set("content",$.trim(this.get("content")))},parsePositionData:function(){var a,b=this.get("position");return("plate"===b||"platefull"===b)&&(this.set("plate",!0),"plate"===b?b="p":"platefull"===b&&(b="ff")),a=2==b.length?{vertical:b[0],horizontal:b[1]}:"n"===b||"p"===b?{vertical:b,horizontal:b}:{vertical:b,horizontal:"na"},this.set("position",a),this}}),OsciTk.models.Footnote=OsciTk.models.BaseModel.extend({defaults:function(){return{body:"",section_id:"",delta:""}},sync:function(){}}),OsciTk.models.NavigationItem=OsciTk.models.BaseModel.extend({defaults:function(){return{title:null,subtitle:null,uri:null,parent:null,next:null,previous:null,depth:0,thumbnail:null,timestamp:null}}}),OsciTk.models.Note=OsciTk.models.BaseModel.extend({defaults:function(){return{id:null,content_id:null,section_id:null,note:null,tags:[],paragraph_number:null}},initialize:function(){this.on("error",function(){throw new Error("an error has occured")})},sync:function(a,b,c){var d=app.config.get("endpoints").OsciTkNote;switch(a){case"create":c.data=b.toJSON(),delete c.data.id,c.success=function(a,d,e){var f=JSON.parse(a);
f.success?(b.set("id",f.note.id),b.trigger("change")):c.error(b,e)},c.type="POST",$.ajax(d,c);break;case"update":c.data=b.toJSON(),c.success=function(a,d,e){var f=JSON.parse(a);f.success?b.trigger("change"):c.error(b,e)},c.type="POST",$.ajax(d,c);break;case"delete":c.data=b.toJSON(),c.data["delete"]=1,c.type="POST",c.success=function(a,d,e){var f=JSON.parse(a);f.success?b.trigger("change"):c.error(b,e)},$.ajax(d,c)}}}),OsciTk.models.SearchResult=OsciTk.models.BaseModel.extend({get:function(a){if(!this.attributes[a])return this.attributes[a];var b=this.attributes[a];switch(a){case"bundle":return"footnote"===b||"note"===b||"figure"===b?b:"content";case"url":break;case"teaser":var c=this.attributes[a],d=document.createElement("DIV");return d.innerHTML=c,d.textContent||tmpinnerText||"";default:return this.attributes[a]}}}),OsciTk.models.Account=OsciTk.models.BaseModel.extend({defaults:{username:"anonymous",id:0},initialize:function(){this.getSessionState()},sync:function(){},getSessionState:function(){var a=this;$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"status"},type:"POST",dataType:"json",success:function(b){b.success===!0&&a.set(b.user)}})}}),OsciTk.models.Page=OsciTk.models.BaseModel.extend({defaults:function(){return{content:{},pageNumber:0}},addContent:function(a){var b=this.get("content"),c=$(a[0]).data("osci_content_id");return void 0===c&&(c=$(a[0]).attr("id")),void 0===c?(c="content",b[c]=void 0===b[c]?a.html():b[c]+a.html()):b[c]=a[0],this},removeContentAt:function(a){var b=this.get("content");return delete b[a],this},removeAllContent:function(){this.set("content",{})},contentLength:function(){return this.get("content").length},getContent:function(a){return this.get("content")[a]}}),OsciTk.models.Section=OsciTk.models.BaseModel.extend({defaults:function(){return{title:null,content:null,uri:null,media_type:"application/xhtml+xml",contentLoaded:!1,pages:null}},initialize:function(){pages=new OsciTk.collections.Pages},loadContent:function(){var a=null;if(this.get("contentLoaded")===!1){var b=loadHTMLDoc(this.get("uri")),c=[],d=/body([^>]*)class=(["']+)([^"']*)(["']+)/gi.exec(b.substring(b.indexOf("<body"),b.indexOf("</body>")+7));_.isArray(d)&&!_.isUndefined(d[3])&&(c=d[3].split(" ")),a=$("<div />").html(b),this.set("title",a.find("title").html()),this.set("content",a),this.set("contentLoaded",!0),this.set("classes",c)}null===a&&(a=$(this.get("content")));var e=a.find("section#footnotes"),f=a.find("figure");Backbone.trigger("footnotesAvailable",e),Backbone.trigger("figuresAvailable",f),Backbone.trigger("sectionLoaded",this)},removeAllPages:function(){this.set("pages",new OsciTk.collections.Pages)}}),OsciTk.models.GlossaryTerm=OsciTk.models.BaseModel.extend({defaults:function(){return{term:"",definition:""}}}),OsciTk.collections.BaseCollection=Backbone.Collection.extend(),OsciTk.collections.Figures=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Figure,initialize:function(){this.listenTo(Backbone,"figuresAvailable",function(a){this.populateFromMarkup(a),Backbone.trigger("figuresLoaded",this)})},comparator:function(a){return a.get("delta")},populateFromMarkup:function(a){var b=[];_.each(a,function(a){var c=a.id.match(/\w+-(\d+)-(\d+)/),d=$(a),e={id:a.id,rawData:a,body:a.innerHTML,section_id:c[1],delta:c[2],title:d.attr("title"),caption:d.find("figcaption").html(),content:d.find(".figure_content").html(),position:d.data("position"),columns:d.data("columns"),options:d.data("options"),thumbnail_url:void 0,type:d.data("figure_type"),aspect:d.data("aspect"),order:d.data("order"),count:d.data("count")};if(e.options.previewUri)e.thumbnail_url=e.options.previewUri,e.preview_url=e.options.previewUri;else{var f=d.children("img.thumbnail").remove();if(f.length)e.thumbnail_url=f.attr("src"),e.preview_url=f.attr("src");else{var g=$(".figure_content img",a);g.length&&(e.thumbnail_url=g.attr("src"),e.preview_url=g.attr("src"))}}b.push(e)},this),this.reset(b)}}),OsciTk.collections.NavigationItems=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.NavigationItem,currentNavigationItem:null,initialize:function(){this.listenTo(Backbone,"packageLoaded",function(a){var b=_.find(a.get("manifest").item,function(a){return"nav"==a.properties});if(b){for(var c=xmlToJson(loadXMLDoc(b.href)),d=c.html.body.nav,e=0,f=d.length;f>e;e++)if("toc"==d[e].type){var g=d[e].ol;this.parseChildren(g,null,0);break}Backbone.trigger("navigationLoaded",this)}})},parseChildren:function(a,b,c){_.isArray(a)===!1&&(a=[a]);for(var d=0,e=a.length;e>d;d++){var f=a[d];if(f.a){var g={id:f.a["data-section_id"],parent:b,depth:c,previous:this.at(this.length-1)||null,next:null,length:f.a["data-length"]||null,title:f.a.value,subtitle:f.a["data-subtitle"],thumbnail:f.a["data-thumbnail"],timestamp:f.a["data-timestamp"],uri:f.a.href};this.add(g);var h=this.at(this.length-1);if(null!==h.get("previous")&&h.get("previous").set("next",h),f.ol&&f.ol.li){var i;i=f.ol.li.length?f.ol.li:[f.ol.li];for(var j=c+1,k=0,l=i.length;l>k;k++)this.parseChildren(i[k],h,j)}}f.li&&this.parseChildren(f.li,b,c)}}}),OsciTk.collections.Footnotes=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Footnote,initialize:function(){this.listenTo(Backbone,"footnotesAvailable",function(a){this.populateFromMarkup(a),Backbone.trigger("footnotesLoaded",this)})},populateFromMarkup:function(a){this.reset();for(var b=a.find("aside"),c=b.length,d=[],e=0;c>e;e++){var f=b[e],g=f.id.match(/\w+-(\d+)-(\d+)/);d.push({id:f.id,rawData:f,body:f.innerHTML,section_id:g[1],delta:g[2],index:f.getAttribute("data-footnote_index")})}this.reset(d)}}),OsciTk.collections.Notes=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Note,initialize:function(){this.listenTo(Backbone,"currentNavigationItemChanged",function(a){a.id&&this.getNotesForSection(a.id)})},comparator:function(a){return a.get("content_id").match(/.*-(\d+)/)[1]},parse:function(a){return a.success?a.notes:!1},getNotesForSection:function(a){$.ajax({url:app.config.get("endpoints").OsciTkNote,data:{section_id:a},type:"GET",dataType:"json",success:function(a){a.success===!0&&(app.collections.notes.reset(a.notes),Backbone.trigger("notesLoaded",app.collections.notes))}})}}),OsciTk.collections.Pages=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Page,initialize:function(){}}),OsciTk.collections.SearchResults=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.SearchResult}),OsciTk.collections.GlossaryTerms=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.GlossaryTerm,initialize:function(){this.listenTo(Backbone,"packageLoaded",this.parseGlossary)},parseGlossary:function(a){var b=_.find(a.get("manifest").item,function(a){return"glossary"===a.id});if(b){var c=loadXMLDoc(b.href);if(null===c)return;var d=$(c).find("dd"),e=$(c).find("dt");if(d.length>0&&e.length>0)for(var f=0,g=e.length;g>f;f++){var h={id:$(e[f]).attr("data-tid"),term:$(e[f]).find("dfn:first").html(),definition:this.html_entity_decode($(d[f]).html())};this.add(h)}}Backbone.trigger("osci.glossary.loaded",this)},filterByKeyword:function(a){var b=new RegExp("\\b"+a,"gi");return _.filter(this.models,function(a){return-1!==a.get("term").search(b)})},get_html_translation_table:function(a,b){var c,d={},e={},f={},g={},h={},i={};if(f[0]="HTML_SPECIALCHARS",f[1]="HTML_ENTITIES",g[0]="ENT_NOQUOTES",g[2]="ENT_COMPAT",g[3]="ENT_QUOTES",h=isNaN(a)?a?a.toUpperCase():"HTML_SPECIALCHARS":f[a],i=isNaN(b)?b?b.toUpperCase():"ENT_COMPAT":g[b],"HTML_SPECIALCHARS"!==h&&"HTML_ENTITIES"!==h)throw new Error("Table: "+h+" not supported");d[38]="&amp;","HTML_ENTITIES"===h&&(d[160]="&nbsp;",d[161]="&iexcl;",d[162]="&cent;",d[163]="&pound;",d[164]="&curren;",d[165]="&yen;",d[166]="&brvbar;",d[167]="&sect;",d[168]="&uml;",d[169]="&copy;",d[170]="&ordf;",d[171]="&laquo;",d[172]="&not;",d[173]="&shy;",d[174]="&reg;",d[175]="&macr;",d[176]="&deg;",d[177]="&plusmn;",d[178]="&sup2;",d[179]="&sup3;",d[180]="&acute;",d[181]="&micro;",d[182]="&para;",d[183]="&middot;",d[184]="&cedil;",d[185]="&sup1;",d[186]="&ordm;",d[187]="&raquo;",d[188]="&frac14;",d[189]="&frac12;",d[190]="&frac34;",d[191]="&iquest;",d[192]="&Agrave;",d[193]="&Aacute;",d[194]="&Acirc;",d[195]="&Atilde;",d[196]="&Auml;",d[197]="&Aring;",d[198]="&AElig;",d[199]="&Ccedil;",d[200]="&Egrave;",d[201]="&Eacute;",d[202]="&Ecirc;",d[203]="&Euml;",d[204]="&Igrave;",d[205]="&Iacute;",d[206]="&Icirc;",d[207]="&Iuml;",d[208]="&ETH;",d[209]="&Ntilde;",d[210]="&Ograve;",d[211]="&Oacute;",d[212]="&Ocirc;",d[213]="&Otilde;",d[214]="&Ouml;",d[215]="&times;",d[216]="&Oslash;",d[217]="&Ugrave;",d[218]="&Uacute;",d[219]="&Ucirc;",d[220]="&Uuml;",d[221]="&Yacute;",d[222]="&THORN;",d[223]="&szlig;",d[224]="&agrave;",d[225]="&aacute;",d[226]="&acirc;",d[227]="&atilde;",d[228]="&auml;",d[229]="&aring;",d[230]="&aelig;",d[231]="&ccedil;",d[232]="&egrave;",d[233]="&eacute;",d[234]="&ecirc;",d[235]="&euml;",d[236]="&igrave;",d[237]="&iacute;",d[238]="&icirc;",d[239]="&iuml;",d[240]="&eth;",d[241]="&ntilde;",d[242]="&ograve;",d[243]="&oacute;",d[244]="&ocirc;",d[245]="&otilde;",d[246]="&ouml;",d[247]="&divide;",d[248]="&oslash;",d[249]="&ugrave;",d[250]="&uacute;",d[251]="&ucirc;",d[252]="&uuml;",d[253]="&yacute;",d[254]="&thorn;",d[255]="&yuml;"),"ENT_NOQUOTES"!==i&&(d[34]="&quot;"),"ENT_QUOTES"===i&&(d[39]="&#39;"),d[60]="&lt;",d[62]="&gt;";for(c in d)d.hasOwnProperty(c)&&(e[String.fromCharCode(c)]=d[c]);return e},html_entity_decode:function(a,b){var c={},d="",e="",f="";if(e=a.toString(),!1===(c=this.get_html_translation_table("HTML_ENTITIES",b)))return!1;delete c["&"],c["&"]="&amp;";for(d in c)f=c[d],e=e.split(f).join(d);return e=e.split("&#039;").join("'")}}),OsciTk.views.BaseView=Backbone.View.extend({getChildViews:function(){return this.childViews||(this.childViews=[]),this.childViews},addView:function(a,b){return a.parent=this,"undefined"==typeof b?this.$el.append(a.el):this.$el.find(b).append(a.el),this._addViewReference(a),this},removeAllChildViews:function(){if(this.childViews){for(var a=0,b=this.childViews.length;b>a;a++)this.childViews[a].close();this.childViews=[]}return this},removeView:function(a,b){if(this.childViews)for(var c=0,d=this.childViews.length;d>c;c++)if(a.cid===this.childViews[c].cid){this.childViews.splice(c,1),a.$el.detach(),(b||void 0===b)&&a.close();break}return this},getChildViewById:function(a){var b;if(this.childViews)for(var c=0,d=this.childViews.length;d>c;c++)if(a===this.childViews[c].cid){b=this.childViews[c];break}return b},getChildViewByIndex:function(a){var b;return this.childViews&&this.childViews[a]&&(b=this.childViews[a]),b},getChildViewsByType:function(a){return _.filter(this.childViews,function(b){return b.$el.is(a)})},replaceView:function(a,b){return a.parent=this,"undefined"==typeof b?this.$el.html(a.el):this.$el.find(b).html(a.el),this._addViewReference(a),this},changeModel:function(a){return this.model=a,this},close:function(){this.removeAllChildViews(),this.remove(),this.unbind(),this.undelegateEvents(),this.onClose&&this.onClose()},_addViewReference:function(a){this.childViews||(this.childViews=[]);for(var b=!1,c=0,d=this.childViews.length;d>c;c++)if(a.cid===this.childViews[c].cid){b=!0;break}b||this.childViews.push(a)}}),OsciTk.views.App=OsciTk.views.BaseView.extend({id:"reader",initialize:function(){$("body").append(this.el),app.views.titleView=new OsciTk.views.Title,this.addView(app.views.titleView),app.views.toolbarView=new OsciTk.views.Toolbar,this.addView(app.views.toolbarView);var a=OsciTk.views.Section;app.config.get("sectionView")&&OsciTk.views[app.config.get("sectionView")]&&(a=OsciTk.views[app.config.get("sectionView")]);var b={};app.config.get("sectionViewOptions")&&(b=app.config.get("sectionViewOptions")),app.views.sectionView=new a(b),this.addView(app.views.sectionView),app.views.navigationView=new OsciTk.views.Navigation,this.addView(app.views.navigationView),app.views.footnotesView=new OsciTk.views.Footnotes,app.views.inlineNotesView=new OsciTk.views.InlineNotes,app.views.citationView=new OsciTk.views.Citation,app.views.glossaryTooltipView=new OsciTk.views.GlossaryTooltip}}),OsciTk.views.Section=OsciTk.views.BaseView.extend({id:"section",initialize:function(a){this.options=a?a:{},_.defaults(this.options,{pageView:"Page"}),this.listenTo(Backbone,"currentNavigationItemChanged",function(a){var b=this;$("body").append('<div id="loader">Loading...</div>'),$("#loader").fadeTo(500,.7,function(){a&&(app.models.section=new OsciTk.models.Section({uri:a.get("uri"),id:a.get("id")}),app.models.section.loadContent(),b.changeModel(app.models.section),b.render()),$("#loader").remove()})})},render:function(){return this.preRender&&this.preRender(),this.model.removeAllPages(),this.removeAllChildViews(),Backbone.trigger("layoutStart"),this.renderContent(),Backbone.trigger("layoutComplete",{numPages:this.model.get("pages").length}),this},onClose:function(){this.model.removeAllPages()},getPageForParagraphId:function(a){var b=this.getChildViews(),c=_.find(b,function(b){return 0!==b.$el.find("[data-paragraph_identifier='"+a+"']").length});return void 0!==c&&-1!==c?_.indexOf(b,c)+1:null},getPageNumberForSelector:function(a){var b=$(a).parents(".page");return b?b.data("page_num"):null},getPageNumberForElementId:function(a){var b=this.getChildViews(),c=_.find(b,function(b){return b.containsElementId(a)});return void 0!==c&&-1!==c?_.indexOf(b,c)+1:null},isElementVisible:function(){return!0},getPageForProcessing:function(a,b){var c;if(void 0!==a)c=this.getChildViewById(a);else if(c=_.filter(this.getChildViews(),function(a){return a.isPageComplete()===!1}),0===c.length){var d=this.model.get("pages");d.add({pageNumber:this.model.get("pages").length+1}),c=new OsciTk.views[this.options.pageView]({model:d.last(),pageNumber:this.model.get("pages").length}),this.addView(c,b)}else c=c.pop();return c},getCurrentPageView:function(){return this.getChildViewByIndex(app.views.navigationView.page-1)},renderContent:function(){var a=this.getPageForProcessing();a.addContent($(this.model.get("content"))),a.render(),a.processingComplete()}}),OsciTk.views.Page=OsciTk.views.BaseView.extend({template:OsciTk.templateManager.get("page"),className:"page",initialize:function(a){this.options=a,this.processingData={complete:!1},this.$el.addClass("page-num-"+this.model.collection.length).attr("data-page_num",this.model.collection.length)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},processingComplete:function(){return this.processingData.complete=!0,this},addContent:function(a){return this.model.addContent(a),this},removeContent:function(a){return this.model.removeContent(a),this},getContentById:function(a){return this.model.getContent(a)},hasContent:function(){return this.model.contentLength()?!0:!1},isPageComplete:function(){return this.processingData.complete},removeAllContent:function(){return this.model.removeAllContent(),this},containsElementId:function(a){return 0!==this.$el.find("#"+a).length}}),OsciTk.views.MultiColumnSection=OsciTk.views.Section.extend({template:OsciTk.templateManager.get("multi-column-section"),initialize:function(a){this._super("initialize"),this.options=a,this.options.pageView="MultiColumnPage",this.listenTo(Backbone,"windowResized",function(){var a,b=this.getChildViewByIndex(app.views.navigationView.page-1),c=b.$el.find("[id]:first");c.length&&(a=c.attr("id")),a&&(app.views.navigationView.identifier=a),this.render()}),this.listenTo(Backbone,"navigate",function(a){var b,c,d,e,f=1;if(a.page)f=a.page;else if(a.identifier)switch(a.identifier){case"end":f=this.model.get("pages").length;break;case"start":f=1;break;default:var g=null;if(a.identifier.search(/^p-[0-9]+/)>-1){var h=a.identifier.slice(a.identifier.lastIndexOf("-")+1,a.identifier.length);g=this.getPageForParagraphId(h)}else if(a.identifier.search(/^fig-[0-9]+-[0-9]+-[0-9]+/)>-1){b=a.identifier.match(/^(fig-[0-9]+-[0-9]+)-([0-9])+?/);var i=b[1],j=b[2]?parseInt(b[2],10):1;if(c=$(".figure_reference").filter("[href='#"+i+"']"),c.length)if(1===c.length)g=this.getPageNumberForSelector(c[0]);else for(d=0,e=0,l=c.length;e<l;e++)if(this.isElementVisible(c[e])&&(d++,d===j)){g=this.getPageNumberForSelector(c[e]);break}}else if(a.identifier.search(/^fn-[0-9]+-[0-9]+/)>-1){if(b=a.identifier.match(/^fn-[0-9]+-[0-9]+/),c=$('a[href="#'+b[0]+'"]'),1===c.length)g=this.getPageNumberForSelector(c[0]);else for(e=0;e<c.length;e++)if(this.isElementVisible(c[e])){g=this.getPageNumberForSelector(c[e]);break}}else g=this.getPageNumberForElementId(a.identifier);f=null!==g?g:1}this.getChildViewByIndex(f-1).show();for(var k=(f-1)*this.dimensions.innerSectionHeight*-1,m=this.getChildViews(),n=m.length,o=0;n>o;o++)o!==f-1&&m[o].hide();this.$el.find("#pages").css({"-webkit-transform":"translate3d(0, "+k+"px, 0)","-moz-transform":"translate3d(0, "+k+"px, 0)",transform:"translate3d(0, "+k+"px, 0)"}),Backbone.trigger("pageChanged",{page:f})}),this.$el.addClass("oscitk_multi_column"),_.defaults(this.options,{minColumnWidth:200,maxColumnWidth:300,gutterWidth:40,minLinesPerColumn:5,defaultLineHeight:16,figureContentGutter:20,maxFigureWidth:0}),this.dimensions={}},isElementVisible:function(a){var b=$(a),c=b.parents(".column"),d=null,e=!0;if(d=c.length?c:b.parents(".page"),d.length){var f=b.position();(f.top<0||f.top>d.height())&&(e=!1)}return e},preRender:function(){app.views.figures={}},renderContent:function(){this.$el.html(this.template()),this.calculateDimensions(),this.layoutData={data:this.model.get("content"),items:null},this.cleanData(),this.unplacedFigures=[];var a=app.collections.figures.where({plate:!0});a.length&&_.each(a,function(a){this.unplacedFigures.push(a.id)},this),this.layoutData.items=this.layoutData.data.length;for(var b=0,c=!0,d=1,e=0,f=0;this.layoutData.items>0||this.unplacedFigures.length>0;){var g=this.getPageForProcessing(void 0,"#pages"),h=null,i=[];g.processingData.rendered||(f=0,e=0,g.render(),i=i.concat(this.unplacedFigures));var j=$(this.layoutData.data[b]).clone();if(0===i.length&&0===j.length){if(!this.unplacedFigures.length)break;i=i.concat(this.unplacedFigures)}var k=j.find("a.figure_reference"),l=k.length,m=j.find("figure"),n=m.length;if(j.is("figure")||l||n||i.length){var o;if(j.is("figure")&&i.push(j.attr("id")),l)for(o=0;l>o;o++)i.push($(k[o]).attr("href").substring(1));if(n)for(o=0;n>o;o++){var p=$(m[o]).remove();i.push(p.attr("id"))}var q=i.length;for(o=0;q>o;o++){var r=app.collections.figures.get(i[o]),s=r.get("type"),t=OsciTk.views.figureTypeRegistry[s]?OsciTk.views.figureTypeRegistry[s]:OsciTk.views.figureTypeRegistry["default"],u=this.getFigureView(r.get("id"));if(u||(app.views.figures[i[o]]=u=new OsciTk.views[t]({model:r,sectionDimensions:this.dimensions})),u.layoutComplete)j.is("figure")&&(h="next");else{if(g.addFigure(u)){h="figurePlaced";var v=_.indexOf(this.unplacedFigures,i[o]);v>-1&&this.unplacedFigures.splice(v,1);break}-1===_.indexOf(this.unplacedFigures,i[o])&&this.unplacedFigures.push(i[o]),j.is("figure")&&(h="next")}}}if(null===h&&j.length){var w="osci-content-"+b,x=j.attr("id")||"";c&&-1===x.indexOf("_anchor")&&j.attr("id",w),j.attr("data-osci_content_id",w),j.is("p")&&j.attr("data-paragraph_number",d),h=g.addContent(j).layoutContent(w)}switch(h){case"contentOverflow":c=!1;break;case"figurePlaced":g.resetPage(),d-=e,e=0,this.layoutData.items+=f,b-=f,f=0;break;default:b++,this.layoutData.items--,f++,j.is("p")&&(d++,e++),c=!0,this.layoutData.items<=0&&g.processingComplete()}}},calculateDimensions:function(){var a=this.dimensions,b=$(window).width(),c=$(window).height();if(300>b&&(b=300),300>c&&(c=300),!a.windowWidth||a.windowWidth!==b||!a.windowHeight||a.windowHeight!==c){a.windowHeight=c,a.windowWidth=b,a.gutterWidth=this.options.gutterWidth,a.figureContentGutter=this.options.figureContentGutter,a.minLinesPerColumn=this.options.minLinesPerColumn,a.sectionMargin={left:parseInt(this.$el.css("margin-left"),10),top:parseInt(this.$el.css("margin-top"),10),right:parseInt(this.$el.css("margin-right"),10),bottom:parseInt(this.$el.css("margin-bottom"),10)},a.sectionPadding={left:parseInt(this.$el.css("padding-left"),10),top:parseInt(this.$el.css("padding-top"),10),right:parseInt(this.$el.css("padding-right"),10),bottom:parseInt(this.$el.css("padding-bottom"),10)},a.outerSectionHeight=c-a.sectionMargin.top-a.sectionMargin.bottom,a.innerSectionHeight=a.outerSectionHeight-a.sectionPadding.top-a.sectionPadding.bottom,a.outerSectionWidth=this.$el.outerWidth(),a.innerSectionWidth=a.outerSectionWidth-a.sectionPadding.left-a.sectionPadding.right,a.columnWidth=a.innerSectionWidth<this.options.maxColumnWidth?a.innerSectionWidth:this.options.maxColumnWidth,a.columnsPerPage=Math.floor(a.innerSectionWidth/a.columnWidth),a.innerSectionWidth<a.columnsPerPage*a.columnWidth+a.columnsPerPage*this.options.gutterWidth&&(a.columnsPerPage=a.columnsPerPage-1),0===a.columnsPerPage&&(a.columnsPerPage=1,a.columnWidth=a.innerSectionWidth-this.options.gutterWidth);var d=(a.innerSectionWidth-a.columnsPerPage*a.columnWidth)/a.columnsPerPage;d>this.options.gutterWidth&&(a.columnWidth=(a.innerSectionWidth-this.options.gutterWidth*a.columnsPerPage)/a.columnsPerPage),a.columnWidth=Math.floor(a.columnWidth);var e=this.options.maxFigureWidth;"string"==typeof e&&e.indexOf("%")>0&&(e=Math.ceil(parseInt(e,10)/100*a.columnsPerPage)),a.maxFigureWidth=e,this.dimensions=a}},cleanData:function(){this.layoutData.data.find("#figures").remove(),this.layoutData.data.find("#footnotes").remove();var a=[];this.layoutData.data.find("section").each(function(b,c){var d=$(c),e=d.attr("id");d.children().each(function(b,c){var d=$(c),f=$.trim(d.text()).length;(f>0||d.hasClass("anchor-link"))&&(d.attr("data-sectionId",e),a.push(c))})}),this.layoutData.data=a},getFigureView:function(a){return app.views.figures[a]?app.views.figures[a]:void 0}});var storeContentId;OsciTk.views.MultiColumnPage=OsciTk.views.Page.extend({initialize:function(a){this._super("initialize"),this.options=a,this.columnTemplate=OsciTk.templateManager.get("multi-column-column"),this.visible=!1,this.paragraphControlsViews=[]},onClose:function(){this.model=void 0},events:{"click a.figure_reference":"onFigureReferenceClicked","click .content-paragraph":"onParagraphClicked"},onFigureReferenceClicked:function(a){a.preventDefault(),a.stopPropagation();var b=a.currentTarget.hash.substring(1),c=app.views.figures[b];return c&&c.fullscreen&&c.fullscreen(),!1},onParagraphClicked:function(a){if("A"===a.target.tagName)return!0;var b=$(a.target).parents("a");if(b.length)return b[0].click(),!0;a.preventDefault(),a.stopPropagation();var c=$(a.currentTarget),d=c.data("paragraph_number");Backbone.trigger("paragraphClicked",{paragraphNumber:d})},hide:function(){this.$el.css("visibility","hidden"),this.visible=!1},show:function(){this.$el.css("visibility","visible"),this.visible=!0},resetPage:function(){this.removeAllContent();for(var a=0,b=this.paragraphControlsViews.length;b>a;a++)this.removeView(this.paragraphControlsViews[a]);this.paragraphControlsViews=[],this.$el.children(":not(figure)").remove(),this.initializeColumns(),0===this.processingData.numberOfColumns&&this.processingComplete()},render:function(){return this.processingData.rendered?this:(this.hide(),this.$el.css({width:this.parent.dimensions.innerSectionWidth,height:this.parent.dimensions.innerSectionHeight}),this.initializeColumns(),this.processingData.rendered=!0,this)},layoutContent:function(a){var b="none",c=this.getCurrentColumn(a);if(null===c)return this.processingComplete(),b="contentOverflow";var d=$(this.getContentById(a));c.$el.append(d);var e=parseFloat(d.css("line-height")),f=d.position();if(c.height-f.top<e)return d.remove(),c.heightRemain=0,b="contentOverflow";var g=d.outerHeight(!0);if(d.is("H1, H2, H3, H4, H5, H6, H7, H8")&&c.heightRemain-g<=2*e)return d.remove(),c.heightRemain=0,b="contentOverflow";var h=0;c.offset<0&&(h=Math.floor(g+c.offset),d.css("margin-top","-"+h+"px"),c.offset=0);var i={top:parseInt(d.css("margin-top"),10),bottom:parseInt(d.css("margin-bottom"),10)},j=c.heightRemain-d.outerHeight(!0);if(j>0&&e>j?j=0:0>j&&j>=-1*i.bottom&&(j=0),0>j){var k=Math.floor((c.height-f.top)/e),l=k*e+f.top,m=c.height-l;if(m>0&&(c.height=l,c.$el.height(l+"px"),j-=m),b="contentOverflow",this.processingData.currentColumn===this.processingData.numberOfColumns-1&&this.processingComplete(),c.height-f.top<e)return d.remove(),this.removeContent(d.data("osci_content_id")),c.heightRemain=0,b="contentOverflow"}if(0===j&&this.processingData.currentColumn===this.processingData.numberOfColumns-1&&this.processingComplete(),c.heightRemain=j,d.is("p")){var n=d.data("paragraph_number"),o=(d.data("osci_content_id"),this.$el.find(".paragraph-identifier-"+n));if(d.addClass("content-paragraph"),0===o.length){var p=c.$el.position(),q=new OsciTk.views.ParagraphControlsView({content:d,position:{top:p.top+f.top+"px",left:p.left+f.left-this.parent.dimensions.gutterWidth+"px"}});this.addView(q),this.paragraphControlsViews.push(q)}}return b},getCurrentColumn:function(a){void 0!==a?storeContentId=a:void 0===a&&(a=storeContentId);var b=null;b=this.processingData.columns[this.processingData.currentColumn].heightRemain;var c=null,d=parseInt(this.$el.css("line-height"),10);d=d?d:this.parent.options.defaultLineHeight;var e=d*this.parent.dimensions.minLinesPerColumn;if(this.processingData.columns[this.processingData.currentColumn]&&this.processingData.columns[this.processingData.currentColumn].heightRemain>0&&(this.processingData.columns[this.processingData.currentColumn].height>=e||this.processingData.columns[this.processingData.currentColumn].isVertCol))c=this.processingData.columns[this.processingData.currentColumn];else for(var f=0;f<this.processingData.numberOfColumns;f++)if(void 0!==this.processingData.columns[f]&&this.processingData.columns[f].height>=e&&this.processingData.columns[f].heightRemain>0){c=this.processingData.columns[f],this.processingData.currentColumn=f;break}if(null!==c&&null===c.$el){if(this.processingData.currentColumn>0)c.offset=b;else{var g=this.parent.getPageNumberForSelector("[data-osci_content_id='"+a+"']"),h=this.parent.getChildViewByIndex(g-1);if(h)for(var f=h.processingData.columns.length-1;f>=0&&(c.offset=h.processingData.columns[f].heightRemain,!(c.offset<0));f--);}var i={width:this.parent.dimensions.columnWidth+"px",height:c.height+"px",left:this.processingData.columns[this.processingData.currentColumn].position.left,top:this.processingData.columns[this.processingData.currentColumn].position.top};c.$el=$(this.columnTemplate()).appendTo(this.$el).addClass("column-"+this.processingData.currentColumn).css(i)}return c},initializeColumns:function(){this.processingData.columns=[];var a=this.getChildViewsByType("figure"),b=a.length;b&&b>1&&(a=_.sortBy(a,function(a){return a.position.y[0]}));var c=parseInt(this.$el.css("line-height"),10);c=c?c:this.parent.options.defaultLineHeight;for(var d=c*this.parent.dimensions.minLinesPerColumn,e=0;e<this.parent.dimensions.columnsPerPage;e++){var f=e*this.parent.dimensions.columnWidth+this.parent.dimensions.gutterWidth*(e+1),g=this.parent.dimensions.innerSectionHeight,h=0,i={x:[f,f+this.parent.dimensions.columnWidth],y:[h,h+g]},j=[{position:{x:[f,f+this.parent.dimensions.columnWidth],y:[h,h+g]},height:g}];if(b)for(var k=0,l=g,m=0;b>m;m++){var n=j[k],o=a[m].position.x,p=a[m].position.y,q=n.position.y[0];if(i.x[0]<o[1]&&i.x[1]>o[0]&&i.y[0]<p[1]&&i.y[1]>p[0]){var r=p[0]-q,s=0;0===r?(s=n.height-a[m].calculatedHeight-this.parent.dimensions.figureContentGutter,q=a[m].position.y[1]+this.parent.dimensions.figureContentGutter,j[k].position.y=[q,q+s],j[k].height=s,l=l-a[m].calculatedHeight-this.parent.dimensions.figureContentGutter):(s=p[0]-q,j[k].position.y=[q,q+s],j[k].height=s,k++,l=l-s-a[m].calculatedHeight,j.push({position:{x:[f,f+this.parent.dimensions.columnWidth],y:[p[1]+this.parent.dimensions.figureContentGutter,p[1]+l+this.parent.dimensions.figureContentGutter]},height:l}))}}for(var t=0,u=j.length;u>t;t++){var v=j[t];g=Math.floor(v.height),(g>d||u>1&&g>0)&&this.processingData.columns.push({height:g,heightRemain:g>0?g:0,$el:null,offset:0,position:{left:v.position.x[0],top:v.position.y[0]},isVertCol:u>1?!0:!1,pageColumnNum:e})}}this.processingData.numberOfColumns=this.processingData.columns.length,this.processingData.currentColumn=0},addFigure:function(a){var b=!1;return this.addView(a),a.layoutComplete||(a.render(),a.layoutComplete?("f"===a.model.get("position").horizontal&&this.processingComplete(),b=!0):(b=!1,this.removeView(a,!1))),b}}),OsciTk.views.figureTypeRegistry["default"]="MultiColumnFigure",OsciTk.views.MultiColumnFigure=OsciTk.views.BaseView.extend({tagName:"figure",template:OsciTk.templateManager.get("multi-column-figure"),initialize:function(a){this.options=a,this.layoutComplete=!1,this.contentRendered=!1,this.sizeCalculated=!1,this.calculatedHeight=0,this.calculatedWidth=0,this.position={x:[0,0],y:[0,0]},this.$el.attr("id",this.model.get("id")),this.$el.addClass(this.model.get("type")),this.listenTo(Backbone,"pageChanged",this.toggleVisibility)},events:{"click .figure_content":"fullscreen"},toggleVisibility:function(a){if(this.parent.options.pageNumber===a.page){this.contentRendered||this.renderContent();var b=this.model.toJSON();"n"!==b.position.vertical&&this.$el.css("visibility","visible")}else this.$el.css("visibility","hidden")},render:function(){this.$el.html(this.template(this.model.toJSON())),this.sizeElement();var a=this.positionElement();return a&&(this.layoutComplete=!0),this},renderContent:function(){this.$el.find(".figure_content").html(this.model.get("content")),this.contentRendered=!0},fullscreen:function(){$.fancybox.open({content:this.model.get("content")})},positionElement:function(){var a=this.model.toJSON(),b=this.options.sectionDimensions;if("n"===a.position.vertical)return this.$el.css("visibility","hidden"),!0;var c,d=this.parent.getCurrentColumn();switch(null===d&&(d=this.parent.processingData.columns[this.parent.processingData.currentColumn]),a.position.horizontal){case"r":c=b.columnsPerPage-1;break;case"l":case"p":case"f":c=0;break;default:c=d.pageColumnNum}var e=!1,f=this.model.get("calculatedColumns"),g=0,h=0,j=Math.ceil(b.columnsPerPage/f);"i"===a.position.horizontal&&(j=this.parent.processingData.columns.length);var k=0,l=this.parent.getChildViewsByType("figure"),m=l.length;c+f>b.columnsPerPage&&(c-=c+f-b.columnsPerPage);a:for(;!e&&j>=k;){k++;var n=0;n="f"===a.position.horizontal||1===b.columnsPerPage?b.outerSectionWidth:b.columnWidth*f+(f+1)*b.gutterWidth;var o=0;this.calculatedWidth<n&&n<=b.outerSectionWidth&&(o=Math.floor((n-this.calculatedWidth)/2));var p=d.pageColumnNum;switch(g=d.pageColumnNum*b.columnWidth+p*b.gutterWidth+o,a.position.vertical){case"t":case"p":h=0;break;case"f":h=(b.innerSectionHeight-this.calculatedHeight)/2;break;case"b":h=b.innerSectionHeight-this.calculatedHeight;break;case"i":h=d.position.top+d.height-d.heightRemain,d.height-d.heightRemain>0&&(h+=b.figureContentGutter)}this.$el.css({top:h+"px",left:g+"px"});var q=[g,g+this.calculatedWidth],r=[h,h+this.calculatedHeight];if(this.position={x:q,y:r},e=!0,(0>g||q[1]>b.innerSectionWidth||r[1]>b.innerSectionHeight)&&(e=!1),e&&m&&m>1)for(i=0;i<m;i++)if(l[i].cid!==this.cid){var s=l[i].position.x,t=l[i].position.y;if(q[0]<s[1]&&q[1]>s[0]&&r[0]<t[1]&&r[1]>t[0]){e=!1;break}}if(!e){var u=0;do{switch(a.position.horizontal){case"r":if(c--,0>c)break a;break;case"l":case"p":case"f":if(c++,c>=b.columnsPerPage)break a;break;default:c++,c>=b.columnsPerPage&&(c=0)}"i"===a.position.horizontal?d=this.parent.processingData.columns[c]:(c+f>b.columnsPerPage&&(c-=c+f-b.columnsPerPage),d=_.find(this.parent.processingData.columns,function(a){return a.pageColumnNum===c})),u++}while(_.isUndefined(d)&&f>u);if(_.isUndefined(d))break a}}return j===k&&1===b.columnsPerPage&&(e=!0),e},sizeElement:function(){var a,b,c=this.options.sectionDimensions,d=this.model.toJSON();if("n"===d.position)return this.calculatedHeight=this.$el.height(),this.calculatedWidth=this.$el.width(),this;var e=d.aspect;!_.isUndefined(d.options.aspect)&&d.options.aspect>0&&(e=d.options.aspect),"string"==typeof d.columns&&d.columns.indexOf("%")>0&&(d.columns=Math.ceil(parseInt(d.columns,10)/100*c.columnsPerPage)),("p"===d.position.horizontal||"f"===d.position.horizontal)&&(d.columns=c.columnsPerPage),c.maxFigureWidth>0&&d.columns>c.maxFigureWidth&&(d.columns=c.maxFigureWidth),d.columns>c.columnsPerPage||"p"===d.position.horizontal||"f"===d.position.horizontal?(a=c.innerSectionWidth,d.columns=c.columnsPerPage):a=d.columns*c.columnWidth+c.gutterWidth*(d.columns-1),a=Math.floor(a),this.$el.css("width",a+"px");
var f=this.$el.find("figcaption").outerHeight(!0);return e?b=a/e+f:(this.renderContent(),b=this.$el.find(".figure_content").outerHeight(!0)+f),b>c.innerSectionHeight&&(b=c.innerSectionHeight,e&&(a=(b-f)*e,this.$el.css("width",a+"px")),f=this.$el.find("figcaption").outerHeight(!0),d.columns=Math.ceil((a+c.gutterWidth)/(c.gutterWidth+c.columnWidth))),a=Math.floor(a),b=Math.floor(b),this.$el.css({height:b+"px",width:a+"px"}),this.calculatedHeight=b,this.calculatedWidth=a,this.model.set("calculatedColumns",d.columns),this.$el.find(".figure_content").css({width:a,height:b-f}),this.sizeCalculated=!0,this}}),OsciTk.views.figureTypeRegistry.image_asset="MultiColumnFigureImage",OsciTk.views.MultiColumnFigureImage=OsciTk.views.MultiColumnFigure.extend({renderContent:function(){var a=this.$el.find(".figure_content"),b=a.height(),c=a.width();a.html(this.model.get("content")),a.children("img").css({height:b+"px",width:c+"px"}),this.contentRendered=!0},fullscreen:function(){this.contentRendered||this.renderContent(),$.fancybox.open({href:this.$el.find("img").attr("src"),title:this.model.get("caption"),helpers:{title:{type:"inside"}}})}}),OsciTk.views.figureTypeRegistry.layered_image="MultiColumnFigureLayeredImage",OsciTk.views.figureTypeRegistry.iip_asset="MultiColumnFigureLayeredImage",OsciTk.views.MultiColumnFigureLayeredImage=OsciTk.views.MultiColumnFigure.extend({events:{},renderContent:function(a){this.figContent=this.figContent||null;{var b=this.$el.find(".figure_content");b.height(),b.width()}if(this.jsonOptions=JSON.stringify(this.model.get("options")),this.$el.attr("data-options",this.jsonOptions),null!==this.figContent)this.renderFromContentDoc();else{var c=$(this.model.get("content")),d=c.attr("data");if(void 0!==d){var e=this;$.ajax({url:d,type:"GET",dataType:"html",success:function(b){e.figContent=$(b).filter(".layered_image-asset").first(),e.LIMarkup=e.figContent.clone(),e.renderFromContentDoc(),void 0!==a&&a(e)}})}}},renderFromContentDoc:function(){var a=this.$el.find(".figure_content");a.empty(),a.html(this.figContent),new window.LayeredImage(a.find(".layered_image-asset")[0]),this.contentRendered=!0},fullscreen:function(a){if(void 0===a&&(a=this),a.contentRendered){var b=liCollection.find(a.LIMarkup.attr("id"));b.fullscreen()}else a.renderContent(a.fullscreen)}}),OsciTk.views.Title=OsciTk.views.BaseView.extend({className:"title-view",template:OsciTk.templateManager.get("title"),initialize:function(){this.listenTo(Backbone,"packageLoaded",function(a){var b=a.getTitle();b&&this.$el.find("#publication-title").text(b)}),this.render()},render:function(){return this.$el.html(this.template()),this},events:{"click #publication-title":function(a){a.preventDefault(),Backbone.trigger("navigate",{identifier:"start"})}}}),OsciTk.views.Toolbar=OsciTk.views.BaseView.extend({id:"toolbar",className:"toolbar-closed",template:OsciTk.templateManager.get("toolbar"),initialize:function(){this.toolbarItems=app.config.get("toolbarItems")?app.config.get("toolbarItems"):[],this.isContentOpen=!1,this.activeToolbarItemView=void 0,this.activeToolbarItemViewChanged=!1,this.render(),this.listenTo(Backbone,"packageLoaded",function(a){var b=a.getTitle();b&&this.$el.find("#toolbar-title").text(b)}),$(window).on("click",{view:this},function(a){var b=$(a.target).parents("#"+a.data.view.id);a.data.view.isContentOpen&&0===b.length&&a.data.view.contentClose()})},events:{"click #toolbar-close":"contentClose"},render:function(){this.$el.html(this.template()),_.each(this.toolbarItems,function(a){var b=new OsciTk.views.ToolbarItem({toolbarItem:a});this.addView(b,"#toolbar-handle"),b.render()},this)},setActiveToolbarItemView:function(a){return this.activeToolbarItemView&&a.cid!==this.activeToolbarItemView.cid||void 0===this.activeToolbarItemView?(this.activeToolbarItemViewChanged=!0,this.activeToolbarItemView&&this.activeToolbarItemView.contentView.$el.detach()):this.activeToolbarItemViewChanged=!1,this.activeToolbarItemView=a,this.$el.find("#toolbar-content").html(a.contentView.$el),a.contentView.delegateEvents(),this},toggleContentView:function(){return this.isContentOpen?this.activeToolbarItemViewChanged?(this.updateHeight(),this):(this.contentClose(),this):(this.contentOpen(),this)},contentOpen:function(){this.updateHeight(),this.$el.removeClass("toolbar-closed").addClass("toolbar-open"),this.isContentOpen=!0},updateHeight:function(){this.$el.find("#toolbar-content").height("");var a=this.$el.height(),b=this.$el.find("#toolbar-content").outerHeight(),c=$("#toolbar-title-container").outerHeight();this.$el.find("#toolbar-content").height(b>a-c?a-c+"px":""),this.$el.css({top:0})},contentClose:function(){this.$el.css({top:"-"+this.$el.height()+"px"}),this.$el.removeClass("toolbar-open").addClass("toolbar-closed"),this.isContentOpen=!1}}),OsciTk.views.ToolbarItem=OsciTk.views.BaseView.extend({className:"toolbar-item",template:OsciTk.templateManager.get("toolbar-item"),initialize:function(a){this.options=a,this.$el.addClass(this.options.toolbarItem.view+"-toolbar-item"),this.contentView=null,this.contentViewRendered=!1},events:{click:"itemClicked",touch:"itemClicked"},onClose:function(){this.contentView.close()},render:function(){this.contentView=new OsciTk.views[this.options.toolbarItem.view]({parent:this}),this.$el.html(this.template({text:this.options.toolbarItem.text}))},itemClicked:function(a){a.preventDefault(),a.stopPropagation(),this.contentViewRendered||(this.contentView.render(),this.contentViewRendered=!0),this.parent.setActiveToolbarItemView(this),this.parent.toggleContentView(),this.contentView.active&&this.contentView.active()}}),OsciTk.views.Navigation=OsciTk.views.BaseView.extend({id:"navigation",template:OsciTk.templateManager.get("navigation"),initialize:function(){this.numPages=null,this.identifier=null,this.currentNavigationItem=null,this.page=null,this.listenTo(Backbone,"layoutComplete",function(a){this.identifier?(Backbone.trigger("navigate",{identifier:this.identifier}),this.identifier=null):Backbone.trigger("navigate",{page:1}),this.numPages=a.numPages,this.render()}),this.listenTo(Backbone,"pageChanged",function(a){this.page=a.page,this.update(a.page)}),this.listenTo(Backbone,"routedToSection",function(a){if(this.identifier=a.identifier,a.section_id)this.setCurrentNavigationItem(a.section_id);else{var b=app.collections.navigationItems.at(0).id;this.setCurrentNavigationItem(b),app.router.navigate("section/"+b,{trigger:!1})}var c=app.models.docPackage.getTitle();c=c?c+" | ":"",c+=this.getCurrentNavigationItem().get("title"),document.title=c}),$(document).keydown(function(a){var b;switch(a.which){case 39:if(b=app.views.navigationView.page+1,b>app.views.navigationView.numPages){var c=app.views.navigationView.currentNavigationItem.get("next");c&&app.router.navigate("section/"+c.id,{trigger:!0})}else Backbone.trigger("navigate",{page:b});break;case 37:if(b=app.views.navigationView.page-1,1>b){var d=app.views.navigationView.currentNavigationItem.get("previous");d&&app.router.navigate("section/"+d.id+"/end",{trigger:!0})}else Backbone.trigger("navigate",{page:b})}})},render:function(){this.$el.html(this.template({numPages:this.numPages,chapter:this.currentNavigationItem.get("title")})),1==this.numPages?$(".pager").hide():$(".pager").show();var a=100/this.numPages;$(".pager .head",this.$el).css("width",a+"%"),$(".pager").mousedown(function(a){var b=parseInt(app.views.navigationView.numPages*a.offsetX/$(this).width(),10);Backbone.trigger("navigate",{page:b+1})}),this.update(this.page)},getCurrentNavigationItem:function(){return this.currentNavigationItem},setCurrentNavigationItem:function(a){var b=app.collections.navigationItems.get(a);this.currentNavigationItem=b?app.collections.navigationItems.get(a):app.collections.navigationItems.first(),Backbone.trigger("currentNavigationItemChanged",this.currentNavigationItem)},update:function(a){var b=100/this.numPages;if($(".pager .head",this.$el).css("left",b*(a-1)+"%"),this.$el.find(".prev-page").unbind("click"),this.$el.find(".next-page").unbind("click"),1==a){var c=this.currentNavigationItem.get("previous");c?(this.$el.find(".prev-page .label").html("Previous Section"),this.$el.find(".prev-page").removeClass("inactive").click(function(){app.router.navigate("section/"+c.id+"/end",{trigger:!0})})):$(".prev-page",this.$el).addClass("inactive").unbind("click")}else if(this.numPages>1){var d=this;this.$el.find(".prev-page .label").html("Previous"),this.$el.find(".prev-page").removeClass("inactive").click(function(){app.router.navigate("section/"+d.currentNavigationItem.id),Backbone.trigger("navigate",{page:a-1})})}if(a==this.numPages){var e=this.currentNavigationItem.get("next");e?(this.$el.find(".next-page .label").html("Next Section"),this.$el.find(".next-page").removeClass("inactive").click(function(){app.router.navigate("section/"+e.id,{trigger:!0})})):this.$el.find(".next-page").addClass("inactive").unbind("click")}else this.numPages>1&&(this.$el.find(".next-page .label").html("Next"),this.$el.find(".next-page").removeClass("inactive").click(function(){Backbone.trigger("navigate",{page:a+1})}))}}),OsciTk.views.Search=OsciTk.views.BaseView.extend({className:"search-view",template:OsciTk.templateManager.get("search"),initialize:function(){this.query={page:0,keyword:null,filters:[],sort:"score"},this.response={numFound:0,docs:new OsciTk.collections.SearchResults,facets:null},this.results=null,this.hasSearched=!1,this.isLoading=!1,this.resultsTemplate=OsciTk.templateManager.get("search-results")},events:{"submit #search-form":"submitSearch","click #search-submit":"submitSearch","click .search-result":"gotoResult","click .facet":"addFacet","click .filter":"addFilter","change .search-filters":"addFilter","click #reset-search":"resetSearch","click .sort-button":"addSort"},render:function(){this.$el.html(this.template(this))},renderResults:function(){this.prepareResults(),this.$el.find("#search-results-container").html(this.resultsTemplate(this))},prepareResults:function(){this.results=_.groupBy(this.response.docs.models,function(a){return a.get("ss_section_id")})},search:function(){var a=this;this.query.keyword=this.$el.find("#search-keyword").val(),this.response.docs.reset(),this.hasSearched=!0;var b={key:this.query.keyword,group:"true",page:this.query.page,sort:this.query.sort},c="pid:"+app.models.docPackage.get("id");-1===_.indexOf(this.query.filters,c)&&this.query.filters.push(c),this.query.filters.length&&(b.filters=this.query.filters.join(" ")),$.ajax({url:app.config.get("endpoints").OsciTkSearch,data:b,success:function(b){b=JSON.parse(b),a.response.docs.reset(b.docs),a.response.facets=b.facets,a.response.numFound=b.numFound,a.renderResults(),a.resizeContainers()},error:function(){}})},gotoResult:function(a){var b=$(a.currentTarget),c=this.response.docs.get(b.data("id"));app.router.navigate("section/"+c.get("ss_section_id")+"/"+c.get("id"),{trigger:!0}),app.views.toolbarView.contentClose()},addSort:function(a){a.preventDefault();var b=$(a.currentTarget).data("sort"),c=b===this.query.sort;this.$el.find(".sort-button").removeClass("active"),c||(this.query.sort=b),this.hasSearched&&this.search(),this.$el.find(a.currentTarget).addClass("active")},addFilter:function(a){a.preventDefault();var b;b="change"===a.type?$(a.currentTarget).val():$(a.currentTarget).data("filter");var c=_.indexOf(this.query.filters,b);this.$el.find(".filter").removeClass("active"),this.query.filters=_.reject(this.query.filters,function(a){return 0===a.indexOf("type:")}),-1===c&&(this.query.filters.push(b),$(a.currentTarget).addClass("active")),this.hasSearched&&this.search()},addFacet:function(a){a.preventDefault();var b=$(a.currentTarget).data("filter");this.query.filters.push(b),this.hasSearched&&this.search()},submitSearch:function(a){a.preventDefault(),this.search()},resetSearch:function(a){a.preventDefault(),a.stopPropagation(),this.initialize(),this.$el.find("#search-results-header").remove(),this.$el.find("#search-results-column-wrapper").remove(),this.$el.find("#search-keyword").val(""),this.resizeContainers()},resizeContainers:function(){this.$el.find("#search-container").height(""),app.views.toolbarView.contentOpen();var a=$("#toolbar-content").height(),b=this.$el.find("h3").outerHeight(!0),c=a-b,d=$("#toolbar").height(),e=$("#toolbar-title-container").outerHeight(),f=$("#toolbar-handle").height();c>d&&(c=d-e-b-f),this.$el.find("#search-container").height(c);var g=this.$el.find("#search-form").outerHeight(!0),h=this.$el.find("#search-results-header").outerHeight(!0);this.$el.find("#search-results-column-wrapper").height(c-g-h);var i=$("#facet-by-section").find(".section-title").outerHeight(!0);this.$el.find("#facet-sections-container").height(c-g-h-i)}}),OsciTk.views.Notes=OsciTk.views.BaseView.extend({className:"notes-view",template:OsciTk.templateManager.get("notes"),initialize:function(){this.listenTo(app.collections.notes,"add remove change",function(){this.render()}),this.listenTo(Backbone,"pageChanged notesLoaded",function(a){var b;b="undefined"==typeof a.page?app.views.navigationView.page:a.page,pageView=app.views.sectionView.getChildViewByIndex(b-1),_.each(app.collections.notes.models,function(a){a.set("onCurrentPage",!1);var b=pageView.$el.find("#"+a.get("content_id"));b.length>0&&a.set("onCurrentPage",!0)}),this.render()})},events:{"click .noteLink":"noteLinkClick"},noteLinkClick:function(a){a.preventDefault();var b=$(a.target),c=b.attr("data-content_id");c&&(Backbone.trigger("navigate",{identifier:c}),Backbone.trigger("toggleNoteDialog",{contentId:c}),$("#"+c).click(),app.views.toolbarView.contentClose())},render:function(){var a=this.getSavedNotes();return this.$el.html(this.template({notes:a})),this.active(),this},getSavedNotes:function(){var a=_.filter(app.collections.notes.models,function(a){return null!==a.id?!0:!1});return a},active:function(){if(app.collections.notes.length>1){var a=this.$el.find(".notesListItem");this.$el.find(".notesList").width(a.length*a.first().outerWidth(!0))}}}),OsciTk.views.InlineNotes=OsciTk.views.BaseView.extend({template:OsciTk.templateManager.get("note-popup"),initialize:function(){this.listenTo(Backbone,"toggleNoteDialog",function(a){this.render(a)}),this.listenTo(Backbone,"notesLoaded",function(){_.each(app.collections.notes.models,function(a){var b=app.views.sectionView.$el.find(".paragraph-controls[data-osci_content_id="+a.get("content_id")+"]");b.length&&b.addClass("notes-present")})})},render:function(a){if(0==parseInt(app.account.id,10))return void alert("You must login to create notes.");var b=this,c=a.contentId,d=$("#"+c);if(c){var e,f=app.collections.notes.where({content_id:c});f[0]?e=f[0]:(e=new OsciTk.models.Note({content_id:c,section_id:app.models.section.id,paragraph_number:a.paragraphNumber}),app.collections.notes.add(e));var g=e.toJSON();g.referenceContent=d.text(),$.fancybox({padding:0,content:b.template(g),type:"inline",titleShow:!1,beforeClose:function(){var a=$(".note-popup").find("textarea").val();if(a.length>0){var b=app.views.sectionView.getCurrentPageView(),d=b.$el.find(".paragraph-controls[data-osci_content_id="+c+"]");d.addClass("notes-present")}}});var h=$(".note-popup");h.attr("id",e.cid),h.find("textarea, input").on("keyup",function(){h.find(".status").text("Saving...");for(var a=h.attr("id").match(/c\d+/)[0],c=app.collections.notes.get(a),d=h.find("textarea").val(),e=h.find("input").val().split(","),f=[],g=0,i=e.length;i>g;g++)f.push($.trim(e[g]));c.set("note",d),c.set("tags",f),"undefined"!=typeof b["saveTimeout"+a]&&(clearTimeout(b["saveTimeout"+a]),delete b["saveTimeout"+a]),b["saveTimeout"+a]=window.setTimeout(function(){c.save(),h.find(".status").text("Saved")},1500)})}}}),OsciTk.views.Citation=OsciTk.views.BaseView.extend({template:OsciTk.templateManager.get("citation"),initialize:function(){this.listenTo(Backbone,"toggleCiteDialog",function(a){this.render(a)})},render:function(a){var b=this,c=a.contentId,d=$("#"+c),e={section_id:app.models.section.get("id"),publication_id:app.models.docPackage.get("id"),element_id:a.contentId,field:d.attr("data-sectionId")};$.ajax({url:app.config.get("endpoints").OsciTkCitation,data:e,success:function(a){a.success&&(a.citation.referenceText=d.text(),a.citation.url=document.URL+"/p-"+app.models.section.get("id")+"-"+d.data("paragraph_number"),a.citation.paragraphNumber=d.data("paragraph_number"),a.citation.date=new Date(a.citation.date),a.citation.formattedDate=a.citation.date.getMonth()+1+"/"+a.citation.date.getDate()+"/"+a.citation.date.getFullYear(),a.citation.creator=a.citation.creator?a.citation.creator:"",a.citation.description=a.citation.description?a.citation.description:"",a.citation.editor=a.citation.editor?a.citation.editor:"",a.citation.publicationTitle=a.citation.publicationTitle?a.citation.publicationTitle:"",a.citation.publisher=a.citation.publisher?a.citation.publisher:"",a.citation.rights=a.citation.rights?a.citation.rights:"",a.citation.title=a.citation.title?a.citation.title:"",$.fancybox({padding:0,content:b.template(a.citation),type:"inline",titleShow:!1}),$(".citation-wrapper").on("click","a",function(a){a.preventDefault();var b=$(this),c=b.parents(".citations");c.find(".citation").hide(),c.find(b.attr("href")).show(),c.find("li").removeClass("active"),b.parent().addClass("active")}))}})}}),OsciTk.views.Footnotes=OsciTk.views.BaseView.extend({id:"footnote",initialize:function(){this.listenTo(Backbone,"layoutComplete",function(){var a=app.views.sectionView.$el.find("a.footnote-reference");_.each(a,function(a){a=$(a);var b=a.attr("href").slice(1),c=app.collections.footnotes.get(b);c&&a.qtip({content:c.get("body"),style:{def:!1},position:{viewport:$(window)}})});for(var b=0;b<a.length;b++){var c=$(a[b]);c.off("click"),c.bind("click",{caller:this},this.footnoteClicked)}})},footnoteClicked:function(a){a.preventDefault(),a.stopPropagation()}}),OsciTk.views.Figures=OsciTk.views.BaseView.extend({className:"figures-view",template:OsciTk.templateManager.get("figures"),initialize:function(){this.listenTo(app.collections.figures,"add remove reset",function(){this.render()})},events:{"click .figure-preview":"onFigurePreviewClicked","click a.view-fullscreen":"onFigurePreviewClicked","click a.view-in-context":"onViewInContextClicked","click figure.thumbnail":"onThumbnailClick","click .back-to-grid":"backToGridClick","click .figure-nav.next":"figureNextClick","click .figure-nav.prev":"figurePrevClick"},figureNextClick:function(){var a=this.$el.find("figure.preview.active").hide().removeClass("active").next("figure.preview");0===a.length&&(a=this.$el.find("figure.preview").first()),a.show().addClass("active"),this.displayTitle()},figurePrevClick:function(){var a=this.$el.find("figure.preview.active").hide().removeClass("active").prev("figure.preview");0===a.length&&(a=this.$el.find("figure.preview").last()),a.show().addClass("active"),this.displayTitle()},backToGridClick:function(){this.$el.find(".figure-previews").hide(),this.$el.find(".figure-browser").show(),this.active(),app.views.toolbarView.updateHeight()},onThumbnailClick:function(a){this.$el.find(".figure-browser").hide(),this.$el.find(".figure-previews figure.active").hide().removeClass("active");var b=this.$el.find("figure.preview[data-figure-id='"+$(a.currentTarget).attr("data-figure-id")+"']");b.show().addClass("active"),this.displayTitle(),this.$el.find(".figure-previews").show(),app.views.toolbarView.updateHeight()},onFigurePreviewClicked:function(a){var b=$(a.target).parent("figure").attr("data-figure-id"),c=app.views.figures[b];return c&&c.fullscreen&&c.fullscreen(),!1},onViewInContextClicked:function(a){return Backbone.trigger("navigate",{identifier:$(a.target).parent("figure").attr("data-figure-id")}),app.views.toolbarView.contentClose(),!1},active:function(){if(app.collections.figures.length>1){var a=this.$el.find("figure.thumbnail");this.$el.find(".figure-browser .figure-reel").width(a.length*a.outerWidth(!0))}},render:function(){var a=app.collections.figures.toJSON();return this.$el.html(this.template({figures:a})),this},displayTitle:function(){var a=this.$el.find("figure.preview.active").attr("data-figure-id"),b=app.collections.figures.get(a);this.$el.find("h2 span.title").html(b.get("title"))}}),OsciTk.views.Glossary=OsciTk.views.BaseView.extend({id:"glossary-view",className:"toolbar-item-view",template:OsciTk.templateManager.get("glossary"),events:{"keyup #glossary-filter":"filterTerms","click #glossary-filter-clear":"clearFilter","click #glossary-term-listing li":"selectTerm","click #glossary-term-listing-mobile li":"expandTerm"},render:function(){var a=this;this.$el.html(this.template({hasResults:!_.isEmpty(app.collections.glossaryTerms.models)})),_.each(app.collections.glossaryTerms.models,function(b){var c=OsciTk.templateManager.get("glossary-term");a.$el.find("#glossary-term-listing").append(c({item:b}));var d=OsciTk.templateManager.get("glossary-term-mobile");a.$el.find("#glossary-term-listing-mobile").append(d({item:b}))})},filterTerms:function(){var a=this,b=$("#glossary-filter").val();b.length?$("#glossary-filter-clear").show():$("#glossary-filter-clear").hide();var c;c=_.isEmpty(b)?app.collections.glossaryTerms.models:app.collections.glossaryTerms.filterByKeyword(b),$("#glossary-term-listing").empty(),$("#glossary-term-listing-mobile").empty(),_.each(c,function(b){var c=OsciTk.templateManager.get("glossary-term");a.$el.find("#glossary-term-listing").append(c({item:b}));var d=OsciTk.templateManager.get("glossary-term-mobile");a.$el.find("#glossary-term-listing-mobile").append(d({item:b}))})},clearFilter:function(){$("#glossary-filter").val(""),this.filterTerms()},selectTerm:function(a){var b=$(a.target).data("tid"),c=app.collections.glossaryTerms.get(b);this.$el.find("h4").html(c.get("term")),this.$el.find("p").html(c.get("definition"))},expandTerm:function(a){$(a.target).removeClass("active-term"),$(a.target).find("ul").is(":visible")?$(a.target).find("ul").hide():(this.$el.find("#glossary-term-listing-mobile ul").hide(),$(a.target).find("ul").show(),$(a.target).addClass("active-term"))}}),OsciTk.views.GlossaryTooltip=OsciTk.views.BaseView.extend({initialize:function(){this.listenTo(Backbone,"layoutComplete",function(){0!==app.collections.glossaryTerms.length&&$(".glossary-term").qtip({content:{title:" ",text:" "},position:{viewport:$(window)},style:{classes:"glossary-tooltip",def:!1,width:app.views.sectionView.dimensions.columnWidth+"px"},events:{show:function(a,b){var c=$(a.originalEvent.target).data("tid"),d=app.collections.glossaryTerms.get(c);b.set("content.title",d.get("term")),b.set("content.text",d.get("definition"))}}}).click(function(a){a.preventDefault(),a.stopPropagation()})}),this.listenTo(Backbone,"routedToSection",function(){$(".glossary-tooltip").qtip("destroy")})}}),OsciTk.views.Toc=OsciTk.views.BaseView.extend({className:"toc-view",template:OsciTk.templateManager.get("toc"),events:{"click li a":"itemClick"},initialize:function(a){this.parent=a.parent,this.listenTo(Backbone,"currentNavigationItemChanged",function(){this.render()})},render:function(){this.$el.html(this.template({items:app.collections.navigationItems.where({depth:0})}))},itemClick:function(a){a.preventDefault();var b=$(a.currentTarget).attr("data-section-id");app.router.navigate("section/"+b,{trigger:!0}),app.views.toolbarView.contentClose()},active:function(){var a=$("#toolbar-content").height(),b=this.$el.find("h3").outerHeight(),c=a-b;this.$el.find("ul").height(c)}}),OsciTk.views.Account=OsciTk.views.BaseView.extend({className:"account-view",template:null,initialize:function(){this.model=app.account},render:function(){this.model.get("id")>0?this.showProfile():this.showLoginForm()},events:{"click button.login":"login","click button.register":"register","click a.register":"showRegistrationForm","click a.login":"showLoginForm","click a.logout":"logout"},login:function(){var a=this,b=this.$el.find("#username").val(),c=this.$el.find("#password").val();$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"login",username:b,password:c},type:"POST",dataType:"json",success:function(b){b.success===!0?(a.model.set(b.user),a.showProfile()):a.$el.find("div.form-error").html(b.error)}})},logout:function(){var a=this;$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"logout"},type:"POST",dataType:"json",success:function(b){a.model.set(b.user),a.showLoginForm()}})},register:function(){var a=this,b=this.$el.find("#username").val(),c=this.$el.find("#password").val(),d=this.$el.find("#email").val();$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"register",username:b,password:c,email:d},type:"POST",dataType:"json",success:function(b){b.success===!0?(a.model.set(b.user),a.showProfile()):a.$el.find("div.form-error").html(b.error)}})},showRegistrationForm:function(){this.template=OsciTk.templateManager.get("account-register"),this.$el.html(this.template())},showLoginForm:function(){this.template=OsciTk.templateManager.get("account-login"),this.$el.html(this.template())},showProfile:function(){this.template=OsciTk.templateManager.get("account-profile"),this.$el.html(this.template(this.model.toJSON()))}}),OsciTk.views.Font=OsciTk.views.BaseView.extend({className:"font-view",template:OsciTk.templateManager.get("font"),initialize:function(){this.currentFontSize=100,this.render()},render:function(){return this.$el.html(this.template()),this},events:{"click .font-button":"changeFontSize","click .theme-button":"changeTheme"},changeFontSize:function(a){a.preventDefault();var b=app.views.sectionView,c=$(a.target);"#font-larger"===c.attr("href")?this.currentFontSize+=25:this.currentFontSize-=25,b.$el.css({"font-size":this.currentFontSize+"%"}),Backbone.trigger("windowResized")},changeTheme:function(a){a.preventDefault();var b=$(a.target),c=b.attr("href").substr(1),d=$("body");d.removeClass("normal sepia night"),d.addClass(c)}}),OsciTk.views.ParagraphControlsView=OsciTk.views.BaseView.extend({className:"paragraph-controls",initialize:function(a){this.options=a,this.options.paragraphNumber=this.options.content.data("paragraph_number"),this.options.contentIdentifier=this.options.content.data("osci_content_id"),this.options.linkItems=app.config.get("paragraphControls"),this.options.linkItems&&(this.render(),this.listenTo(Backbone,"paragraphClicked",function(a){var b=a.paragraphNumber;if(this.options.paragraphNumber===b){var c=this.$el.qtip("api");c.rendered===!1?c.show():c.toggle()}}))},events:{"click a":"clicked"},clicked:function(a){a.preventDefault();var b=$(a.target).data("event");Backbone.trigger(b,{contentId:this.options.contentIdentifier,paragraphNumber:this.options.paragraphNumber})},render:function(){this.options.content.position();this.$el.attr("data-osci_content_id",this.options.contentIdentifier),this.$el.attr("data-paragraph_identifier",this.options.paragraphNumber),this.$el.html('<span class="paragraph-identifier paragraph-identifier-'+this.options.paragraphNumber+'">'+this.options.paragraphNumber+"</span>"),this.$el.css(this.options.position),this.$el.data("qtip")&&this.$el.qtip("destroy","true");var a="";for(var b in this.options.linkItems){var c=this.options.linkItems[b];a+='<a href="'+b+'" data-event="'+b+'" class="'+b+'">'+c+"</a> "}return this.$el.qtip({position:{my:"left center",at:"right center",target:this.$el,container:this.$el,adjust:{y:-10}},show:{event:"click",ready:!1,solo:!0},hide:{event:"unfocus click",fixed:!0,delay:500},style:{def:!1},overwrite:!1,content:a}),this}}),app={router:void 0,config:void 0,views:{},models:{},collections:{},bootstrap:function(a){this.config=new OsciTk.models.Config(a),this.router=new OsciTk.router,this.features=this.config.get("themeFeatures"),this.features.notes&&(this.collections.notes=new OsciTk.collections.Notes),this.features.account&&(this.account=new OsciTk.models.Account),this.collections.figures=new OsciTk.collections.Figures,this.collections.footnotes=new OsciTk.collections.Footnotes,this.collections.navigationItems=new OsciTk.collections.NavigationItems,this.features.glossary&&(this.collections.glossaryTerms=new OsciTk.collections.GlossaryTerms),window.onresize=function(){window.resizeTimer&&clearTimeout(window.resizeTimer);var a=function(){Backbone.trigger("windowResized")};window.resizeTimer=setTimeout(a,200)},this.views.app=new OsciTk.views.App},run:function(){this.models.docPackage=new OsciTk.models.Package({url:this.config.get("packageUrl")}),Backbone.history.start()}},app.zotero=_.extend({init:function(){this.listenTo(Backbone,"packageLoaded",function(a){var b=new Date(a.get("dc:date"));b=b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate();var c=["ctx_ver=Z39.88-2004","rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Abook","rft.genre=book","rft.date="+b,"rfr_id="+a.get("dc:identifier"),"rft.btitle="+a.get("dc:title"),"rft.atitle="+a.get("dc:title"),"rft.au="+a.get("dc:creator"),"rft.pub="+a.get("dc:publisher")],d=$("<span></span>");d.addClass("Z3988"),d.attr("title",c.join("&")),d.appendTo($("body"));var e=document.createEvent("HTMLEvents");e.initEvent("ZoteroItemUpdated",!0,!0),document.dispatchEvent(e)})}},Backbone.Events);